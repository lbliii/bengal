
---
title: "pygments_patch"
type: "python-module"
source_file: "bengal/rendering/parsers/pygments_patch.py"
line_number: 1
description: "Pygments performance patch for python-markdown. This module provides a process-wide performance optimization that replaces Pygments\' lexer lookup functions with cached versions. This avoids expensive ..."
---

# pygments_patch
**Type:** Module
**Source:** [View source](bengal/rendering/parsers/pygments_patch.py#L1)



**Navigation:**
[bengal](/api/bengal/) ›[rendering](/api/bengal/rendering/) ›[parsers](/api/bengal/rendering/parsers/) ›pygments_patch

Pygments performance patch for python-markdown.

This module provides a process-wide performance optimization that replaces
Pygments' lexer lookup functions with cached versions. This avoids expensive
plugin discovery on every code block during markdown rendering.

Performance Impact (826-page site):
    - Before: 86s (73% in plugin discovery)
    - After: ~29s (3× faster)

Warning:
    This patch affects the global markdown.extensions.codehilite module state.
    It is safe for CLI tools and single-process applications, but may not be
    suitable for multi-tenant web applications.

Usage:
    # One-time application (typical usage):
    PygmentsPatch.apply()

    # Temporary patching (for testing):
    with PygmentsPatch():
        # Patch is active here
        parser.parse(content)
    # Patch is removed here

## Classes




### `PygmentsPatch`


Context manager and utility class for patching Pygments lexer lookups.

This patch replaces expensive Pygments plugin discovery with cached lexer
instances, dramatically improving markdown parsing performance.

The patch is applied at the module level to markdown.extensions.codehilite,
affecting all uses of that module in the current process.



**Attributes:**

:::{div} api-attributes
`_patched`
: Class-level flag indicating if patch is currently active

`_codehilite_module`
: Reference to the patched module (if active)

`_originals`
: Saved original functions for restoration

:::







## Methods



#### `__init__`

:::{div} api-badge-group
:::

```python
def __init__(self) -> None
```


Initialize the patch context manager.



:::{rubric} Returns
:class: rubric-returns
:::


`None`



#### `__enter__`

:::{div} api-badge-group
:::

```python
def __enter__(self) -> PygmentsPatch
```


Apply the patch on context enter.



:::{rubric} Returns
:class: rubric-returns
:::


`PygmentsPatch`



#### `__exit__`

:::{div} api-badge-group
:::

```python
def __exit__(self, *args: Any) -> None
```


Remove the patch on context exit.



:::{rubric} Returns
:class: rubric-returns
:::


`None`



#### `apply`

:::{div} api-badge-group
<span class="api-badge api-badge-classmethod">classmethod</span>:::

```python
def apply(cls) -> bool
```


Apply the Pygments caching patch to markdown.extensions.codehilite.

This method is idempotent - calling it multiple times is safe.



:::{rubric} Returns
:class: rubric-returns
:::


`bool` - bool: True if patch was applied, False if already applied or failed.



#### `restore`

:::{div} api-badge-group
<span class="api-badge api-badge-classmethod">classmethod</span>:::

```python
def restore(cls) -> bool
```


Restore the original Pygments functions.

This removes the patch and restores the original behavior.
Primarily useful for testing.



:::{rubric} Returns
:class: rubric-returns
:::


`bool` - bool: True if patch was restored, False if not currently patched.



#### `is_patched`

:::{div} api-badge-group
<span class="api-badge api-badge-classmethod">classmethod</span>:::

```python
def is_patched(cls) -> bool
```


Check if the patch is currently active.



:::{rubric} Returns
:class: rubric-returns
:::


`bool` - bool: True if patched, False otherwise.



---
*Generated by Bengal autodoc from `bengal/rendering/parsers/pygments_patch.py`*

