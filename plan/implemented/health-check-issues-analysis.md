# Health Check Issues Analysis

**Date**: 2025-01-27  
**Status**: Issues identified and fixes in progress

## Summary

Health check found 3 categories of issues:
1. **295 broken internal links** - Source file references incorrectly flagged
2. **22 directive fence nesting issues** - Directives using 3 backticks containing code blocks
3. **8 pages with directive rendering errors** - Directives failed to render

---

## Issue 1: Broken Internal Links (295 links, 294 pages affected)

### Root Cause

Autodoc-generated markdown files contain source code links like `bengal/analysis/__init__.py#L1` which are **not pages** - they're references to Python source files. The link checker was incorrectly treating these as broken internal page links.

### Pattern

All broken links follow this pattern:
- `bengal/{module}/{file}.py#L{line}`
- Examples: `bengal/analysis/__init__.py#L1`, `bengal/assets/manifest.py#L1`

### Location

These links are generated by the autodoc system in:
- **Template**: `bengal/bengal/autodoc/templates/macros/navigation.md.jinja2` (lines 42-94)
- **Function**: `source_link()` macro generates links when `github_repo` is not configured
- **Output**: All files in `site/content/api/` and `site/content/cli/` contain these links

### Fix Applied

**File**: `bengal/bengal/health/linkcheck/internal_checker.py`

**Change**: Moved source file detection to happen **before** URL parsing, and made it more comprehensive:

```python
# Skip source file references FIRST (before parsing)
if (
    ".py#L" in url  # Python file with line number anchor
    or ".py#" in url  # Python file with any anchor
    or url.endswith(".py")  # Python file without anchor
    or "/bengal/" in url and ".py" in url  # Paths containing bengal/ and .py
    or (url.startswith("../") and ".py" in url)  # Relative paths to .py files
):
    return LinkCheckResult(..., status=LinkStatus.IGNORED, ignore_reason="Source file reference (autodoc)")
```

**Why This Works**: The check now happens before URL parsing, catching all source file patterns regardless of how they're formatted.

### Verification

After fix, these 295 links should be **ignored** (not flagged as broken) because they're legitimate source file references, not page links.

---

## Issue 2: Directive Fence Nesting (22 directives)

### Root Cause

Directives using 3 backticks (```` ```{name} ````) contain code blocks that also use 3 backticks. This creates parsing ambiguity because the parser can't distinguish between the directive fence and the code block fence.

### Pattern

```markdown
```{directive-name}
Content here

```bash  # ← Problem: Same fence length as directive
code here
```

```  # ← Closes code block or directive? Ambiguous!
```

### Fix

Two options:
1. **Use colon syntax** (recommended): Change ` ```{name} ` to `:::{name}`
2. **Increase fence length**: Change ` ```{name} ` to ` ````{name} ` (4+ backticks)

### Affected Files

Based on health check output, issues are in:
- `migrating-content.md` - Lines 38, 73, 104, 134, 160, 211, 221, 237, 245, 254, 270, 292, 307, 322, 350, 361, 376
- `analytics.md` - Line 149 (nested directive 'warning' inside 'tab-item')
- Additional files with similar patterns

### Example Fix

**Before**:
```markdown
```{note}
Here's some code:

```bash
bengal new site mysite
```
```
```

**After** (Option 1 - Colon syntax):
```markdown
:::{note}
Here's some code:

```bash
bengal new site mysite
```
:::
```

**After** (Option 2 - More backticks):
```markdown
````{note}
Here's some code:

```bash
bengal new site mysite
```
````
```

### Recommendation

**Use colon syntax (`:::`) for directives** - it's cleaner, avoids nesting conflicts entirely, and is the recommended approach in Bengal documentation.

---

## Issue 3: Directive Rendering Errors (8 pages)

### Root Cause

Directives failed to render. Common causes:
- Missing closing fence
- Invalid syntax
- Unknown directive type
- Fence nesting conflicts (related to Issue 2)

### Location

- `index.html`: 8 rendering errors

### Next Steps

1. Check `index.html` source markdown file
2. Verify all directives have matching opening/closing fences
3. Ensure directive types are valid
4. Fix fence nesting issues (see Issue 2)

---

## Files Modified

1. ✅ `bengal/bengal/health/linkcheck/internal_checker.py` - Fixed source file link detection
2. ✅ `site/content/docs/guides/migrating-content.md` - Removed stray backticks (line 32)

## Files Needing Manual Fix

1. **Directive fence nesting** (22 instances):
   - `site/content/docs/guides/migrating-content.md` - 17 instances
   - `site/content/docs/guides/analytics.md` - 1+ instances
   - Additional files with similar patterns

2. **Directive rendering errors**:
   - Source file for `index.html` - needs investigation

## Testing

After fixes:
1. Run health check: `bengal health check`
2. Verify broken links count drops from 295 to 0 (for source file refs)
3. Verify directive fence nesting issues are resolved
4. Verify directive rendering errors are fixed

---

## Related Code

- Link checker: `bengal/bengal/health/linkcheck/internal_checker.py`
- Directive validator: `bengal/bengal/health/validators/directives/` (package)
- Autodoc template: `bengal/bengal/autodoc/templates/macros/navigation.md.jinja2`
- Directive syntax validator: `bengal/bengal/rendering/plugins/directives/validator.py`
