# RFC: Code Quality Improvements - Consolidate Duplicates, Reduce Large Files

**Author**: AI Assistant  
**Date**: 2025-12-01  
**Status**: Draft  
**Confidence**: 92% ðŸŸ¢

---

## Executive Summary

**Context**: Codebase analysis identified three categories of code smells beyond the existing large file RFC:
- **3 sets of duplicated functions** across modules
- **7 additional large files** (800+ lines) not covered in existing RFC
- **6 instances of overly broad exception handling**

**Question**: Should we consolidate duplicate code, address additional large files, and improve exception handling patterns?

**Answer**: **Yes** - These improvements reduce maintenance burden, improve debuggability, and align with Bengal's architecture patterns.

**Impact**:
- âœ… Single source of truth for utility functions (DRY principle)
- âœ… Reduced cognitive load for contributors
- âœ… Better error debugging via specific exceptions
- âœ… Consistent codebase patterns
- âš ï¸ Requires import updates across affected files

**Confidence**: 92% (verified duplicates via grep, line counts via wc -l)

---

## 1. Problem Statement

### 1.1 Duplicated Code

Three utility functions exist in multiple locations with identical or near-identical logic:

#### `strip_html` - 3 locations

| File | Lines | Status |
|------|-------|--------|
| `bengal/utils/text.py:101` | 34 | âœ… Canonical (well-documented, full-featured) |
| `bengal/rendering/template_functions/strings.py:166` | 16 | âœ… Wrapper (delegates to utils.text) |
| `bengal/postprocess/output_formats/utils.py:19` | 22 | âŒ **Duplicate** (reimplements same logic) |

**Evidence**:
```python
# bengal/postprocess/output_formats/utils.py:19-40
def strip_html(text: str) -> str:
    if not text:
        return ""
    text = re.sub(r"<[^>]+>", "", text)
    text = html.unescape(text)
    text = re.sub(r"\s+", " ", text)
    return text.strip()

# bengal/utils/text.py:101-134 (canonical)
def strip_html(text: str, decode_entities: bool = True) -> str:
    if not text:
        return ""
    text = re.sub(r"<[^>]+>", "", text)
    if decode_entities:
        text = html_module.unescape(text)
    return text
```

**Issues**:
- Same regex pattern duplicated
- Divergent behavior possible if one is updated without the other
- Violates DRY principle

#### `generate_excerpt` - 2 locations

| File | Implementation | Status |
|------|----------------|--------|
| `bengal/utils/text.py:244` | Word-based truncation | âœ… Canonical |
| `bengal/postprocess/output_formats/utils.py:43` | Character-based truncation | âŒ **Different behavior** |

**Evidence**:
```python
# bengal/postprocess/output_formats/utils.py:43-62
def generate_excerpt(text: str, length: int = 200) -> str:
    # Character-based truncation
    if len(text) <= length:
        return text
    excerpt = text[:length].rsplit(" ", 1)[0]
    return excerpt + "..."

# bengal/utils/text.py:244-269 (canonical)
def generate_excerpt(html: str, word_count: int = 50, suffix: str = "...") -> str:
    # Word-based truncation
    text = strip_html(html, decode_entities=True)
    return truncate_words(text, word_count, suffix)
```

**Issues**:
- Different truncation strategies (characters vs words)
- Different parameter signatures
- Inconsistent excerpts across site

#### `_is_autodoc_page` / `_is_autodoc_file` - 2 locations

| File | Function | Lines |
|------|----------|-------|
| `bengal/analysis/knowledge_graph.py:197` | `_is_autodoc_page` | 26 |
| `bengal/health/validators/directives.py:142` | `_is_autodoc_file` | 40 |

**Evidence**:
```python
# Both check the same patterns:
# - page.metadata.type starts with "python-"
# - page.metadata.type == "cli-reference"
# - page.metadata has "source_file" field
# - page.metadata.generator == "bengal-autodoc"
# - content contains "Generated by Bengal autodoc"
```

**Issues**:
- Nearly identical logic duplicated
- Different function names for same concept
- If autodoc detection criteria change, both must be updated

---

### 1.2 Large Files (Not in Existing RFC)

Beyond `site.py`, `knowledge_graph.py`, and `output_formats.py` (covered in `rfc-large-file-refactoring.md`), these files exceed the 400-line threshold:

| File | Lines | Functions | Mixed Responsibilities |
|------|-------|-----------|------------------------|
| `bengal/health/validators/directives.py` | 1,094 | 18 | Syntax + completeness + performance + rendering validation |
| `bengal/cli/commands/new.py` | 1,088 | 11 | Wizard + presets + config generation + content generation |
| `bengal/rendering/template_functions/navigation.py` | 839 | - | Multiple navigation helpers |
| `bengal/autodoc/extractors/python.py` | 837 | - | AST extraction + docstring parsing |
| `bengal/orchestration/taxonomy.py` | 828 | - | Taxonomy building + page generation |
| `bengal/utils/cli_output.py` | 827 | - | Output formatting + progress + tables |
| `bengal/cache/build_cache.py` | 820 | - | Cache storage + serialization + queries |

**Highest Priority**: `directives.py` (1,094 lines) and `new.py` (1,088 lines)

---

### 1.3 Overly Broad Exception Handling

6 instances of `except Exception:` with silent passes in `bengal/analysis/graph_reporting.py`:

```python
# Lines 196, 226, 290, 314, 405, 436
except Exception:
    pass  # or # Skip if computation fails
```

**Issues**:
- Silent failures make debugging difficult
- No logging of what went wrong
- Should catch specific exception types

---

## 2. Goals & Non-Goals

### Goals

1. **Consolidate duplicate functions** into single canonical locations
2. **Extract shared autodoc detection** to reusable utility
3. **Address two largest files** (`directives.py`, `new.py`) with modular structure
4. **Improve exception handling** with specific types and logging
5. **Maintain backward compatibility** for public APIs

### Non-Goals

- Not refactoring all 800+ line files (scope to top 2)
- Not changing public APIs
- Not optimizing performance (focus on code structure)
- Not adding new features

---

## 3. Design

### 3.1 Consolidate `strip_html` and `generate_excerpt`

**Before**:
```python
# bengal/postprocess/output_formats/utils.py
def strip_html(text: str) -> str:
    # 22 lines of reimplemented logic
    ...

def generate_excerpt(text: str, length: int = 200) -> str:
    # 20 lines of character-based truncation
    ...
```

**After**:
```python
# bengal/postprocess/output_formats/utils.py
from bengal.utils.text import strip_html as _strip_html
from bengal.utils.text import truncate_chars

def strip_html(text: str) -> str:
    """Remove HTML tags from text (delegates to bengal.utils.text)."""
    result = _strip_html(text, decode_entities=True)
    # Normalize whitespace (specific to output_formats)
    return " ".join(result.split())

def generate_excerpt(text: str, length: int = 200) -> str:
    """Generate excerpt (character-based for output formats)."""
    if not text:
        return ""
    text = strip_html(text)
    return truncate_chars(text, length, suffix="...")
```

**Changes**:
- Use canonical `strip_html` from `utils.text`
- Reuse `truncate_chars` for character-based truncation
- Preserve existing behavior (character-based) for backward compatibility
- Add clear docstring delegation notes

---

### 3.2 Extract Autodoc Detection Utility

**Create**: `bengal/utils/autodoc.py`

```python
"""
Utilities for detecting autodoc-generated content.

Used by:
- bengal/analysis/knowledge_graph.py
- bengal/health/validators/directives.py
"""

from __future__ import annotations

from typing import TYPE_CHECKING, Any

if TYPE_CHECKING:
    from bengal.core.page import Page


def is_autodoc_page(page: Page | Any) -> bool:
    """
    Check if a page is autodoc-generated.

    Autodoc pages are identified by:
    - Frontmatter type starting with "python-" (python-module, python-class, etc.)
    - Frontmatter type "cli-reference"
    - Presence of "source_file" in frontmatter
    - Generator metadata "bengal-autodoc"
    - Content containing "Generated by Bengal autodoc"

    Args:
        page: Page object to check

    Returns:
        True if page is autodoc-generated

    Example:
        >>> from bengal.utils.autodoc import is_autodoc_page
        >>> if is_autodoc_page(page):
        ...     # Skip autodoc pages in analysis
        ...     continue
    """
    # Check frontmatter metadata
    metadata = getattr(page, "metadata", None) or getattr(page, "frontmatter", {})
    if isinstance(metadata, dict):
        page_type = metadata.get("type", "")
        if (
            page_type.startswith("python-")
            or page_type == "cli-reference"
            or "source_file" in metadata
            or metadata.get("generator") == "bengal-autodoc"
        ):
            return True

    # Check content for autodoc footer
    content = getattr(page, "content", "")
    if isinstance(content, str):
        if "Generated by Bengal autodoc" in content or "Generated by Bengal" in content:
            return True

    return False
```

**Update call sites**:

```python
# bengal/analysis/knowledge_graph.py
from bengal.utils.autodoc import is_autodoc_page

def _is_autodoc_page(self, page: Page) -> bool:
    """Check if a page is autodoc-generated."""
    if not self.exclude_autodoc:
        return False
    return is_autodoc_page(page)

# bengal/health/validators/directives.py
from bengal.utils.autodoc import is_autodoc_page

def _is_autodoc_file(self, page: Any) -> bool:
    """Check if page is autodoc-generated."""
    return is_autodoc_page(page)
```

---

### 3.3 Refactor `directives.py` (1,094 lines)

**Current structure**:
```
class DirectiveValidator:
    - validate()              # Entry point
    - _analyze_directives()   # Gathering
    - _check_directive_syntax()        # Syntax validation
    - _check_directive_completeness()  # Completeness validation
    - _check_directive_performance()   # Performance warnings
    - _check_directive_rendering()     # Output validation
    # + 12 more helper methods
```

**Proposed structure**:
```
bengal/health/validators/directives/
â”œâ”€â”€ __init__.py              # DirectiveValidator (orchestrator, ~200 lines)
â”‚   â””â”€â”€ class DirectiveValidator:
â”‚       - validate()
â”‚       - _analyze_directives()
â”‚
â”œâ”€â”€ syntax.py                # Syntax validation (~250 lines)
â”‚   â””â”€â”€ class DirectiveSyntaxChecker:
â”‚       - check_syntax()
â”‚       - _validate_fence_structure()
â”‚       - _validate_directive_names()
â”‚
â”œâ”€â”€ completeness.py          # Completeness validation (~250 lines)
â”‚   â””â”€â”€ class DirectiveCompletenessChecker:
â”‚       - check_completeness()
â”‚       - _check_required_options()
â”‚       - _check_tab_markers()
â”‚
â”œâ”€â”€ performance.py           # Performance warnings (~200 lines)
â”‚   â””â”€â”€ class DirectivePerformanceChecker:
â”‚       - check_performance()
â”‚       - _check_nesting_depth()
â”‚       - _check_directive_count()
â”‚
â””â”€â”€ rendering.py             # Output validation (~200 lines)
    â””â”€â”€ class DirectiveRenderingChecker:
        - check_rendering()
        - _validate_output_html()
```

**Public API** (preserved):
```python
# bengal/health/validators/directives/__init__.py
from .syntax import DirectiveSyntaxChecker
from .completeness import DirectiveCompletenessChecker
from .performance import DirectivePerformanceChecker
from .rendering import DirectiveRenderingChecker

class DirectiveValidator(BaseValidator):
    """Validates directive syntax, completeness, and performance."""
    
    def validate(self, site: Site) -> list[CheckResult]:
        results = []
        directive_data = self._analyze_directives(site)
        
        # Delegate to specialized checkers
        results.extend(DirectiveSyntaxChecker(directive_data).check())
        results.extend(DirectiveCompletenessChecker(directive_data).check())
        results.extend(DirectivePerformanceChecker(directive_data).check())
        results.extend(DirectiveRenderingChecker(site, directive_data).check())
        
        return results
```

---

### 3.4 Refactor `new.py` (1,088 lines)

**Current structure**:
```
# Single file with:
- PRESETS dict (60 lines of config data)
- _create_config_directory() (150+ lines)
- _create_content() (100+ lines)
- wizard prompts (200+ lines)
- content templates (inline strings)
```

**Proposed structure**:
```
bengal/cli/commands/new/
â”œâ”€â”€ __init__.py              # CLI commands (entry points, ~150 lines)
â”‚   â””â”€â”€ @new.command() handlers
â”‚
â”œâ”€â”€ presets.py               # Preset definitions (~100 lines)
â”‚   â””â”€â”€ PRESETS = {...}
â”‚
â”œâ”€â”€ wizard.py                # Interactive wizard (~250 lines)
â”‚   â””â”€â”€ class SiteWizard:
â”‚       - run()
â”‚       - _prompt_site_type()
â”‚       - _prompt_theme()
â”‚       - _prompt_features()
â”‚
â”œâ”€â”€ config_generator.py      # Config file generation (~200 lines)
â”‚   â””â”€â”€ class ConfigGenerator:
â”‚       - generate()
â”‚       - _create_site_yaml()
â”‚       - _create_build_yaml()
â”‚
â””â”€â”€ content_generator.py     # Content scaffolding (~250 lines)
    â””â”€â”€ class ContentGenerator:
        - generate()
        - _create_index_page()
        - _create_section_pages()
```

---

### 3.5 Improve Exception Handling

**Current** (`graph_reporting.py`):
```python
try:
    pagerank_results = self._graph.compute_pagerank()
    # ... use results
except Exception:
    pass  # Silent failure
```

**Proposed**:
```python
from bengal.utils.logger import get_logger

logger = get_logger(__name__)

try:
    pagerank_results = self._graph.compute_pagerank()
    # ... use results
except (ValueError, RuntimeError) as e:
    logger.debug(
        "pagerank_computation_skipped",
        error=str(e),
        reason="optional enhancement, continuing without PageRank data"
    )
except Exception as e:
    logger.warning(
        "pagerank_unexpected_error",
        error=str(e),
        error_type=type(e).__name__,
    )
```

**Pattern**: Specific exceptions with debug logging, broad exceptions with warning logging.

---

## 4. Implementation Plan

### Phase 1: Quick Wins (Day 1)

**Task 1.1**: Consolidate `strip_html`/`generate_excerpt` in `output_formats/utils.py`
- Update imports
- Delegate to `bengal.utils.text`
- Run tests

**Task 1.2**: Extract `is_autodoc_page` utility
- Create `bengal/utils/autodoc.py`
- Update `knowledge_graph.py`
- Update `directives.py`
- Run tests

**Task 1.3**: Improve exception handling in `graph_reporting.py`
- Add specific exception types
- Add debug/warning logging
- Run tests

**Success Criteria**:
- [ ] All tests pass
- [ ] No duplicate function implementations
- [ ] Exception handling logs useful information

---

### Phase 2: `directives.py` Refactoring (Days 2-3) âœ… COMPLETED

**Task 2.1**: Create package structure âœ…
**Task 2.2**: Extract `DirectiveSyntaxChecker` â†’ `checkers.py` âœ…
**Task 2.3**: Extract `DirectiveCompletenessChecker` â†’ `checkers.py` âœ…
**Task 2.4**: Extract `DirectivePerformanceChecker` â†’ `checkers.py` âœ…
**Task 2.5**: Extract `DirectiveRenderingChecker` â†’ `checkers.py` âœ…
**Task 2.6**: Update `DirectiveValidator` to orchestrate âœ…
**Task 2.7**: Update tests to use `DirectiveAnalyzer` API âœ…

**Implementation Notes**:
- Created `bengal/health/validators/directives/` package
- `__init__.py` (120 lines) - Public API & orchestrator
- `constants.py` (84 lines) - Known directives, thresholds
- `analysis.py` (515 lines) - DirectiveAnalyzer class
- `checkers.py` (313 lines) - Validation check functions
- Tests updated to use `DirectiveAnalyzer` instead of internal methods

**Success Criteria**:
- [x] `directives/__init__.py` < 300 lines (120 lines)
- [ ] Each checker module < 300 lines
- [ ] All tests pass
- [ ] Public API unchanged

---

### Phase 3: `new.py` Refactoring (Days 4-5)

**Task 3.1**: Create package structure
**Task 3.2**: Extract `presets.py`
**Task 3.3**: Extract `SiteWizard`
**Task 3.4**: Extract `ConfigGenerator`
**Task 3.5**: Extract `ContentGenerator`

**Success Criteria**:
- [ ] `new/__init__.py` < 200 lines
- [ ] Each module < 300 lines
- [ ] All tests pass
- [ ] CLI commands unchanged

---

## 5. Testing Strategy

### Pre-Refactoring

1. Run full test suite: `pytest tests/`
2. Document test coverage for affected modules
3. Run health validators on test site

### During Refactoring

1. Run tests after each extraction step
2. Verify behavior unchanged (no regressions)
3. Check imports resolve correctly

### Post-Refactoring

1. Run full test suite
2. Run integration tests
3. Build test site and verify output
4. Manual smoke testing of `bengal new` wizard

---

## 6. Risks & Mitigations

### Risk 1: Import Breakage

**Risk**: Internal imports change after refactoring
**Mitigation**: 
- Use `__init__.py` re-exports
- Grep for all import sites before refactoring
- Run tests after each change

### Risk 2: Subtle Behavior Changes

**Risk**: Consolidated functions behave slightly differently
**Mitigation**:
- Preserve existing behavior (e.g., character-based excerpts in output_formats)
- Add wrapper functions if needed
- Test with real site builds

### Risk 3: Circular Imports

**Risk**: New utility module creates import cycles
**Mitigation**:
- Keep `utils/autodoc.py` minimal (no heavy imports)
- Use TYPE_CHECKING for type hints
- Test imports in isolation

---

## 7. Success Metrics

| Metric | Before | After | Target |
|--------|--------|-------|--------|
| Duplicate `strip_html` implementations | 2 | 0 | 0 |
| Duplicate `generate_excerpt` implementations | 2 | 0 | 0 |
| Duplicate autodoc detection | 2 | 0 | 0 |
| `directives.py` lines | 1,094 | ~200 | <300 |
| `new.py` lines | 1,088 | ~150 | <200 |
| Silent `except Exception:` passes | 6 | 0 | 0 |

---

## 8. Relationship to Existing RFC

This RFC **complements** `rfc-large-file-refactoring.md`:

| Aspect | Existing RFC | This RFC |
|--------|--------------|----------|
| Focus | `site.py`, `knowledge_graph.py`, `output_formats.py` | `directives.py`, `new.py`, duplicates |
| Status | Phase 1-2 complete, Phase 3 deferred | New |
| Priority | Core modules | Peripheral modules |
| Overlap | None | None |

**Recommendation**: Complete existing RFC Phase 1-2, then execute this RFC.

---

## 9. Open Questions

1. **Should `generate_excerpt` in `output_formats/utils.py` switch to word-based truncation?**
   - Current: Character-based (200 chars)
   - Canonical: Word-based (50 words)
   - Recommendation: Keep character-based for backward compatibility, document difference

2. **Should we consolidate all text utilities into `bengal/utils/text.py`?**
   - Currently ~430 lines
   - Adding more could push it over 500
   - Recommendation: Yes, utilities belong together; split if exceeds 600 lines

3. **Priority of Phase 2 vs Phase 3?**
   - `directives.py` (1,094) vs `new.py` (1,088)
   - Recommendation: `directives.py` first (used in health checks, more critical path)

---

## 10. Decision

**Status**: Draft - Pending Review

**Next Steps**:
1. Review RFC with team
2. Get approval for Phase 1 (quick wins)
3. Execute Phase 1 immediately
4. Schedule Phases 2-3 after Phase 1 validates approach

**Estimated Timeline**:
- Phase 1: 1 day
- Phase 2: 2 days
- Phase 3: 2 days
- **Total**: ~5 days

---

## Appendix: Verification

### Line Count Verification

```bash
$ wc -l bengal/health/validators/directives.py
1094 bengal/health/validators/directives.py

$ wc -l bengal/cli/commands/new.py
1088 bengal/cli/commands/new.py

$ wc -l bengal/postprocess/output_formats/utils.py
259 bengal/postprocess/output_formats/utils.py
```

### Duplicate Detection

```bash
$ grep -n "def strip_html" bengal --include="*.py" -r
bengal/postprocess/output_formats/utils.py:19:def strip_html
bengal/rendering/template_functions/strings.py:166:def strip_html
bengal/utils/text.py:101:def strip_html

$ grep -n "def generate_excerpt" bengal --include="*.py" -r
bengal/postprocess/output_formats/utils.py:43:def generate_excerpt
bengal/utils/text.py:244:def generate_excerpt

$ grep -n "_is_autodoc" bengal --include="*.py" -r
bengal/analysis/knowledge_graph.py:197:    def _is_autodoc_page
bengal/health/validators/directives.py:142:    def _is_autodoc_file
```

---

**Confidence**: 92% ðŸŸ¢

**Rationale**:
- âœ… Duplicates verified via grep (exact matches)
- âœ… Line counts verified via wc -l
- âœ… Exception patterns verified via code review
- âœ… Proposed structure follows proven patterns (`output_formats/` package)
- âœ… Low risk (utility consolidation, no public API changes)

