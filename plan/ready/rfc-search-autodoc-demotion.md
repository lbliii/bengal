# RFC: Search Autodoc Result Demotion

**Author**: AI Assistant  
**Date**: 2025-12-03  
**Status**: ðŸ“‹ Draft  
**Confidence**: 85% ðŸŸ¢
**Priority**: P1 (High)  

---

## Executive Summary

Autodoc-generated pages (API reference, CLI docs) pollute search results when users seek conceptual documentation. This RFC proposes grouping and labeling autodoc results separately from regular documentation, with autodoc results collapsed by default.

**Key Changes**:
- ðŸ·ï¸ Add `isAutodoc: true` flag to search index for autodoc pages
- ðŸ“Š Group search results into "Documentation" and "API Reference" sections
- ðŸ”½ Collapse API Reference section by default with result count badge
- âš™ï¸ Configuration options for customization

---

## 1. Problem Statement

### 1.1 Current Behavior

All search results are displayed in a single flat list, sorted only by Lunr relevance score. Autodoc pages (generated from source code) rank alongside hand-written documentation.

**Evidence**:
- Index generator: `index_generator.py:165-243` - No autodoc flag in output
- Search modal: `search-modal.js:319-351` - Single result type rendering
- Autodoc detection: `bengal/utils/autodoc.py:21-83` - Detection logic exists but unused in search

### 1.2 Pain Points

1. **Pollution**: Searching "page" returns dozens of API results (`Page`, `PageCore`, `PageProxy`) before the conceptual "Page" documentation
2. **No differentiation**: Users can't tell if a result is handwritten docs or generated API reference
3. **Signal loss**: Important conceptual docs get buried under auto-generated noise

### 1.3 User Impact

| User Goal | Current Experience | Desired Experience |
|-----------|-------------------|-------------------|
| Learn about Pages | Wades through API results | Sees "Understanding Pages" first |
| Find `Page.render()` method | Works fine | Still works, in API section |
| Quick navigation | Distracted by irrelevant API hits | Focused results by default |

---

## 2. Goals & Non-Goals

### Goals

1. **Separate autodoc from docs**: Visually distinguish generated API docs from handwritten content
2. **Reduce noise**: Prioritize conceptual documentation in default view
3. **Preserve discoverability**: API docs remain findable when needed
4. **Minimal config**: Work well out of the box with sensible defaults

### Non-Goals

1. **Complete removal**: Not excluding autodoc from search entirely
2. **Complex ranking**: Not building ML-based relevance scoring
3. **Per-page opt-out**: Not supporting granular exclusion (use `search_exclude` for that)

---

## 3. Design

### 3.1 Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Index Generator â”‚â”€â”€â”€â”€â–¶â”‚   index.json     â”‚â”€â”€â”€â”€â–¶â”‚   Search JS     â”‚
â”‚ (Python)        â”‚     â”‚ + isAutodoc flag â”‚     â”‚ + groupResults  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â”‚  Search Modal   â”‚
                                                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                                 â”‚ â”‚Documentationâ”‚ â”‚
                                                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                                 â”‚ â”‚API Ref (23) â”‚ â”‚
                                                 â”‚ â”‚ [collapsed] â”‚ â”‚
                                                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Index Changes

Add `isAutodoc` flag to page summaries using existing detection logic:

```python
# bengal/postprocess/output_formats/index_generator.py

from bengal.utils.autodoc import is_autodoc_page

def page_to_summary(self, page: Page) -> dict[str, Any]:
    # ... existing code ...

    # NEW: Add autodoc flag
    if is_autodoc_page(page):
        summary["isAutodoc"] = True

    return summary
```

**Detection criteria** (from `bengal/utils/autodoc.py`):
- Type: `python-*`, `api-reference`, `cli-reference`
- Metadata: `source_file`, `generator: bengal-autodoc`, `_api_doc`
- Path: Contains `/api/`
- Content: Contains "Generated by Bengal"

### 3.3 Search JS Changes

Update `groupResults()` to create two buckets:

```javascript
// bengal/themes/default/assets/js/search.js

function groupByAutodoc(results) {
  const docs = [];
  const api = [];

  results.forEach(result => {
    if (result.isAutodoc) {
      api.push(result);
    } else {
      docs.push(result);
    }
  });

  return { docs, api };
}
```

### 3.4 Search Modal UI Changes

Render grouped results with collapsible API section:

```javascript
// bengal/themes/default/assets/js/search-modal.js

function displayResults(results, query) {
  const { docs, api } = groupByAutodoc(results);

  // Clear existing
  resultsList.innerHTML = '';

  // Documentation section (always expanded)
  if (docs.length > 0) {
    const docsSection = createResultSection('Documentation', docs, query, false);
    resultsList.appendChild(docsSection);
  }

  // API Reference section (collapsed by default)
  if (api.length > 0) {
    const apiSection = createResultSection(
      `API Reference (${api.length})`,
      api,
      query,
      true  // collapsed
    );
    resultsList.appendChild(apiSection);
  }

  // Empty state handling...
}

function createResultSection(title, items, query, collapsed) {
  const section = document.createElement('div');
  section.className = 'search-modal__result-section';

  // Section header (clickable for API section)
  const header = document.createElement('div');
  header.className = 'search-modal__section-header';
  header.innerHTML = `
    <span class="search-modal__section-title">${title}</span>
    ${collapsed ? '<span class="search-modal__section-toggle">â–¶</span>' : ''}
  `;

  // Items container
  const itemsContainer = document.createElement('div');
  itemsContainer.className = 'search-modal__section-items';
  if (collapsed) {
    itemsContainer.style.display = 'none';
  }

  // Render items
  items.forEach((result, index) => {
    const item = createResultItem(result, index, query);
    // Add badge for autodoc items
    if (result.isAutodoc) {
      const badge = document.createElement('span');
      badge.className = 'search-modal__autodoc-badge';
      badge.textContent = 'API';
      item.querySelector('.search-modal__result-content').appendChild(badge);
    }
    itemsContainer.appendChild(item);
  });

  // Toggle behavior for collapsed sections
  if (collapsed) {
    header.style.cursor = 'pointer';
    header.addEventListener('click', () => {
      const isHidden = itemsContainer.style.display === 'none';
      itemsContainer.style.display = isHidden ? 'block' : 'none';
      header.querySelector('.search-modal__section-toggle').textContent = isHidden ? 'â–¼' : 'â–¶';
    });
  }

  section.appendChild(header);
  section.appendChild(itemsContainer);
  return section;
}
```

### 3.5 CSS Additions

```css
/* themes/default/assets/css/search-modal.css */

.search-modal__result-section {
  margin-bottom: var(--spacing-md);
}

.search-modal__section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.search-modal__section-header[style*="cursor: pointer"]:hover {
  background: var(--bg-tertiary);
}

.search-modal__section-toggle {
  font-size: var(--font-size-xs);
  color: var(--text-muted);
}

.search-modal__autodoc-badge {
  display: inline-flex;
  align-items: center;
  padding: 0 var(--spacing-xs);
  margin-left: var(--spacing-xs);
  font-size: var(--font-size-xs);
  font-weight: 500;
  background: var(--color-info-bg);
  color: var(--color-info);
  border-radius: var(--radius-xs);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
```

### 3.6 Configuration

Add optional configuration in `search.yaml`:

```yaml
# site/config/_default/search.yaml

# Autodoc result handling
autodoc:
  # Group autodoc results separately (default: true)
  group_separately: true

  # Collapse API section by default (default: true)
  collapse_by_default: true

  # Label shown on autodoc results (default: "API")
  badge_label: "API"

  # Section header for autodoc results (default: "API Reference")
  section_title: "API Reference"
```

Pass to JS via meta tag or inline config.

---

## 4. Implementation Plan

### Phase 1: Index Changes (Python)
**Files**: `bengal/postprocess/output_formats/index_generator.py`

1. Import `is_autodoc_page` from utils
2. Add `isAutodoc` flag in `page_to_summary()`
3. Add unit test

**Estimated**: 30 minutes

### Phase 2: Search JS Grouping
**Files**: `bengal/themes/default/assets/js/search.js`

1. Add `groupByAutodoc()` function
2. Export for use by search-modal.js
3. Update full-page search to use grouping

**Estimated**: 45 minutes

### Phase 3: Search Modal UI
**Files**: `bengal/themes/default/assets/js/search-modal.js`, `assets/css/search-modal.css`

1. Update `displayResults()` to use grouped rendering
2. Add `createResultSection()` function
3. Add badge rendering
4. Add CSS for sections and badges

**Estimated**: 1 hour

### Phase 4: Configuration (Optional)
**Files**: `bengal/themes/default/templates/partials/search.html`, config handling

1. Add config schema for autodoc settings
2. Pass settings to JS via meta/inline
3. Make grouping behavior configurable

**Estimated**: 45 minutes

---

## 5. Testing Strategy

### Unit Tests

```python
# tests/unit/postprocess/test_index_generator.py

def test_autodoc_flag_added_for_api_pages():
    """Autodoc pages should have isAutodoc: true in index."""
    page = create_page(metadata={"type": "api-reference"})
    summary = generator.page_to_summary(page)
    assert summary.get("isAutodoc") is True

def test_autodoc_flag_not_added_for_regular_pages():
    """Regular pages should not have isAutodoc flag."""
    page = create_page(metadata={"type": "guide"})
    summary = generator.page_to_summary(page)
    assert "isAutodoc" not in summary
```

### Integration Tests

1. Build site with mixed content (docs + autodoc)
2. Verify `index.json` has correct `isAutodoc` flags
3. Manual test search modal grouping behavior

### Browser Testing

- Verify collapsed section toggle works
- Verify keyboard navigation across sections
- Verify badge styling in light/dark themes

---

## 6. Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Index size increase | Low | Low | Boolean flag adds ~15 bytes per autodoc page |
| Detection false positives | Low | Medium | Detection logic is mature and well-tested |
| Keyboard navigation breaks | Medium | High | Preserve existing nav logic, test thoroughly |
| Users want API results first | Low | Medium | Configuration option to disable grouping |

---

## 7. Success Criteria

- [ ] Searching "page" shows conceptual docs before API reference
- [ ] API results clearly labeled with badge
- [ ] API section shows count and can be expanded
- [ ] Existing search functionality unchanged for sites without autodoc
- [ ] Configuration allows disabling grouping

---

## 8. Future Considerations

1. **Score-based demotion**: Could add optional Lunr field boost reduction for autodoc
2. **Filter UI**: Add "Include API docs" checkbox/toggle
3. **Per-result type badges**: Extend to show `[Guide]`, `[Tutorial]`, `[Reference]`
4. **Pagefind integration**: Ensure pattern works with Pagefind if adopted

---

## 9. Decision Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-12-03 | Group + Label over pure demotion | Transparent UX, user control |
| 2025-12-03 | Collapse by default | Reduce noise while preserving access |
| 2025-12-03 | Use existing `is_autodoc_page()` | DRY, well-tested detection logic |

---

## References

- `bengal/utils/autodoc.py` - Autodoc detection logic
- `bengal/postprocess/output_formats/index_generator.py` - Index generation
- `bengal/themes/default/assets/js/search.js` - Search core
- `bengal/themes/default/assets/js/search-modal.js` - Search modal UI
- `plan/implemented/rfc-search-experience-v2.md` - Previous search improvements
