{#
Bengal OpenAPI Home Page
========================

API landing page showing:
- API title and description
- Version and server information
- Authentication schemes
- Tag/endpoint category overview

Context:
- element: DocElement with OpenAPIOverviewMetadata
- section: Section containing all API pages
- page: Page object
- site: Site instance
- config: Config instance

Kida Features:
- {% with %} for nil-resilient optional sections
- {% spaceless %} for compact badge output
- Optional chaining (?.) and null coalescing (??)
#}
{% extends 'autodoc/openapi/layouts/reference.html' %}

{% let meta = element?.typed_metadata ?? element?.metadata ?? {} %}
{% let api_title = element?.name ?? page?.title ?? 'API Reference' %}
{% let api_version = meta?.version ?? '1.0.0' %}
{% let servers = meta?.servers ?? () %}
{% let security_schemes = meta?.security_schemes ?? {} %}
{% let tags = meta?.tags ?? () %}

{% block header %}
<h1 class="api-home__title">{{ api_title }}</h1>

{% if api_version %}
<div class="api-home__version">
  <span class="badge badge--outline">v{{ api_version }}</span>
</div>
{% end %}

{% with element?.description as desc %}
{% if desc %}
<div class="api-home__description prose">
  {{ desc | markdownify | safe }}
</div>
{% end %}
{% end %}
{% end %}

{% block content_main %}
<div class="api-home" data-autodoc="openapi" data-element="home">
  {# Quick Stats #}
  {% with section?.pages as pages %}
  {% if pages | length > 0 %}
  {% let endpoint_count = pages | length - 1 %}
  {% let tag_count = tags | length %}
  <div class="api-home__stats">
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ endpoint_count }}</span>
      <span class="api-home__stat-label">Endpoints</span>
    </div>
    {% if tag_count > 0 %}
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ tag_count }}</span>
      <span class="api-home__stat-label">Categories</span>
    </div>
    {% end %}
  </div>
  {% end %}
  {% end %}

  {# Base URLs / Servers #}
  {% if servers | length > 0 %}
  <section class="api-home__servers autodoc-section">
    <h2 class="api-home__section-title">{{ icon('server', size=18) }} Base URLs</h2>
    <div class="api-home__server-list">
      {% for server in servers %}
      {% let server_url = server if server is string else server?.url ?? server %}
      {% let server_desc = '' if server is string else server?.description ?? '' %}
      <div class="api-home__server card">
        <code class="api-home__server-url">{{ server_url }}</code>
        {% if server_desc %}
        <span class="api-home__server-desc text-muted">{{ server_desc }}</span>
        {% end %}
        <button class="api-home__server-copy" data-copy="{{ server_url }}" aria-label="Copy URL">
          {{ icon('copy', size=14) }}
        </button>
      </div>
      {% end %}
    </div>
  </section>
  {% end %}

  {# Authentication #}
  {% if security_schemes | length > 0 %}
  <section class="api-home__auth autodoc-section">
    <h2 class="api-home__section-title">{{ icon('lock', size=18) }} Authentication</h2>
    <div class="api-home__auth-schemes">
      {% for name, scheme in security_schemes |> items %}
      {% let scheme_type = scheme?.type ?? 'apiKey' %}
      {% let scheme_desc = scheme?.description ?? '' %}
      {% let scheme_in = scheme['in'] ?? 'header' %}
      {% let scheme_name = scheme?.name ?? 'Authorization' %}

      <div class="api-home__auth-scheme card">
        <header class="api-home__auth-header">
          <h3 class="api-home__auth-name">
            {{ icon('key', size=14) }}
            {{ name }}
          </h3>
          <span class="badge badge--outline badge--sm">{{ scheme_type }}</span>
        </header>

        {% if scheme_desc %}
        <p class="api-home__auth-description">{{ scheme_desc }}</p>
        {% end %}

        {% match scheme_type %}
        {% case 'apiKey' %}
        <code class="api-home__auth-example">{{ scheme_name }}: YOUR_API_KEY</code>
        {% case 'http' %}
        {% if scheme?.scheme == 'bearer' %}
        <code class="api-home__auth-example">Authorization: Bearer YOUR_TOKEN</code>
        {% else %}
        <code class="api-home__auth-example">Authorization: Basic BASE64_CREDENTIALS</code>
        {% end %}
        {% case 'oauth2' %}
        <code class="api-home__auth-example">Authorization: Bearer ACCESS_TOKEN</code>
        {% case _ %}
        <code class="api-home__auth-example">{{ scheme_name }}: YOUR_CREDENTIALS</code>
        {% end %}
      </div>
      {% end %}
    </div>
  </section>
  {% end %}

  {# Endpoint Categories (Tags) #}
  {% if tags | length > 0 %}
  <section class="api-home__tags autodoc-section">
    <h2 class="api-home__section-title">{{ icon('folder', size=18) }} Categories</h2>
    <div class="api-home__tag-grid">
      {% for tag in tags %}
      {% let tag_name = tag if tag is string else tag?.name ?? tag %}
      {% let tag_desc = '' if tag is string else tag?.description ?? '' %}

      <a href="#{{ tag_name | slugify }}" class="api-home__tag-card card card--hoverable">
        <header class="api-home__tag-header">
          <h3 class="api-home__tag-name">{{ tag_name }}</h3>
        </header>
        {% if tag_desc %}
        <p class="api-home__tag-description">{{ tag_desc | truncate(100) }}</p>
        {% end %}
      </a>
      {% end %}
    </div>
  </section>
  {% end %}

  {# All Endpoints (if no tags) #}
  {% if tags | length == 0 %}
  {% with section?.pages as pages %}
  {% if pages | length > 0 %}
  <section class="api-home__endpoints autodoc-section">
    <h2 class="api-home__section-title">{{ icon('list', size=18) }} Endpoints</h2>
    <div class="autodoc-cards">
      {% for ep_page in pages %}
      {% if ep_page != section?.index_page %}
      {% let ep_meta = ep_page?.metadata ?? {} %}
      {% let ep_method = ep_meta?.method ?? 'GET' %}
      {% let ep_path = ep_meta?.path ?? ep_page?.title ?? '' %}
      {% let ep_summary = ep_meta?.summary ?? '' %}
      {% let is_deprecated = ep_meta?.deprecated ?? false %}

      <a href="{{ ep_page?.href ?? '#' }}" class="autodoc-card{% if is_deprecated %} autodoc-card--deprecated{% end %}">
        <div class="autodoc-card-header">
          {% spaceless %}
          <span class="api-method api-method--sm api-method--{{ ep_method |> lower }}">{{ ep_method }}</span>
          {% end %}
          <code class="autodoc-card-name">{{ ep_path }}</code>
        </div>
        {% if ep_summary %}
        <p class="autodoc-card-desc">{{ ep_summary | truncate(80) }}</p>
        {% end %}
        {% if is_deprecated %}
        <span class="autodoc-badge" data-badge="deprecated">Deprecated</span>
        {% end %}
      </a>
      {% end %}
      {% end %}
    </div>
  </section>
  {% end %}
  {% end %}
  {% end %}
</div>
{% end %}
