{#
  Bengal OpenAPI Home Page

  API landing page showing servers, authentication, and endpoint groups.
  This is rendered for the root section of an OpenAPI spec.

  Context:
    - section: Section with metadata containing:
      - version: str | None
      - servers: tuple[str, ...]
      - security_schemes: dict
      - tags: tuple[dict, ...]
      - endpoints: list[DocElement]
      - schemas: list[DocElement]
      - description: str
    - site: Site
    - config: Config
#}
{% extends 'autodoc/openapi/layouts/reference.html' %}

{% let meta = section.metadata %}
{% let version = meta.version ?? null %}
{% let servers = meta.servers ?? () %}
{% let security_schemes = meta.security_schemes ?? {} %}
{% let tags = meta.tags ?? () %}
{% let endpoints = meta.endpoints ?? [] %}
{% let schemas = meta.schemas ?? [] %}

{% block header %}
<header class="api-home-header">
  <div class="api-home-header__content">
    <h1 class="api-home-header__title">{{ section.title }}</h1>

    {% if version %}
    <span class="api-home-header__version badge badge--outline">v{{ version }}</span>
    {% end %}
  </div>

  {% with meta.description as desc %}
    {% if desc %}
    <div class="api-home-header__description prose">
      {{ desc | markdownify | safe }}
    </div>
    {% end %}
  {% end %}
</header>
{% end %}

{% block content %}
<div class="api-home">
  {# Quick Stats #}
  <section class="api-home__stats">
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ endpoints | length }}</span>
      <span class="api-home__stat-label">Endpoints</span>
    </div>
    {% if section.subsections %}
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ section.subsections | length }}</span>
      <span class="api-home__stat-label">Categories</span>
    </div>
    {% end %}
    {% if schemas %}
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ schemas | length }}</span>
      <span class="api-home__stat-label">Schemas</span>
    </div>
    {% end %}
    {% if security_schemes %}
    <div class="api-home__stat">
      <span class="api-home__stat-value">{{ security_schemes | length }}</span>
      <span class="api-home__stat-label">Auth Methods</span>
    </div>
    {% end %}
  </section>

  {# Base URLs / Servers #}
  {% if servers %}
  <section class="api-home__servers">
    <h2 class="api-home__section-title">Base URLs</h2>
    <div class="api-home__server-list">
      {% for server in servers %}
      <div class="api-home__server">
        <code class="api-home__server-url">{{ server }}</code>
        <button
          class="api-home__server-copy"
          type="button"
          data-copy-value="{{ server }}"
          aria-label="Copy URL"
        >
          <svg class="icon" aria-hidden="true" width="14" height="14">
            <use href="#icon-copy"></use>
          </svg>
        </button>
      </div>
      {% end %}
    </div>
  </section>
  {% end %}

  {# Authentication #}
  {% if security_schemes %}
  <section class="api-home__auth">
    <h2 class="api-home__section-title">Authentication</h2>
    <div class="api-home__auth-schemes">
      {% for name, scheme in security_schemes.items() %}
      <div class="api-home__auth-scheme card">
        <div class="api-home__auth-header">
          <h3 class="api-home__auth-name">
            <svg class="icon" aria-hidden="true" width="16" height="16">
              <use href="#icon-lock"></use>
            </svg>
            {{ name }}
          </h3>
          <span class="badge badge--outline badge--sm">{{ scheme.type ?? 'custom' }}</span>
        </div>

        {% with scheme.description as desc %}
          {% if desc %}
          <p class="api-home__auth-description text-muted">{{ desc }}</p>
          {% end %}
        {% end %}

        {% if scheme.type == 'http' %}
          <code class="api-home__auth-example">
            Authorization: {{ scheme.scheme | title }} &lt;token&gt;
          </code>
        {% elif scheme.type == 'apiKey' %}
          <code class="api-home__auth-example">
            {{ scheme.name }}: &lt;api_key&gt;
            <span class="text-muted">({{ scheme['in'] }})</span>
          </code>
        {% end %}
      </div>
      {% end %}
    </div>
  </section>
  {% end %}

  {# Endpoint Groups - use subsections which are the tag sections #}
  <section class="api-home__endpoints">
    <h2 class="api-home__section-title">Endpoints</h2>

    {% if section.subsections %}
    <div class="api-home__tag-grid">
      {% for tag_section in section.subsections %}
        {# Skip the schemas section #}
        {% if tag_section.name != 'schemas' %}
        {% let tag_endpoints = tag_section.metadata.endpoints ?? [] %}
        <a href="{{ tag_section.href }}" class="api-home__tag-card card card--hoverable">
          <div class="api-home__tag-header">
            <h3 class="api-home__tag-name">{{ tag_section.title }}</h3>
            <span class="badge badge--secondary">{{ tag_endpoints | length }}</span>
          </div>
          {% with tag_section.metadata.description as desc %}
            {% if desc %}
            <p class="api-home__tag-description text-muted">{{ desc | truncate(100) }}</p>
            {% end %}
          {% end %}

          {# Preview of methods in this tag #}
          <div class="api-home__tag-methods">
            {% for ep in tag_endpoints[:5] %}
              {% let method = ep.typed_metadata.method if ep.typed_metadata else 'GET' %}
              {% match method %}
                {% case 'GET' %}
                  <span class="api-method api-method--get api-method--xs">GET</span>
                {% case 'POST' %}
                  <span class="api-method api-method--post api-method--xs">POST</span>
                {% case 'PUT' %}
                  <span class="api-method api-method--put api-method--xs">PUT</span>
                {% case 'PATCH' %}
                  <span class="api-method api-method--patch api-method--xs">PATCH</span>
                {% case 'DELETE' %}
                  <span class="api-method api-method--delete api-method--xs">DELETE</span>
                {% case _ %}
                  <span class="api-method api-method--xs">{{ method }}</span>
              {% end %}
            {% end %}
          </div>
        </a>
        {% end %}
      {% end %}
    </div>
    {% elif endpoints %}
    {# No subsections - show all endpoints directly #}
    <div class="api-home__endpoint-list">
      {% for ep in endpoints %}
        {% let ep_meta = ep.typed_metadata %}
        {% let method = ep_meta.method if ep_meta else 'GET' %}
        {% let path = ep_meta.path if ep_meta else ep.name %}
        <a href="{{ ep.href ?? '#' }}" class="api-home__endpoint-item">
          {% match method %}
            {% case 'GET' %}
              <span class="api-method api-method--get api-method--sm">GET</span>
            {% case 'POST' %}
              <span class="api-method api-method--post api-method--sm">POST</span>
            {% case 'PUT' %}
              <span class="api-method api-method--put api-method--sm">PUT</span>
            {% case 'PATCH' %}
              <span class="api-method api-method--patch api-method--sm">PATCH</span>
            {% case 'DELETE' %}
              <span class="api-method api-method--delete api-method--sm">DELETE</span>
            {% case _ %}
              <span class="api-method api-method--sm">{{ method }}</span>
          {% end %}
          <span class="api-home__endpoint-path">{{ path }}</span>
          <span class="api-home__endpoint-summary text-muted">{{ ep_meta.summary ?? '' }}</span>
        </a>
      {% end %}
    </div>
    {% else %}
    <p class="api-home__empty text-muted">No endpoints documented yet.</p>
    {% end %}
  </section>

  {# Schemas Quick Reference #}
  {% if schemas %}
  <section class="api-home__schemas">
    <h2 class="api-home__section-title">Schemas</h2>
    <div class="api-home__schema-grid">
      {% for schema in schemas[:12] %}
      <a href="{{ schema.href ?? (section.href ~ 'schemas/' ~ schema.name ~ '/') }}" class="api-home__schema-card card card--hoverable">
        <code class="api-home__schema-name">{{ schema.name }}</code>
        {% with schema.description as desc %}
          {% if desc %}
          <p class="api-home__schema-description text-muted">{{ desc | truncate(60) }}</p>
          {% end %}
        {% end %}
      </a>
      {% end %}
      {% if schemas | length > 12 %}
      <a href="{{ section.href }}schemas/" class="api-home__schema-more card card--hoverable">
        <span>View all {{ schemas | length }} schemas â†’</span>
      </a>
      {% end %}
    </div>
  </section>
  {% end %}
</div>
{% end %}
