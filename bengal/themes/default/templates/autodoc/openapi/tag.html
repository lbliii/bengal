{#
  Bengal OpenAPI Tag Page

  Shows all endpoints grouped under a specific tag.

  Context:
    - tag_name: str (current tag)
    - tag_info: dict (tag metadata from spec)
    - endpoints: list[DocElement] (endpoints in this tag)
    - all_tags: list[dict] (all available tags)
    - site: Site
    - config: Config
#}
{% extends 'autodoc/openapi/layouts/reference.html' %}

{% let tag_description = tag_info.description ?? '' %}

{% block header %}
<header class="api-tag-header">
  <nav class="api-tag-header__breadcrumb" aria-label="API breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb__item">
        <a href="{{ url_for('autodoc:openapi:home') }}">API</a>
      </li>
      <li class="breadcrumb__item">
        <span aria-current="page">{{ tag_name }}</span>
      </li>
    </ol>
  </nav>

  <h1 class="api-tag-header__title">{{ tag_name }}</h1>

  {% if tag_description %}
  <div class="api-tag-header__description prose">
    {{ tag_description | markdownify | safe }}
  </div>
  {% end %}

  <div class="api-tag-header__meta">
    <span class="badge badge--outline">{{ endpoints | length }} endpoints</span>
  </div>
</header>
{% end %}

{% block content %}
<div class="api-tag">
  {# Method Filter Tabs #}
  <div class="api-tag__filters" role="tablist" aria-label="Filter by method">
    <button
      class="api-tag__filter api-tag__filter--active"
      role="tab"
      aria-selected="true"
      data-filter="all"
    >
      All
      <span class="api-tag__filter-count">{{ endpoints | length }}</span>
    </button>

    {% let methods = endpoints | map(attribute='typed_metadata.method') | unique | list %}
    {% for method in methods %}
      {% let method_count = endpoints | selectattr('typed_metadata.method', 'eq', method) | list | length %}
      <button
        class="api-tag__filter"
        role="tab"
        aria-selected="false"
        data-filter="{{ method | lower }}"
      >
        {% match method %}
          {% case 'GET' %}
            <span class="api-method api-method--get api-method--xs">GET</span>
          {% case 'POST' %}
            <span class="api-method api-method--post api-method--xs">POST</span>
          {% case 'PUT' %}
            <span class="api-method api-method--put api-method--xs">PUT</span>
          {% case 'PATCH' %}
            <span class="api-method api-method--patch api-method--xs">PATCH</span>
          {% case 'DELETE' %}
            <span class="api-method api-method--delete api-method--xs">DELETE</span>
          {% case _ %}
            <span class="api-method api-method--xs">{{ method }}</span>
        {% end %}
        <span class="api-tag__filter-count">{{ method_count }}</span>
      </button>
    {% end %}
  </div>

  {# Endpoint List #}
  <div class="api-tag__endpoints">
    {% for ep in endpoints %}
      {% let ep_meta = ep.typed_metadata %}
      {% let is_deprecated = ep_meta?.deprecated ?? false %}

      <a
        href="{{ ep.url }}"
        class="api-tag__endpoint card card--hoverable {{ 'api-tag__endpoint--deprecated' if is_deprecated else '' }}"
        data-method="{{ (ep_meta?.method ?? 'GET') | lower }}"
      >
        <div class="api-tag__endpoint-header">
          {# Method Badge #}
          {% match ep_meta?.method %}
            {% case 'GET' %}
              <span class="api-method api-method--get">GET</span>
            {% case 'POST' %}
              <span class="api-method api-method--post">POST</span>
            {% case 'PUT' %}
              <span class="api-method api-method--put">PUT</span>
            {% case 'PATCH' %}
              <span class="api-method api-method--patch">PATCH</span>
            {% case 'DELETE' %}
              <span class="api-method api-method--delete">DELETE</span>
            {% case _ %}
              <span class="api-method">{{ ep_meta?.method }}</span>
          {% end %}

          {# Path #}
          <code class="api-tag__endpoint-path">{{ ep_meta?.path ?? ep.name }}</code>

          {# Deprecated Badge #}
          {% if is_deprecated %}
            <span class="badge badge--warning-subtle badge--sm">Deprecated</span>
          {% end %}
        </div>

        {# Summary #}
        {% with ep_meta?.summary ?? ep.description as summary %}
          {% if summary %}
          <p class="api-tag__endpoint-summary text-muted">{{ summary | truncate(150) }}</p>
          {% end %}
        {% end %}

        {# Quick Info: Auth + Params Count #}
        <div class="api-tag__endpoint-meta">
          {% if ep_meta?.security %}
            <span class="api-tag__endpoint-auth">
              <svg class="icon icon--xs" aria-hidden="true">
                <use href="#icon-lock"></use>
              </svg>
              Auth required
            </span>
          {% end %}

          {% if ep_meta?.parameters %}
            <span class="api-tag__endpoint-params">
              {{ ep_meta.parameters | length }} param{{ 's' if ep_meta.parameters | length != 1 else '' }}
            </span>
          {% end %}
        </div>
      </a>
    {% else %}
      <p class="api-tag__empty text-muted">No endpoints in this category.</p>
    {% end %}
  </div>
</div>

{# Filter Script #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const filters = document.querySelectorAll('.api-tag__filter');
  const endpoints = document.querySelectorAll('.api-tag__endpoint');

  filters.forEach(filter => {
    filter.addEventListener('click', function() {
      const method = this.dataset.filter;

      // Update active state
      filters.forEach(f => {
        f.classList.remove('api-tag__filter--active');
        f.setAttribute('aria-selected', 'false');
      });
      this.classList.add('api-tag__filter--active');
      this.setAttribute('aria-selected', 'true');

      // Filter endpoints
      endpoints.forEach(ep => {
        if (method === 'all' || ep.dataset.method === method) {
          ep.style.display = '';
        } else {
          ep.style.display = 'none';
        }
      });
    });
  });
});
</script>
{% end %}
