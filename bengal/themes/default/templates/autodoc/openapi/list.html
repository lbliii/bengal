{#
Bengal OpenAPI List Page

Consolidated view of multiple endpoints within a tag/resource section.
This is the standard "list" view for OpenAPI - shows all endpoints inline.

Template Naming Convention:
- home.html = Landing page (overview with stats, auth, categories)
- list.html = List view (consolidated endpoints for a tag section)
- single.html = Individual item (endpoint.html, schema.html are domain-specific)
- section-index.html = Generic fallback for sections without specific content

Context:
- section: Section (with metadata.endpoints list)
- site: Site
- config: Config
#}
{% extends 'autodoc/openapi/layouts/reference.html' %}

{% let tag_name = section.title ?? 'API Reference' %}
{% let tag_desc = section.metadata.description ?? '' %}
{% let endpoint_list = section.metadata.endpoints ?? [] %}
{# Schemas dict for resolving $ref links in request/response bodies #}
{% let schemas = section.metadata.schemas ?? section.parent.metadata.schemas ?? {} %}

{% block header %}
<header class="api-list-header">
    <nav class="api-list-header__breadcrumb" aria-label="API breadcrumb">
        <ol class="breadcrumb">
            {% if section.parent %}
            <li class="breadcrumb__item">
                <a href="{{ section.parent.href }}">{{ section.parent.title }}</a>
            </li>
            {% end %}
            <li class="breadcrumb__item">
                <span aria-current="page">{{ tag_name }}</span>
            </li>
        </ol>
    </nav>

    <h1 class="api-list-header__title">{{ tag_name }}</h1>

    {% if tag_desc %}
    <div class="api-list-header__description prose">
        {{ tag_desc | markdownify | safe }}
    </div>
    {% end %}

    <div class="api-list-header__meta">
        <span class="badge badge--outline">{{ endpoint_list | length }} endpoint{{ 's' if endpoint_list | length != 1
            else '' }}</span>
    </div>
</header>
{% end %}

{% block content %}
<article class="api-list" data-autodoc="openapi">
    {# Table of Contents for this section #}
    <nav class="api-list__toc" aria-label="Endpoints in this section">
        <h2 class="api-list__toc-title">Endpoints</h2>
        <ul class="api-list__toc-list">
            {% for ep in endpoint_list %}
            {% let ep_meta = ep.typed_metadata if ep.typed_metadata else ep %}
            {% let method = ep_meta.method ?? 'GET' %}
            {% let path = ep_meta.path ?? ep.name %}
            {% let ep_id = (method ~ '-' ~ path) | slugify %}

            <li class="api-list__toc-item">
                <a href="#{{ ep_id }}" class="api-list__toc-link">
                    {% match method %}
                    {% case 'GET' %}
                    <span class="api-method api-method--get api-method--xs">GET</span>
                    {% case 'POST' %}
                    <span class="api-method api-method--post api-method--xs">POST</span>
                    {% case 'PUT' %}
                    <span class="api-method api-method--put api-method--xs">PUT</span>
                    {% case 'PATCH' %}
                    <span class="api-method api-method--patch api-method--xs">PATCH</span>
                    {% case 'DELETE' %}
                    <span class="api-method api-method--delete api-method--xs">DELETE</span>
                    {% case _ %}
                    <span class="api-method api-method--xs">{{ method }}</span>
                    {% end %}
                    <code>{{ path }}</code>
                </a>
            </li>
            {% end %}
        </ul>
    </nav>

    {# Consolidated Endpoints #}
    <div class="api-list__endpoints">
        {% for ep in endpoint_list %}
        {% let ep_meta = ep.typed_metadata if ep.typed_metadata else ep %}
        {% let method = ep_meta.method ?? 'GET' %}
        {% let path = ep_meta.path ?? ep.name %}
        {% let ep_id = (method ~ '-' ~ path) | slugify %}
        {% let summary = ep_meta.summary ?? ep.description ?? '' %}
        {% let parameters = ep_meta.parameters ?? () %}
        {% let request_body = ep_meta.request_body %}
        {% let responses = ep_meta.responses ?? () %}
        {% let is_deprecated = ep_meta.deprecated ?? false %}

        <section class="api-list__endpoint {{ 'api-list__endpoint--deprecated' if is_deprecated else '' }}"
            id="{{ ep_id }}">
            {# Endpoint Header #}
            <header class="api-list__endpoint-header">
                <div class="api-list__endpoint-method-path">
                    {% match method %}
                    {% case 'GET' %}
                    <span class="api-method api-method--get">GET</span>
                    {% case 'POST' %}
                    <span class="api-method api-method--post">POST</span>
                    {% case 'PUT' %}
                    <span class="api-method api-method--put">PUT</span>
                    {% case 'PATCH' %}
                    <span class="api-method api-method--patch">PATCH</span>
                    {% case 'DELETE' %}
                    <span class="api-method api-method--delete">DELETE</span>
                    {% case _ %}
                    <span class="api-method">{{ method }}</span>
                    {% end %}
                    <code class="api-list__endpoint-path">{{ path | highlight_path_params | safe }}</code>

                    {% if is_deprecated %}
                    <span class="badge badge--warning-subtle">Deprecated</span>
                    {% end %}
                </div>

                {% if summary %}
                <p class="api-list__endpoint-summary">{{ summary }}</p>
                {% end %}
            </header>

            {# Parameters #}
            {% if parameters %}
            <div class="api-list__endpoint-params">
                <h4 class="api-list__subsection-title">Parameters</h4>
                <div class="api-list__param-list">
                    {% for param in parameters %}
                    {% include 'autodoc/openapi/partials/param-row.html' %}
                    {% end %}
                </div>
            </div>
            {% end %}

            {# Request Body #}
            {% with request_body as body %}
            {% if body %}
            <div class="api-list__endpoint-body">
                {% include 'autodoc/openapi/partials/request-body.html' %}
            </div>
            {% end %}
            {% end %}

            {# Responses #}
            {% if responses %}
            <div class="api-list__endpoint-responses">
                {% include 'autodoc/openapi/partials/responses.html' %}
            </div>
            {% end %}

            {# Code Sample (collapsed) #}
            <details class="api-list__endpoint-code">
                <summary>Code Examples</summary>
                {# Set element for partial #}
                {% let element = ep %}
                {% include 'autodoc/openapi/partials/code-samples.html' %}
            </details>
        </section>
        {% else %}
        <p class="api-list__empty text-muted">No endpoints in this section.</p>
        {% end %}
    </div>
</article>
{% end %}
