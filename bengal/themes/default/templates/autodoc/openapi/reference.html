{% extends "base.html" %}

{#
================================================================================
OpenAPI Consolidated Reference Template (Kida-Enhanced)
================================================================================

A "Gold Standard" REST API reference page that consolidates all endpoints
for a specific tag or resource into a single, three-panel scrolling view.

Features:
- Left Panel: Navigation (inherited from base.html)
- Center Panel: Documentation for all endpoints in this group
- Right Panel: Sticky code examples that track with the scrolling content
- Collapsible sections for each endpoint to manage vertical space

This template receives:
- section: The Section object (e.g., a Tag section)
- endpoints: List of DocElement objects for the endpoints
- config: Autodoc configuration
- site: Site instance
================================================================================
#}

{% from 'partials/navigation-components.html' import breadcrumbs, page_navigation, toc %}

{# Cache group info #}
{% let
  tag_name = section.title,
  description = section.params.description ?? section.params.summary,
  all_endpoints = section.params.endpoints ?? []
%}

{% block content %}
{# Radical "Gold Standard" REST layout: Edge-to-edge, fixed sidebars, obsidian examples #}
<div class="rest-explorer">
  {# 1. Specialized Left Sidebar #}
  <aside class="rest-explorer__sidebar" role="navigation" aria-label="API navigation">
    {% include 'autodoc/partials/rest-nav.html' %}
  </aside>

  {# 2. Main Scrolling Content #}
  <main class="rest-explorer__content">
    <header class="rest-explorer__header">
      <h1 class="rest-explorer__title">{{ tag_name }}</h1>
      <div class="autodoc-badges">
        <span class="autodoc-badge" data-badge="openapi">OpenAPI 3.1</span>
        <span class="autodoc-badge" data-badge="rest">REST</span>
      </div>
      {% if description %}
      <div class="rest-explorer__description prose">
        {{ description | markdownify | safe }}
      </div>
      {% end %}
    </header>

    <div class="rest-explorer__endpoints">
      {% for element in all_endpoints %}
        {% let
          meta = element.metadata,
          method = meta.method | upper,
          path = meta.path,
          summary = meta.summary ?? element.description,
          operation_id = meta.operation_id,
          is_deprecated = meta.deprecated ?? false,
          parameters = meta.parameters ?? [],
          req_body = meta.request_body ?? {},
          responses = meta.responses ?? {}
        %}

        <section id="{{ operation_id or (method|lower ~ '-' ~ path|slugify) }}"
                 class="rest-endpoint"
                 data-method="{{ method | lower }}">

          <div class="rest-endpoint__doc">
            <div class="rest-endpoint__header">
              <div class="rest-endpoint__title-row">
                <span class="autodoc-method" data-method="{{ method | lower }}">{{ method }}</span>
                <code class="rest-endpoint__path">{{ path }}</code>
              </div>
              <h2 class="rest-endpoint__summary">{{ summary or path }}</h2>
            </div>

            <div class="rest-endpoint__body">
              {# Parameters Section #}
              {% if parameters | length > 0 %}
                {% let params = parameters %}
                {% let title = 'Parameters' %}
                {% include 'autodoc/partials/params-table.html' %}
              {% end %}

              {% if req_body %}
              <div class="autodoc-section" data-section="request-body">
                <h3 class="autodoc-section-title">Request Body</h3>
                {% if req_body.description %}
                <div class="autodoc-description"><p>{{ req_body.description }}</p></div>
                {% end %}
                {% if req_body.content is mapping %}
                <div class="autodoc-badges">
                  {% for content_type in req_body.content.keys() %}
                  <span class="autodoc-badge" data-badge="content-type">{{ content_type }}</span>
                  {% end %}
                </div>
                {% end %}
              </div>
              {% end %}

              {% if responses %}
              <div class="autodoc-section" data-section="responses">
                <h3 class="autodoc-section-title">Responses</h3>
                <table class="autodoc-table">
                  <thead><tr><th>Status</th><th>Description</th></tr></thead>
                  <tbody>
                    {% for status_code, response in responses.items() %}
                    <tr>
                      <td><code data-status-class="{{ status_code[:1] }}">{{ status_code }}</code></td>
                      <td>{{ response.description ?? 'â€”' }}</td>
                    </tr>
                    {% end %}
                  </tbody>
                </table>
              </div>
              {% end %}
            </div>
          </div>

          <div class="rest-endpoint__example">
            <div class="autodoc-examples-group">
              <div class="autodoc-example">
                <header class="autodoc-example-header">
                  <h4 class="autodoc-example-title">Request</h4>
                  <span class="autodoc-example-lang">curl</span>
                </header>
                <div class="autodoc-example-body">
                  <pre><code class="language-bash">curl -X {{ method }} "https://api.example.com{{ path }}"</code></pre>
                </div>
              </div>

              {% for status_code, response in responses.items() %}
                {% if status_code[:1] == '2' %}
                <div class="autodoc-example">
                  <header class="autodoc-example-header">
                    <h4 class="autodoc-example-title">Response {{ status_code }}</h4>
                    <span class="autodoc-example-lang">json</span>
                  </header>
                  <div class="autodoc-example-body">
                    {% let response_example = response.content['application/json']?.example ?? response.content['application/json']?.examples?.values() | first ?? {"status": "success"} %}
                    <pre><code class="language-json">{{ response_example | tojson(indent=2) }}</code></pre>
                  </div>
                </div>
                {% end %}
              {% end %}
            </div>
          </div>
        </section>
      {% end %}
    </div>

    {{ page_navigation(page) }}

    {# Footer inside scrollable area #}
    <footer class="rest-explorer__footer">
      <div class="footer-bottom">
        <p>&copy; {{ site.build_time | dateformat('%Y') }} {{ config.title }}</p>
      </div>
    </footer>
  </main>
</div>

{# Disable standard footer #}
{% block site_footer %}{% end %}

{# Scroll Sync Script #}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const endpoints = document.querySelectorAll('.rest-endpoint');
  const navItems = document.querySelectorAll('.docs-nav-rest-item');

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entries.some(e => e.isIntersecting)) {
        const intersecting = entries.filter(e => e.isIntersecting).sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (intersecting) {
          const id = intersecting.target.id;
          navItems.forEach(item => {
            const link = item.querySelector('a');
            if (link.getAttribute('href') === '#' + id) {
              item.classList.add('active');
            } else {
              item.classList.remove('active');
            }
          });
        }
      }
    });
  }, { threshold: [0.1, 0.5], rootMargin: '-10% 0px -70% 0px' });

  endpoints.forEach(el => observer.observe(el));
});
</script>
{% end %}
