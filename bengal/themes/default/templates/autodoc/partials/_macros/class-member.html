{#
================================================================================
Class Member Macro (Kida-Native)
================================================================================

Renders a class as a collapsible card with status dot, count badge, and description.
Uses the unified autodoc design system.

USAGE:
  {% from 'autodoc/partials/_macros/class-member.html' import class_member %}
  {{ class_member(cls, is_first=loop.first) }}

ARGS:
  cls: Class DocElement to render (required)
  is_first: Whether this is the first item (to auto-open)

KIDA FEATURES USED:
  - Optional chaining (?.) for safe attribute access
  - Null coalescing (??) for defaults
  - {% let %} for template-scoped caching

================================================================================
#}

{% def class_member(cls, is_first=false) %}
{# Pre-compute all values with null-safety #}
{% let
    cls_children = cls?.children ?? [],
    cls_methods = cls_children | selectattr('element_type', 'eq', 'method') | list,
    cls_attrs = cls_children | selectattr('element_type', 'eq', 'attribute') | list,
    cls_props = cls_children | selectattr('element_type', 'eq', 'property') | list,
    all_attrs = cls_attrs + cls_props,
    total_members = (cls_methods | length) + (all_attrs | length),
    cls_meta = cls?.metadata ?? {},
    is_dataclass = cls_meta?.is_dataclass ?? false,
    is_abstract = cls_meta?.is_abstract ?? false,
    cls_name = cls?.name ?? 'Unknown',
    cls_desc = cls?.description ?? ''
%}

<details class="autodoc-member" data-member="class" {% if is_first %}open{% end %}>
  <summary class="autodoc-member-header">
    {# Status dot (yellow/amber for classes) #}
    <span class="autodoc-member-dot"></span>

    {# Content wrapper #}
    <div class="autodoc-member-content">
      <div class="autodoc-member-name-row">
        <code class="autodoc-member-name">{{ cls_name }}</code>
        {# Count badge #}
        <span class="autodoc-member-count" title="{{ cls_methods | length }} method{% if cls_methods | length != 1 %}s{% end %}{% if all_attrs | length > 0 %}, {{ all_attrs | length }} attribute{% if all_attrs | length != 1 %}s{% end %}{% end %}">{{ total_members }}</span>
        {# Toggle indicator #}
        <span class="autodoc-member-toggle">▼</span>
      </div>
      {# Description preview #}
      {% if cls_desc %}
      <span class="autodoc-member-desc-preview">{{ cls_desc | truncate(100, True, '…') }}</span>
      {% end %}
    </div>

    {# Badges #}
    {% if is_dataclass or is_abstract %}
    <span class="autodoc-member-badges">
      {% if is_dataclass %}
      <span class="autodoc-badge" data-badge="dataclass">dataclass</span>
      {% end %}
      {% if is_abstract %}
      <span class="autodoc-badge" data-badge="abstract">abstract</span>
      {% end %}
    </span>
    {% end %}
  </summary>

  <div class="autodoc-member-body">
    {% if cls_desc %}
    <div class="autodoc-member-desc prose">
      {{ cls_desc | markdownify | safe }}
    </div>
    {% end %}

    {# Class attributes (from children with element_type='attribute' or 'property') #}
    {% if all_attrs | length > 0 %}
    <div class="autodoc-section" data-section="attributes">
      <h4 class="autodoc-label">Attributes</h4>
      <table class="autodoc-table" data-table="attributes">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for attr in all_attrs %}
          {# Attributes are DocElements with name, description, and metadata.annotation #}
          {% set attr_meta = attr?.metadata ?? {} %}
          {% set attr_type = attr_meta?.annotation %}
          {% set attr_name = attr?.name ?? 'unknown' %}
          {% set attr_desc = attr?.description ?? '' %}
          <tr>
            <td class="autodoc-cell-name"><code>{{ attr_name }}</code></td>
            <td class="autodoc-cell-type">{% if attr_type %}<code>{{ attr_type }}</code>{% else %}—{% end %}</td>
            <td class="autodoc-cell-desc">{{ attr_desc | markdownify | safe if attr_desc else '—' }}</td>
          </tr>
          {% end %}
        </tbody>
      </table>
    </div>
    {% end %}

    {# Class methods - use unified members partial #}
    {% if cls_methods | length > 0 %}
    <div class="autodoc-section" data-section="methods">
      <h4 class="autodoc-label">Methods</h4>
      {% set members = cls_methods %}
      {% set title = '' %}
      {% set member_type = 'method' %}
      {% set first_open = false %}
      {% include 'autodoc/partials/members.html' %}
    </div>
    {% end %}
  </div>
</details>
{% end %}
