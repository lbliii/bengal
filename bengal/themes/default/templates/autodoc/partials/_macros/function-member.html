{#
Function Member Macro

Renders a function as a collapsible card with status dot, param count, and return type.
Uses the unified autodoc design system.

Usage:
  {% from 'autodoc/partials/_macros/function-member.html' import function_member %}
  {{ function_member(func, is_first=loop.first) }}

Args:
  func: Function DocElement to render (required)
  is_first: Whether this is the first item (to auto-open)
#}

{% macro function_member(func, is_first=false) %}
{# Parameters can be in metadata.args (from extractor) or metadata.parameters #}
{% set func_params = func.metadata.args or func.metadata.parameters or [] %}
{% set func_return = func.metadata.return_type or func.metadata.returns or '' %}
{% set func_signature = func.metadata.signature or '' %}
{% set is_async = func.metadata.is_async | default(false) %}

<details class="autodoc-member" data-member="function" {% if is_first %}open{% endif %}>
  <summary class="autodoc-member-header">
    {# Status dot (green for functions) #}
    <span class="autodoc-member-dot"></span>

    {# Content wrapper #}
    <div class="autodoc-member-content">
      <div class="autodoc-member-name-row">
        <code class="autodoc-member-name">{{ func.name }}</code>
        {# Parameter count badge #}
        <span class="autodoc-member-count" title="{{ func_params | length }} parameter{% if func_params | length != 1 %}s{% endif %}">{{ func_params | length }}</span>
        {# Return type with arrow #}
        {% if func_return %}
        <span class="autodoc-member-return" title="Returns {{ func_return }}">
          <code>{{ func_return | truncate(25, True, '…') }}</code>
        </span>
        {% endif %}
        {# Toggle indicator #}
        <span class="autodoc-member-toggle">▼</span>
      </div>
      {# Signature preview #}
      {% if func_signature %}
      <code class="autodoc-member-sig">{{ func_signature }}</code>
      {% endif %}
    </div>

    {# Badges #}
    {% if is_async %}
    <span class="autodoc-member-badges">
      <span class="autodoc-badge" data-badge="async">async</span>
    </span>
    {% endif %}
  </summary>

  <div class="autodoc-member-body">
    {% if func.description %}
    <div class="autodoc-member-desc prose">
      {{ func.description | replace('\n\n', '</p><p>') | replace('\n', '<br>') | safe }}
    </div>
    {% endif %}

    {# Function parameters - args is a list of dicts with name, type, docstring, default #}
    {% if func_params %}
    <div class="autodoc-params-section">
      <h5 class="autodoc-params-title">Parameters</h5>
      <dl class="autodoc-params">
        {% for param in func_params %}
        {# Handle both dict and object access patterns #}
        {% set param_name = param.get('name', '') if param.get else (param.name if param.name is defined else '') %}
        {% set param_type = param.get('type', '') if param.get else (param.type if param.type is defined else '') %}
        {# docstring is the description from parsed docstring #}
        {% set param_desc = param.get('docstring', '') if param.get else (param.docstring if param.docstring is defined else '') %}
        {% set param_default = param.get('default') if param.get else (param.default if param.default is defined else none) %}
        <div class="autodoc-param">
          <dt class="autodoc-param-name">
            <code>{{ param_name }}</code>
            {% if param_type %}
            <span class="autodoc-param-type">{{ param_type }}</span>
            {% endif %}
          </dt>
          <dd class="autodoc-param-desc">
            {{ param_desc }}
            {% if param_default is not none and param_default != '' %}
            <span class="autodoc-param-default">Default: <code>{{ param_default }}</code></span>
            {% endif %}
          </dd>
        </div>
        {% endfor %}
      </dl>
    </div>
    {% endif %}

    {# Return type (detailed) #}
    {% if func_return %}
    <div class="autodoc-returns">
      <code class="autodoc-returns-type">{{ func_return }}</code>
      {% if func.metadata.return_description %}
      <span class="autodoc-returns-desc">{{ func.metadata.return_description }}</span>
      {% endif %}
    </div>
    {% endif %}

    {# Raises #}
    {% if func.metadata.raises %}
    <dl class="autodoc-raises">
      {% for exc in func.metadata.raises %}
      <div class="autodoc-raise">
        <dt><code>{{ exc.type | default(exc.get('type', '')) }}</code></dt>
        <dd>{{ exc.description | default(exc.get('description', '')) }}</dd>
      </div>
      {% endfor %}
    </dl>
    {% endif %}
  </div>
</details>
{% endmacro %}
