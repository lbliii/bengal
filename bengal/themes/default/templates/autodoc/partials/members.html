{#
Autodoc Members Partial

Renders collapsible member cards for methods, attributes, etc.
With status dots, counts, return types, and internal method separation.

Required: members (list of DocElements)
Optional: title (str), member_type (str), first_open (bool, default true)
#}

{% set title = title | default('Members') %}
{% set member_type = member_type | default('method') %}
{% set first_open = first_open | default(true) %}

{# Separate public and internal members #}
{% set public_members = members | rejectattr('name', 'match', '^_') | list if members else [] %}
{% set internal_members = members | selectattr('name', 'match', '^_') | list if members else [] %}

{% if members %}
<section class="autodoc-section" data-section="{{ member_type }}s">
  <h2 class="autodoc-section-title">{{ title }}</h2>

  {# Public members #}
  {% if public_members %}
  <div class="autodoc-members-list">
    {% for member in public_members %}
    {% set member_return = member.metadata.return_type | default(member.metadata.returns | default('')) %}
    {% set member_params = member.metadata.parameters | default(member.children | default([]) | selectattr('element_type', 'eq', 'parameter') | list) %}
    {% set param_count = member_params | length %}

    <details class="autodoc-member" data-member="{{ member_type }}" {% if first_open and loop.first %}open{% endif %}>
      <summary class="autodoc-member-header">
        {# Status dot #}
        <span class="autodoc-member-dot"></span>

        {# Content wrapper #}
        <div class="autodoc-member-content">
          <div class="autodoc-member-name-row">
            <code class="autodoc-member-name">{{ member.name }}</code>
            {# Parameter count badge #}
            <span class="autodoc-member-count" title="{{ param_count }} parameter{% if param_count != 1 %}s{% endif %}">{{ param_count }}</span>
            {# Return type with arrow #}
            {% if member_return %}
            <span class="autodoc-member-return" title="Returns {{ member_return }}">
              <code>{{ member_return | truncate(25, True, '…') }}</code>
            </span>
            {% endif %}
            {# Toggle indicator #}
            <span class="autodoc-member-toggle">▼</span>
          </div>
        </div>

        {# Badges #}
        {% set member_badges = [] %}
        {% if member.metadata.is_async %}{% set _ = member_badges.append('async') %}{% endif %}
        {% if member.metadata.is_classmethod %}{% set _ = member_badges.append('classmethod') %}{% endif %}
        {% if member.metadata.is_staticmethod %}{% set _ = member_badges.append('staticmethod') %}{% endif %}
        {% if member.metadata.is_property %}{% set _ = member_badges.append('property') %}{% endif %}
        {% if member.metadata.is_abstract %}{% set _ = member_badges.append('abstract') %}{% endif %}
        {% if member.metadata.is_deprecated %}{% set _ = member_badges.append('deprecated') %}{% endif %}
        {% if member_badges %}
        <span class="autodoc-member-badges">
          {% for badge in member_badges %}
          <span class="autodoc-badge" data-badge="{{ badge }}">{{ badge }}</span>
          {% endfor %}
        </span>
        {% endif %}
      </summary>

      <div class="autodoc-member-body">
        {% if member.description %}
        <div class="autodoc-member-desc">
          <p>{{ member.description }}</p>
        </div>
        {% endif %}

        {# Member parameters #}
        {% if member_params %}
        <dl class="autodoc-params">
          {% for param in member_params %}
          {% set param_name = param.name if param.name is defined else param.get('name', '') %}
          {% set param_type_val = param.type if param.type is defined else param.get('type', '') %}
          {% set param_desc = param.description if param.description is defined else param.get('description', '') %}
          <div class="autodoc-param">
            <dt class="autodoc-param-name">
              <code>{{ param_name }}</code>
              {% if param_type_val %}
              <span class="autodoc-param-type">{{ param_type_val }}</span>
              {% endif %}
            </dt>
            <dd class="autodoc-param-desc">{{ param_desc }}</dd>
          </div>
          {% endfor %}
        </dl>
        {% endif %}

        {# Member return type (detailed) #}
        {% if member_return and member.metadata.return_description %}
        <div class="autodoc-returns">
          <code class="autodoc-returns-type">{{ member_return }}</code>
          <span class="autodoc-returns-desc">{{ member.metadata.return_description }}</span>
        </div>
        {% endif %}
      </div>
    </details>
    {% endfor %}
  </div>
  {% endif %}

  {# Internal members (collapsed by default) #}
  {% if internal_members %}
  <details class="autodoc-internal-methods">
    <summary class="autodoc-internal-methods-header">
      <span class="autodoc-internal-methods-label">
        <span>Internal Methods</span>
        <span class="autodoc-member-count">{{ internal_members | length }}</span>
      </span>
      <span class="autodoc-member-toggle">▼</span>
    </summary>
    <div class="autodoc-internal-methods-content">
      {% for member in internal_members %}
      {% set member_return = member.metadata.return_type | default(member.metadata.returns | default('')) %}
      {% set member_params = member.metadata.parameters | default(member.children | default([]) | selectattr('element_type', 'eq', 'parameter') | list) %}
      {% set param_count = member_params | length %}

      <details class="autodoc-member" data-member="{{ member_type }}">
        <summary class="autodoc-member-header">
          {# Status dot #}
          <span class="autodoc-member-dot"></span>

          {# Content wrapper #}
          <div class="autodoc-member-content">
            <div class="autodoc-member-name-row">
              <code class="autodoc-member-name">{{ member.name }}</code>
              {# Parameter count badge #}
              <span class="autodoc-member-count" title="{{ param_count }} parameter{% if param_count != 1 %}s{% endif %}">{{ param_count }}</span>
              {# Return type with arrow #}
              {% if member_return %}
              <span class="autodoc-member-return" title="Returns {{ member_return }}">
                <code>{{ member_return | truncate(25, True, '…') }}</code>
              </span>
              {% endif %}
              {# Toggle indicator #}
              <span class="autodoc-member-toggle">▼</span>
            </div>
          </div>

          {# Badges #}
          {% set member_badges = [] %}
          {% if member.metadata.is_async %}{% set _ = member_badges.append('async') %}{% endif %}
          {% if member.metadata.is_classmethod %}{% set _ = member_badges.append('classmethod') %}{% endif %}
          {% if member.metadata.is_staticmethod %}{% set _ = member_badges.append('staticmethod') %}{% endif %}
          {% if member.metadata.is_property %}{% set _ = member_badges.append('property') %}{% endif %}
          {% if member.metadata.is_abstract %}{% set _ = member_badges.append('abstract') %}{% endif %}
          {% if member.metadata.is_deprecated %}{% set _ = member_badges.append('deprecated') %}{% endif %}
          {% if member_badges %}
          <span class="autodoc-member-badges">
            {% for badge in member_badges %}
            <span class="autodoc-badge" data-badge="{{ badge }}">{{ badge }}</span>
            {% endfor %}
          </span>
          {% endif %}
        </summary>

        <div class="autodoc-member-body">
          {% if member.description %}
          <div class="autodoc-member-desc">
            <p>{{ member.description }}</p>
          </div>
          {% endif %}

          {# Member parameters #}
          {% if member_params %}
          <dl class="autodoc-params">
            {% for param in member_params %}
            {% set param_name = param.name if param.name is defined else param.get('name', '') %}
            {% set param_type_val = param.type if param.type is defined else param.get('type', '') %}
            {% set param_desc = param.description if param.description is defined else param.get('description', '') %}
            <div class="autodoc-param">
              <dt class="autodoc-param-name">
                <code>{{ param_name }}</code>
                {% if param_type_val %}
                <span class="autodoc-param-type">{{ param_type_val }}</span>
                {% endif %}
              </dt>
              <dd class="autodoc-param-desc">{{ param_desc }}</dd>
            </div>
            {% endfor %}
          </dl>
          {% endif %}
        </div>
      </details>
      {% endfor %}
    </div>
  </details>
  {% endif %}
</section>
{% endif %}
