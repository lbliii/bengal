{% extends "base.html" %}

{#
Blog List Template

Used for blog section indexes. Displays blog posts in reverse chronological
order with featured posts, excerpts, and pagination.

Usage: Set `type: blog` in section _index.md

Context variables:
- section: Section object with blog posts
- posts: List of blog post pages (may be paginated)
- subsections: Blog categories/archives
- total_pages: Total pagination pages
- current_page: Current page number
#}

{% from 'partials/navigation-components.html' import breadcrumbs, pagination %}
{% from 'partials/content-components.html' import tag_list %}

{# Defensive defaults for pagination variables (safe fallback if not provided) #}
{% set total_pages = total_pages | default(1) %}
{% set current_page = current_page | default(1) %}
{% set total_posts = total_posts | default(posts | length if posts else 0) %}
{% set base_url = base_url | default(section.href if section else '/blog/') %}

{% block content %}
<div class="container">
{# Action Bar: Breadcrumbs + Share #}
{% include 'partials/action-bar.html' %}

<div class="blog-container">
    <header class="page-header page-header--centered">
        <h1>✍️ {{ section.title if section else title | default('Blog') }}</h1>

        {% if section and section.metadata.description %}
        <p class="blog-description">{{ section.metadata.description }}</p>
        {% elif description %}
        <p class="blog-description">{{ description }}</p>
        {% end %}

        {% if total_pages %}
        <p class="blog-count">
            Showing {{ posts | length }} of {{ total_posts }} posts
            {% if current_page > 1 %}(Page {{ current_page }} of {{ total_pages }}){% end %}
        </p>
        {% end %}
    </header>

    {% if posts %}
    {# Featured Posts Section #}
    {% set featured_posts = posts | where('featured', true) | limit(3) %}
    {% if featured_posts and current_page == 1 %}
    <section class="blog-featured">
        <h2 class="blog-section-title">Featured Posts</h2>
        <div class="blog-featured-grid stagger-fade-in">
            {% for post in featured_posts %}
            <article class="blog-featured-card gradient-border-strong fluid-bg">
                {% if post.metadata.image or post.metadata.cover %}
                <div class="blog-card-image">
                    <a href="{{ post.href }}">
                        <img src="{{ post.metadata.image | default(post.metadata.cover) }}"
                            alt="{{ post.title }}">
                    </a>
                </div>
                {% end %}

                <div class="blog-card-content">
                    <h3 class="blog-card-title">
                    <a href="{{ post.href }}">{{ post.title }}</a>
                    </h3>

                    {% if post.metadata.description or post.excerpt %}
                    <p class="blog-card-excerpt">
                        {{ post.metadata.description | default(post.excerpt) | truncate(180) }}
                    </p>
                    {% end %}

                    <div class="blog-card-meta">
                        {% if post.metadata.author %}
                        <span class="blog-author">
                            {% if post.metadata.author_avatar %}
                            <img src="{{ post.metadata.author_avatar }}" alt="{{ post.metadata.author }}"
                                class="author-avatar">
                            {% end %}
                            {{ post.metadata.author }}
                        </span>
                        {% end %}

                        {% if post.date %}
                        <time datetime="{{ post.date | date_iso }}">
                            {{ post.date | dateformat('%B %d, %Y') }}
                        </time>
                        {% end %}

                        {% if post.content %}
                        <span class="reading-time">
                            {{ (post.content | wordcount / 200) | round }} min read
                        </span>
                        {% end %}
                    </div>

                    {% if post.tags %}
                    <div class="blog-card-tags">
                        {{ tag_list(post.tags | limit(3)) }}
                    </div>
                    {% end %}
                </div>
            </article>
            {% end %}
        </div>
    </section>
    {% end %}

    {# All Posts Section #}
    {% set regular_posts = posts | where_not('featured', true) if current_page == 1 else posts %}
    {% if regular_posts %}
    <section class="blog-posts">
        {% if featured_posts and current_page == 1 %}
        <h2 class="blog-section-title">Recent Posts</h2>
        {% end %}

        <div class="blog-post-list">
            {% for post in regular_posts %}
            <article class="blog-post-card gradient-border fluid-combined">
                {% if post.metadata.image or post.metadata.cover %}
                <div class="blog-card-image">
                <a href="{{ post.href }}">
                        <img src="{{ post.metadata.image | default(post.metadata.cover) }}"
                            alt="{{ post.title }}">
                    </a>
                </div>
                {% end %}

                <div class="blog-card-content">
                    <h3 class="blog-card-title">
                    <a href="{{ post.href }}">{{ post.title }}</a>
                    </h3>

                    {% if post.metadata.description or post.excerpt %}
                    <p class="blog-card-excerpt">
                        {{ post.metadata.description | default(post.excerpt) | truncate(200) }}
                    </p>
                    {% end %}

                    <div class="blog-card-meta">
                        {% if post.metadata.author %}
                        <span class="blog-author">
                            {% if post.metadata.author_avatar %}
                            <img src="{{ post.metadata.author_avatar }}" alt="{{ post.metadata.author }}"
                                class="author-avatar">
                            {% end %}
                            {{ post.metadata.author }}
                        </span>
                        {% end %}

                        {% if post.date %}
                        <time datetime="{{ post.date | date_iso }}">
                            {{ post.date | time_ago }}
                        </time>
                        {% end %}

                        {% if post.content %}
                        <span class="reading-time">
                            {{ (post.content | wordcount / 200) | round }} min read
                        </span>
                        {% end %}
                    </div>

                    {% if post.tags %}
                    <div class="blog-card-tags">
                        {{ tag_list(post.tags | limit(4)) }}
                    </div>
                    {% end %}

                    <a href="{{ post.href }}" class="blog-read-more">
                        Read more →
                    </a>
                </div>
            </article>
            {% end %}
        </div>
    </section>
    {% end %}

    {# Pagination #}
    {% if total_pages and total_pages > 1 %}
    {{ pagination(current_page, total_pages, base_url) }}
    {% end %}

    {% elif subsections %}
    {# Show blog categories/archives if no posts #}
    <section class="blog-categories">
        <h2 class="blog-section-title">Categories</h2>
        <div class="blog-post-list">
            {% for subsection in subsections %}
            <article class="blog-post-card">
                <div class="blog-card-content">
                    <h3 class="blog-card-title">
                    <a href="{{ subsection.href }}">{{ subsection.title }}</a>
                    </h3>
                    {% if subsection.metadata.description %}
                    <p class="blog-card-excerpt">{{ subsection.metadata.description }}</p>
                    {% end %}
                    {% if subsection.regular_pages %}
                    {# Count only non-index pages #}
                    {# Use relative_url for comparisons (without baseurl) #}
                    {% set index_url = subsection.index_page._path if subsection.index_page else '' %}
                    {% set content_pages = subsection.regular_pages | rejectattr('relative_url', 'equalto', index_url) | list %}
                    {% if content_pages %}
                    <p class="blog-card-meta">{{ content_pages | length }} post{{ 's' if content_pages | length != 1 }}
                    </p>
                    {% end %}
                    {% end %}
                </div>
            </article>
            {% end %}
        </div>
    </section>

    {% else %}
    {# Empty State #}
    <div class="blog-empty">
        <p>No blog posts yet. Check back soon!</p>
    </div>
    {% end %}

</div>
</div>
{% end %}
