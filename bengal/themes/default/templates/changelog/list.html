{% extends "base.html" %}

{#
Changelog/Release Notes Template

Used for changelog and release notes sections. Displays releases in a timeline format
with version numbers, dates, and categorized changes.

Usage: Set `type: changelog` in section _index.md

Context variables:
- section: Section object with release notes
- pages: List of release pages (individual releases)
- changelog: Changelog data from site.data.changelog (optional)

Supports two modes:
1. Data-driven: All releases in data/changelog.yaml
2. Page-driven: Each release as a separate markdown file
#}

{% block content %}
{# Load changelog data from site.data (preferred) or use pages (fallback) #}
{% set changelog_data = site.data.changelog if site.data else none %}

{# For section pages (like changelog list), ensure 'page' refers to the section #}
{% if not page and section %}
{% set page = section %}
{% end %}

{# Hero Section - matches home page style #}
{% set hero_classes = ['hero', 'hero--large'] %}
{% if page and params.blob_background %}
{% do hero_classes.append('hero--blob-background') %}
{% end %}
<header class="{{ hero_classes | join(' ') }}">
    {% if page and params.blob_background %}
    {# Organic blob background animation #}
    <div class="hero__blobs" aria-hidden="true">
        <div class="hero__blob hero__blob--1"></div>
        <div class="hero__blob hero__blob--2"></div>
        <div class="hero__blob hero__blob--3"></div>
        <div class="hero__blob hero__blob--4"></div>
    </div>
    {% end %}
    <div class="hero__container">
        <div class="hero__content">
            <h1 class="hero__title">
                <span class="fluid-text">{{ section.title if section else page.title if page else 'Changelog' }}</span>
            </h1>
            {% set hero_description = section.metadata.description if section else (params.description if page else '') %}
            {% if hero_description %}
            <p class="hero__subtitle">{{ hero_description }}</p>
            {% end %}

            {% if page and params.cta_buttons %}
            <div class="hero__actions">
                {% for button in params.cta_buttons %}
                <a href="{{ button.href or button.url | absolute_url }}"
                    class="hero__button hero__button--{{ button.style ?? 'primary' }} {% if button.style != 'primary' %}gradient-border{% end %}">
                    {{ button.text }}
                </a>
                {% end %}
            </div>
            {% end %}
        </div>
    </div>
</header>

<div class="changelog-container">

    {% if content and content.strip() %}
    <section class="changelog-content prose">
        {{ content | safe }}
    </section>
    {% end %}

    {# Check if any releases have structured metadata for filtering #}
    {% set has_structured_data = false %}
    {% if changelog_data and changelog_data.releases %}
        {% for release in changelog_data.releases %}
            {% if release.added or release.changed or release.fixed or release.breaking or release.security %}
                {% set has_structured_data = true %}
            {% end %}
        {% end %}
    {% elif pages %}
        {% for release in pages %}
            {% if release.metadata.added or release.metadata.changed or release.metadata.fixed or release.metadata.breaking or release.metadata.security %}
                {% set has_structured_data = true %}
            {% end %}
        {% end %}
    {% end %}

    {# Filter UI - Only show if structured data exists #}
    {% if has_structured_data %}
    <div class="changelog-filters">
        <button class="changelog-filter-btn active" data-filter="all" aria-pressed="true">
            All Changes
        </button>
        <button class="changelog-filter-btn" data-filter="added" aria-pressed="false">
            âœ¨ Added
        </button>
        <button class="changelog-filter-btn" data-filter="changed" aria-pressed="false">
            ğŸ”„ Changed
        </button>
        <button class="changelog-filter-btn" data-filter="fixed" aria-pressed="false">
            ğŸ› Fixed
        </button>
        <button class="changelog-filter-btn" data-filter="breaking" aria-pressed="false">
            âš¡ Breaking
        </button>
        <button class="changelog-filter-btn" data-filter="security" aria-pressed="false">
            ğŸ”’ Security
        </button>
    </div>
    {% end %}

    {# Data-driven mode: Use changelog.yaml #}
    {% if changelog_data and changelog_data.releases %}
    <section class="changelog-timeline">
        <div class="timeline">
            {% for release in changelog_data.releases | reverse %}
            {# Build list of change types for filtering #}
            {% set change_types = [] %}
            {% if release.added %} {% do change_types.append('added') %} {% end %}
            {% if release.changed %} {% do change_types.append('changed') %} {% end %}
            {% if release.fixed %} {% do change_types.append('fixed') %} {% end %}
            {% if release.breaking %} {% do change_types.append('breaking') %} {% end %}
            {% if release.security %} {% do change_types.append('security') %} {% end %}
            <div class="timeline-item" data-change-types="{{ change_types | join(' ') }}">
                <div class="timeline-header">
                    <div class="timeline-title-group">
                        <h2 class="timeline-title">
                            {% if release.url %}
                            <a href="{{ release.url }}">{{ release.version }}</a>
                            {% else %}
                            {{ release.version }}
                            {% end %}
                        </h2>
                        {% if release.name %}
                        <p class="timeline-subtitle">{{ release.name }}</p>
                        {% end %}
                    </div>
                    <div class="timeline-meta">
                        {% if release.date %}
                        <span class="timeline-date">{{ release.date }}</span>
                        {% end %}
                        {% if release.status %}
                        <span class="release-status status-{{ release.status | lower }}">
                            {{ release.status }}
                        </span>
                        {% end %}
                    </div>
                </div>

                {% if release.summary %}
                <p class="timeline-description">{{ release.summary }}</p>
                {% end %}

                {# Added Features #}
                {% if release.added and release.added is iterable and release.added is not string
                %}
                <div class="changelog-category">
                    <h3 class="category-title">âœ¨ Added</h3>
                    <ul class="changelog-list">
                        {% for item in release.added %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Changed/Improved #}
                {% if release.changed and release.changed is iterable and release.changed is not
                string %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ”„ Changed</h3>
                    <ul class="changelog-list">
                        {% for item in release.changed %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Fixed Bugs #}
                {% if release.fixed and release.fixed is iterable and release.fixed is not string
                %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ› Fixed</h3>
                    <ul class="changelog-list">
                        {% for item in release.fixed %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Deprecated #}
                {% if release.deprecated and release.deprecated is iterable and release.deprecated
                is not string %}
                <div class="changelog-category">
                    <h3 class="category-title">âš ï¸ Deprecated</h3>
                    <ul class="changelog-list">
                        {% for item in release.deprecated %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Removed #}
                {% if release.removed and release.removed is iterable and release.removed is not
                string %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ—‘ï¸ Removed</h3>
                    <ul class="changelog-list">
                        {% for item in release.removed %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Security #}
                {% if release.security and release.security is iterable and release.security is not
                string %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ”’ Security</h3>
                    <ul class="changelog-list">
                        {% for item in release.security %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {# Breaking Changes #}
                {% if release.breaking and release.breaking is iterable and release.breaking is not
                string %}
                <div class="changelog-category changelog-category--breaking">
                    <h3 class="category-title category-title--breaking">âš¡ Breaking Changes</h3>
                    <ul class="changelog-list changelog-list--breaking">
                        {% for item in release.breaking %}
                        <li class="changelog-item--breaking">{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}
            </div>
            {% end %}
        </div>
    </section>

    {# Page-driven mode: Use individual release pages #}
    {% elif pages %}
    <section class="changelog-timeline">
        <div class="timeline">
            {% for release in pages | reverse if release.href != section.href %}
            {# Build list of change types for filtering #}
            {# If no structured metadata, leave empty - JavaScript will show for all filters #}
            {% set change_types = [] %}
            {% if release.metadata.added %} {% do change_types.append('added') %} {% end %}
            {% if release.metadata.changed %} {% do change_types.append('changed') %} {% end %}
            {% if release.metadata.fixed %} {% do change_types.append('fixed') %} {% end %}
            {% if release.metadata.breaking %} {% do change_types.append('breaking') %} {% end %}
            {% if release.metadata.security %} {% do change_types.append('security') %} {% end %}
            <div class="timeline-item" data-change-types="{{ change_types | join(' ') }}">
                <div class="timeline-header">
                    <div class="timeline-title-group">
                        <h2 class="timeline-title">
                            <a href="{{ release.href }}">{{ release.title }}</a>
                        </h2>
                        {% if release.metadata.name %}
                        <p class="timeline-subtitle">{{ release.metadata.name }}</p>
                        {% end %}
                    </div>
                    <div class="timeline-meta">
                        {% if release.date %}
                        <time datetime="{{ release.date | date_iso }}">
                            {{ release.date | dateformat('%B %d, %Y') }}
                        </time>
                        {% end %}
                        {% if release.metadata.status %}
                        <span class="release-status status-{{ release.metadata.status | lower }}">
                            {{ release.metadata.status }}
                        </span>
                        {% end %}
                    </div>
                </div>

                {% set release_description = release.metadata.description or release.metadata.summary or release.excerpt %}
                {% if release_description %}
                <p class="timeline-description">
                    {{ release_description }}
                </p>
                {% end %}

                {# Show categories if in metadata #}
                {% if release.metadata.added %}
                <div class="changelog-category">
                    <h3 class="category-title">âœ¨ Added</h3>
                    <ul class="changelog-list">
                        {% for item in release.metadata.added %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {% if release.metadata.changed %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ”„ Changed</h3>
                    <ul class="changelog-list">
                        {% for item in release.metadata.changed %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                {% if release.metadata.fixed %}
                <div class="changelog-category">
                    <h3 class="category-title">ğŸ› Fixed</h3>
                    <ul class="changelog-list">
                        {% for item in release.metadata.fixed %}
                        <li>{{ item }}</li>
                        {% end %}
                    </ul>
                </div>
                {% end %}

                <a href="{{ release.href }}" class="changelog-read-more">
                    View full release notes â†’
                </a>
            </div>
            {% end %}
        </div>
    </section>

    {% else %}
    {# Empty State #}
    <div class="changelog-empty">
        <p>No releases yet. Check back soon!</p>
    </div>
    {% end %}


</div>
{% end %}
