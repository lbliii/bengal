{% extends "base.html" %}

{#
================================================================================
Changelog/Release Notes Template (Kida-Native)
================================================================================

Changelog and release notes section with timeline format.

MODES:
1. Data-driven: All releases in data/changelog.yaml
2. Page-driven: Each release as a separate markdown file

KIDA FEATURES USED:
- {% let %} for template-scoped variables
- Optional chaining (?.) for null-safe access
- Null coalescing (??) for smart defaults
- {% def %} for reusable release components
- {% match %} for category rendering
- {% while %} for version history traversal (Kida 2.0!)

USAGE:
Set `type: changelog` in section _index.md
================================================================================
#}

{# =============================================================================
   CHANGE CATEGORY COMPONENT
   ============================================================================= #}
{% def change_category(title, icon, items, is_breaking=false) %}
{% if items and items is iterable and items is not string and items | length > 0 %}
<div class="changelog-category{{ ' changelog-category--breaking' if is_breaking else '' }}">
  <h3 class="category-title{{ ' category-title--breaking' if is_breaking else '' }}">{{ icon }} {{ title }}</h3>
  <ul class="changelog-list{{ ' changelog-list--breaking' if is_breaking else '' }}">
    {% for item in items %}
    <li class="{{ 'changelog-item--breaking' if is_breaking else '' }}">{{ item }}</li>
    {% end %}
  </ul>
</div>
{% end %}
{% end %}

{# =============================================================================
   RELEASE ITEM COMPONENT (Data-driven)
   ============================================================================= #}
{% def release_item_data(release) %}
{% let change_types = [] %}
{% if release?.added %}{% do change_types.append('added') %}{% end %}
{% if release?.changed %}{% do change_types.append('changed') %}{% end %}
{% if release?.fixed %}{% do change_types.append('fixed') %}{% end %}
{% if release?.breaking %}{% do change_types.append('breaking') %}{% end %}
{% if release?.security %}{% do change_types.append('security') %}{% end %}

<div class="timeline-item" data-change-types="{{ change_types | join(' ') }}">
  <div class="timeline-header">
    <div class="timeline-title-group">
      <h2 class="timeline-title">
        {% if release?.url %}
        <a href="{{ release.url }}">{{ release?.version ?? 'Unknown' }}</a>
        {% else %}
        {{ release?.version ?? 'Unknown' }}
        {% end %}
      </h2>
      {% if release?.name %}
      <p class="timeline-subtitle">{{ release.name }}</p>
      {% end %}
    </div>
    <div class="timeline-meta">
      {% if release?.date %}
      <span class="timeline-date">{{ release.date }}</span>
      {% end %}
      {% if release?.status %}
      <span class="release-status status-{{ release.status | lower }}">{{ release.status }}</span>
      {% end %}
    </div>
  </div>

  {% if release?.summary %}
  <p class="timeline-description">{{ release.summary }}</p>
  {% end %}

  {{ change_category('Added', 'âœ¨', release?.added) }}
  {{ change_category('Changed', 'ğŸ”„', release?.changed) }}
  {{ change_category('Fixed', 'ğŸ›', release?.fixed) }}
  {{ change_category('Deprecated', 'âš ï¸', release?.deprecated) }}
  {{ change_category('Removed', 'ğŸ—‘ï¸', release?.removed) }}
  {{ change_category('Security', 'ğŸ”’', release?.security) }}
  {{ change_category('Breaking Changes', 'âš¡', release?.breaking, is_breaking=true) }}
</div>
{% end %}

{# =============================================================================
   RECENT MAJOR VERSION RELEASES (uses {% while %} - Kida 2.0!)

   Finds releases from the current major version series using while loop.
   Demonstrates: {% while %} with {% break %} for early termination
   ============================================================================= #}
{% def recent_major_releases(releases, max_count=5) %}
{% let result = [] %}
{% let target_major = none %}
{% let idx = 0 %}

{% while idx < releases | length and result | length < max_count %}
  {% let release = releases[idx] %}
  {% let version = release?.version ?? release?.title ?? '' %}

  {# Extract major version (e.g., "0.1" from "0.1.5") #}
  {% let parts = version | replace('v', '') | split('.') %}
  {% if parts | length >= 2 %}
    {% let this_major = parts[0] ~ '.' ~ parts[1] %}

    {# Set target on first iteration #}
    {% if not target_major %}
      {% let target_major = this_major %}
    {% end %}

    {# Stop when we hit a different major version #}
    {% if this_major != target_major %}
      {% break %}
    {% end %}

    {% let _ = result.append(release) %}
  {% end %}

  {% let idx = idx + 1 %}
{% end %}

{% if result | length > 0 %}
<aside class="recent-releases-summary">
  <h3>Recent {{ target_major }}.x Releases</h3>
  <ul class="recent-releases-list">
    {% for r in result %}
    <li>
      <a href="{{ r?.url ?? r?.href ?? '#' }}">{{ r?.version ?? r?.title }}</a>
      {% if r?.date %}
      <time>{{ r.date | dateformat('%b %d') if r.date is string else r.date }}</time>
      {% end %}
    </li>
    {% end %}
  </ul>
</aside>
{% end %}
{% end %}

{# =============================================================================
   RELEASE ITEM COMPONENT (Page-driven)
   ============================================================================= #}
{% def release_item_page(release, section) %}
{% let release_meta = release?.metadata ?? {} %}
{% let change_types = [] %}
{% if release_meta?.added %}{% do change_types.append('added') %}{% end %}
{% if release_meta?.changed %}{% do change_types.append('changed') %}{% end %}
{% if release_meta?.fixed %}{% do change_types.append('fixed') %}{% end %}
{% if release_meta?.breaking %}{% do change_types.append('breaking') %}{% end %}
{% if release_meta?.security %}{% do change_types.append('security') %}{% end %}

<div class="timeline-item" data-change-types="{{ change_types | join(' ') }}">
  <div class="timeline-header">
    <div class="timeline-title-group">
      <h2 class="timeline-title">
        <a href="{{ release?.href ?? '#' }}">{{ release?.title ?? 'Release' }}</a>
      </h2>
      {% if release_meta?.name %}
      <p class="timeline-subtitle">{{ release_meta.name }}</p>
      {% end %}
    </div>
    <div class="timeline-meta">
      {% if release?.date %}
      <time datetime="{{ release.date | date_iso }}">
        {{ release.date | dateformat('%B %d, %Y') }}
      </time>
      {% end %}
      {% if release_meta?.status %}
      <span class="release-status status-{{ release_meta.status | lower }}">{{ release_meta.status }}</span>
      {% end %}
    </div>
  </div>

  {% let release_desc = release_meta?.description ?? release_meta?.summary ?? release?.excerpt ?? '' %}
  {% if release_desc %}
  <p class="timeline-description">{{ release_desc }}</p>
  {% end %}

  {{ change_category('Added', 'âœ¨', release_meta?.added) }}
  {{ change_category('Changed', 'ğŸ”„', release_meta?.changed) }}
  {{ change_category('Fixed', 'ğŸ›', release_meta?.fixed) }}

  <a href="{{ release?.href ?? '#' }}" class="changelog-read-more">View full release notes â†’</a>
</div>
{% end %}

{# =============================================================================
   MAIN TEMPLATE
   ============================================================================= #}

{% block content %}
{# Load changelog data #}
{% let changelog_data = site?.data?.changelog ?? none %}

{# Ensure page is set for section pages - using unless for cleaner negative check #}
{% unless page %}
{% if section %}{% let page = section %}{% end %}
{% end %}

{# Template-scoped variables #}
{% let section_title = section?.title ?? page?.title ?? 'Changelog' %}
{% let section_desc = section?.metadata?.description ?? params?.description ?? '' %}
{% let blob_background = params?.blob_background ?? false %}
{% let cta_buttons = params?.cta_buttons ?? [] %}

{# Hero Section #}
{% let hero_classes = ['hero', 'hero--large'] %}
{% if blob_background %}{% do hero_classes.append('hero--blob-background') %}{% end %}

<header class="{{ hero_classes | join(' ') }}">
  {% if blob_background %}
  <div class="hero__blobs" aria-hidden="true">
    <div class="hero__blob hero__blob--1"></div>
    <div class="hero__blob hero__blob--2"></div>
    <div class="hero__blob hero__blob--3"></div>
    <div class="hero__blob hero__blob--4"></div>
  </div>
  {% end %}
  <div class="hero__container">
    <div class="hero__content">
      <h1 class="hero__title">
        <span class="fluid-text">{{ section_title }}</span>
      </h1>
      {% if section_desc %}
      <p class="hero__subtitle">{{ section_desc }}</p>
      {% end %}

      {% if cta_buttons | length > 0 %}
      <div class="hero__actions">
        {% for button in cta_buttons %}
        {% let btn_url = button?.href ?? button?.url ?? '#' %}
        {% let btn_text = button?.text ?? 'Button' %}
        {% let btn_style = button?.style ?? 'primary' %}
        <a href="{{ btn_url | absolute_url }}"
           class="hero__button hero__button--{{ btn_style }}{{ ' gradient-border' if btn_style != 'primary' else '' }}">
          {{ btn_text }}
        </a>
        {% end %}
      </div>
      {% end %}
    </div>
  </div>
</header>

<div class="changelog-container">
  {# Quick summary of recent releases using {% while %} #}
  {% if changelog_data and changelog_data?.releases %}
  {{ recent_major_releases(changelog_data.releases | reverse | list) }}
  {% elif pages | length > 0 %}
  {{ recent_major_releases(pages | reverse | list) }}
  {% end %}

  {# Content (if any) #}
  {% if content and content.strip() %}
  <section class="changelog-content prose">
    {{ content | safe }}
  </section>
  {% end %}

  {# Check for structured data to show filters #}
  {% let has_structured_data = false %}
  {% if changelog_data and changelog_data?.releases %}
  {% for release in changelog_data.releases %}
  {% if release?.added or release?.changed or release?.fixed or release?.breaking or release?.security %}
  {% let has_structured_data = true %}
  {% break %}
  {% end %}
  {% end %}
  {% elif pages %}
  {% for release in pages %}
  {% let rm = release?.metadata ?? {} %}
  {% if rm?.added or rm?.changed or rm?.fixed or rm?.breaking or rm?.security %}
  {% let has_structured_data = true %}
  {% break %}
  {% end %}
  {% end %}
  {% end %}

  {# Filter UI (only if structured data exists) #}
  {% if has_structured_data %}
  <div class="changelog-filters">
    <button class="changelog-filter-btn active" data-filter="all" aria-pressed="true">All Changes</button>
    <button class="changelog-filter-btn" data-filter="added" aria-pressed="false">âœ¨ Added</button>
    <button class="changelog-filter-btn" data-filter="changed" aria-pressed="false">ğŸ”„ Changed</button>
    <button class="changelog-filter-btn" data-filter="fixed" aria-pressed="false">ğŸ› Fixed</button>
    <button class="changelog-filter-btn" data-filter="breaking" aria-pressed="false">âš¡ Breaking</button>
    <button class="changelog-filter-btn" data-filter="security" aria-pressed="false">ğŸ”’ Security</button>
  </div>
  {% end %}

  {# Data-driven mode: Use changelog.yaml #}
  {% if changelog_data and changelog_data?.releases %}
  <section class="changelog-timeline">
    <div class="timeline">
      {% let releases = changelog_data.releases | reverse %}
      {% for release in releases %}
      {{ release_item_data(release) }}
      {% end %}
    </div>
  </section>

  {# Page-driven mode: Use individual release pages #}
  {% elif pages | length > 0 %}
  <section class="changelog-timeline">
    <div class="timeline">
      {% let section_href = section?.href ?? '' %}
      {% for release in pages | reverse %}
      {% if release?.href != section_href %}
      {{ release_item_page(release, section) }}
      {% end %}
      {% end %}
    </div>
  </section>

  {% else %}
  {# Empty State #}
  <div class="changelog-empty">
    <p>No releases yet. Check back soon!</p>
  </div>
  {% end %}
</div>
{% end %}
