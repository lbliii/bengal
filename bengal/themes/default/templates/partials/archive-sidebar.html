{#
Archive Sidebar Widget

Displays a navigable list of years/months with post counts.
Uses query indexes for O(1) lookups.

Usage:
  {% include 'partials/archive-sidebar.html' %}

Optional variables:
  - section_filter: Only show archives for a specific section (e.g., 'blog')
  - show_months: Show month breakdown (default: false)
  - title: Widget title (default: "Archives")

Example:
  {% include 'partials/archive-sidebar.html' with section_filter='blog', show_months=true %}
#}

{% set title = title | default('Archives') %}
{% set show_months = show_months | default(false) %}

<aside class="archive-sidebar-widget">
  <h3>{{ title }}</h3>

  {# Get all years from the date_range index #}
  {% set all_years = site.indexes.date_range.keys()
     | select('match', '^\\d{4}$')
     | sort(reverse=true)
     | list %}

  {% if all_years %}
    <nav class="archive-nav" aria-label="Browse by date">
      <ul class="archive-year-list">
        {% for year in all_years %}
          {# O(1) lookup for year #}
          {% set year_posts = site.indexes.date_range.get(year) | resolve_pages %}

          {# Filter by section if specified #}
          {% if section_filter %}
            {% set year_posts = year_posts | selectattr('_section.name', 'equalto', section_filter) | list %}
          {% endif %}

          {% if year_posts %}
            <li class="archive-year-item">
              {% if show_months %}
                {# Expandable year with months #}
                <details class="year-details">
                  <summary class="year-summary">
                    <span class="year-label">{{ year }}</span>
                    <span class="year-count">({{ year_posts | length }})</span>
                  </summary>

                  <ul class="archive-month-list">
                    {% for month_num in range(1, 13) %}
                      {% set month_key = year ~ '-' ~ '%02d' | format(month_num) %}
                      {% set month_posts = site.indexes.date_range.get(month_key) | resolve_pages %}

                      {# Filter by section if specified #}
                      {% if section_filter %}
                        {% set month_posts = month_posts | selectattr('_section.name', 'equalto', section_filter) | list %}
                      {% endif %}

                      {% if month_posts %}
                        <li class="archive-month-item">
                          <a href="/archive/{{ year }}/{{ '%02d' | format(month_num) }}/">
                            <span class="month-label">
                              {{ [
                                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
                              ][month_num - 1] }}
                            </span>
                            <span class="month-count">({{ month_posts | length }})</span>
                          </a>
                        </li>
                      {% endif %}
                    {% endfor %}
                  </ul>
                </details>
              {% else %}
                {# Simple year link #}
                <a href="/archive/{{ year }}/" class="year-link">
                  <span class="year-label">{{ year }}</span>
                  <span class="year-count">({{ year_posts | length }})</span>
                </a>
              {% endif %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>

    {# Optional: Show total post count #}
    <div class="archive-total">
      {% set total_posts = site.indexes.date_range.keys()
         | select('match', '^\\d{4}$')
         | map('extract', site.indexes.date_range)
         | sum(attribute='length') %}
      <p class="total-text">
        <strong>{{ total_posts }}</strong> total posts
      </p>
    </div>
  {% else %}
    <p class="no-archives">No archives available.</p>
  {% endif %}
</aside>

<style>
.archive-sidebar-widget {
  padding: 1.5rem;
  background: var(--color-surface-secondary);
  border-radius: var(--radius-md);
}

.archive-sidebar-widget h3 {
  margin: 0 0 1rem 0;
  font-size: 1.125rem;
  color: var(--color-text);
}

.archive-nav {
  margin: 0;
}

.archive-year-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.archive-year-item {
  margin-bottom: 0.5rem;
}

.year-link {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0.75rem;
  background: var(--color-surface);
  border-radius: var(--radius-sm);
  text-decoration: none;
  color: var(--color-text);
  transition: background 0.2s, color 0.2s;
}

.year-link:hover {
  background: var(--color-primary);
  color: var(--color-on-primary);
}

.year-label {
  font-weight: 500;
}

.year-count,
.month-count {
  font-size: 0.875rem;
  opacity: 0.7;
}

/* Expandable month view */
.year-details {
  background: var(--color-surface);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.year-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  list-style: none;
  user-select: none;
  transition: background 0.2s;
}

.year-summary::-webkit-details-marker {
  display: none;
}

.year-summary:hover {
  background: var(--color-surface-tertiary);
}

.year-details[open] .year-summary {
  border-bottom: 1px solid var(--color-border);
}

.archive-month-list {
  list-style: none;
  padding: 0.5rem;
  margin: 0;
}

.archive-month-item {
  margin-bottom: 0.25rem;
}

.archive-month-item a {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.375rem 0.5rem;
  border-radius: var(--radius-sm);
  text-decoration: none;
  color: var(--color-text-secondary);
  font-size: 0.875rem;
  transition: background 0.2s, color 0.2s;
}

.archive-month-item a:hover {
  background: var(--color-surface-tertiary);
  color: var(--color-text);
}

.archive-total {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--color-border);
}

.total-text {
  margin: 0;
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  text-align: center;
}

.no-archives {
  margin: 0;
  font-size: 0.875rem;
  color: var(--color-text-tertiary);
  font-style: italic;
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
  .archive-sidebar-widget {
    background: var(--color-surface);
  }

  .year-link,
  .year-details {
    background: var(--color-surface-secondary);
  }
}
</style>
