{#
Action Bar Component

PATTERN: POPOVER (see assets/COMPONENT-PATTERNS.md)
- Share dropdown and metadata panel use native [popover]
- Browser handles: show/hide, light dismiss, escape key, top layer
- JS handles: Copy actions, AI share functionality

Usage: {% include 'partials/action-bar.html' %}

Requires: page object in context
#}

{# Macro: Get page URL with fallback chain for robustness #}
{% def get_page_url(page) -%}
    {{ page._path or page.href or '/' }}
{% end %}

{% if page %}
<div class="action-bar-container">
    {# Main Action Bar #}
    <div class="action-bar">
        {# Left: Breadcrumbs #}
        <nav class="action-bar-nav" aria-label="Breadcrumb">
            {% set breadcrumb_items = get_breadcrumbs(page) %}
            {% if breadcrumb_items %}
            <ol class="action-bar-breadcrumbs">
                {% for item in breadcrumb_items %}
                <li {% if item.is_current %}aria-current="page" {% end %}>
                    {% if item.is_current %}
                    {% set has_metadata = params.author or page.date or page.content or
                    params.lastmod %}
                    <span class="action-bar-breadcrumb-current-wrapper">
                        <span class="action-bar-breadcrumb-current" title="{{ item.title }}">{{ item.title |
                            truncate(20, true, '…') }}</span>
                        {% if has_metadata %}
                        <button class="action-bar-meta-toggle" popovertarget="action-bar-metadata-popover"
                            aria-label="Toggle page metadata" title="Show page details">
                            {{ icon('caret-down', size=14, css_class='action-bar-meta-toggle-icon') }}
                        </button>
                        {% end %}
                    </span>
                    {% else %}
                    <a href="{{ item.href | absolute_url }}" class="action-bar-breadcrumb-link"
                        title="{{ item.title }}">{{ item.title | truncate(28, true, '…') }}</a>
                    {% end %}
                </li>
                {% end %}
            </ol>
            {% end %}
        </nav>

            {# Right: Actions #}
            <div class="action-bar-actions">
                {# LLM Share Button #}
                {# Use relative_url for canonical_url (canonical_url adds baseurl) #}
                {% set
                    page_url = canonical_url(get_page_url(page)),
                    llm_txt_url = ensure_trailing_slash(page_url) ~ 'index.txt',
                    share_prompt = "Please help me understand this documentation: " + llm_txt_url
                %}

            <div class="action-bar-share">
                <button class="action-bar-share-trigger" popovertarget="action-bar-share-menu"
                    aria-label="{{ t('share.ai_assistants', default='Share with AI assistants') }}" title="{{ t('share.ai_assistants', default='Share with AI assistants') }}">
                    {# Bengal cat symbol - on-brand! #}
                    <span>ᗢ</span>
                    {{ icon('caret-down', size=14, css_class='action-bar-share-chevron') }}
                </button>

                <div id="action-bar-share-menu" popover class="action-bar-share-dropdown--popover">
                    <div class="action-bar-share-content">
                        {# Quick Actions #}
                        <button class="action-bar-share-item" data-action="copy-url" data-url="{{ page_url }}" type="button">
                            {{ icon('link', size=16) }}
                            <span>{{ t('share.copy_url', default='Copy URL') }}</span>
                        </button>

                        <a href="{{ llm_txt_url }}" target="_blank" rel="noopener noreferrer"
                            class="action-bar-share-item">
                            {{ icon('external', size=16) }}
                            <span>{{ t('share.open_llm_text', default='Open LLM text') }}</span>
                        </a>

                        <button class="action-bar-share-item" data-action="copy-llm-txt" data-url="{{ llm_txt_url }}" type="button">
                            {{ icon('copy', size=16) }}
                            <span>{{ t('share.copy_llm_text', default='Copy LLM text') }}</span>
                        </button>

                        <hr class="action-bar-share-separator">

                        {# AI Assistant Links #}
                        <div class="action-bar-share-section-header">{{ t('share.with_ai', default='Share with AI') }}</div>

                        <a href="https://claude.ai/new?q={{ share_prompt | urlencode }}" target="_blank"
                            rel="noopener noreferrer" class="action-bar-share-item action-bar-share-ai" data-ai="claude">
                            {{ icon('ai-claude', size=16) }}
                            <span>{{ t('share.ask_claude', default='Ask Claude') }}</span>
                        </a>

                        <a href="https://chatgpt.com/?q={{ share_prompt | urlencode }}" target="_blank"
                            rel="noopener noreferrer" class="action-bar-share-item action-bar-share-ai"
                            data-ai="chatgpt">
                            {{ icon('ai-chatgpt', size=16) }}
                            <span>{{ t('share.ask_chatgpt', default='Ask ChatGPT') }}</span>
                        </a>

                        <a href="https://gemini.google.com/app?q={{ share_prompt | urlencode }}" target="_blank"
                            rel="noopener noreferrer" class="action-bar-share-item action-bar-share-ai" data-ai="gemini">
                            {{ icon('ai-gemini', size=16) }}
                            <span>{{ t('share.ask_gemini', default='Ask Gemini') }}</span>
                        </a>

                        <a href="https://copilot.microsoft.com/?q={{ share_prompt | urlencode }}" target="_blank"
                            rel="noopener noreferrer" class="action-bar-share-item action-bar-share-ai"
                            data-ai="copilot">
                            {{ icon('ai-copilot', size=16) }}
                            <span>{{ t('share.ask_copilot', default='Ask Copilot') }}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Expandable Metadata Panel - Native Popover #}
    {% set has_metadata = params.author or page.date or page.content or params.lastmod %}
    {% if has_metadata %}
    <div id="action-bar-metadata-popover" popover class="action-bar-metadata--popover">
        <div class="action-bar-metadata-content">
            {% if params.author and 'content.author' in theme.features %}
            <span class="action-bar-meta-item">
                {{ icon("user", size=16) }}
                <span>{{ params.author }}</span>
            </span>
            {% end %}

            {% if page.content and 'content.reading_time' in theme.features %}
            <span class="action-bar-meta-item">
                {{ icon("clock", size=16) }}
                <span>{{ t('meta.reading_time', {'time': page.content | reading_time}, default='{time} min read') }}</span>
            </span>
            {% end %}

            {% if page.content %}
            <span class="action-bar-meta-item">
                {{ icon("file-text", size=16) }}
                <span>{{ t('meta.word_count', {'count': page.content | wordcount}, default='{count} words') }}</span>
            </span>
            {% end %}

            {% if params.lastmod or page.date %}
            <span class="action-bar-meta-item">
                {{ icon("arrow-clockwise", size=16) }}
                <span>{{ t('meta.updated', {'time': (params.lastmod or page.date) | time_ago}, default='Updated {time}') }}</span>
            </span>
            {% end %}
        </div>
    </div>
    {% end %}
</div>
{% end %}
