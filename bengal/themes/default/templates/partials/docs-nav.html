{#
Documentation Navigation Component

Displays full hierarchical sidebar navigation for documentation sites.
Uses pre-computed NavTree for optimal performance.

Variables:
- page: Current page object (required)
- show_nav_icons: Whether to show section icons (default: true)

Features:
- Hierarchical tree structure via NavTree API
- Active page highlighting (automatic via NavNodeProxy)
- Active trail marking (automatic via NavTreeContext)
- Version-aware filtering (automatic via NavTreeCache)
- Keyboard accessible
- Section icons from frontmatter

Usage:
{% include 'partials/docs-nav.html' %}

Performance Note:
Uses recursive macro instead of {% include %} for ~3x faster rendering.
See: plan/drafted/rfc-benchmark-refresh-and-worker-optimization.md
#}

{# Control icon visibility - defaults to true #}
{% set show_nav_icons = show_nav_icons if show_nav_icons is defined else true %}

{#
=============================================================================
NAV NODE MACRO - Recursive navigation node renderer

Replaces the previous docs-nav-node.html include pattern.
Macros are compiled once and called as functions, eliminating the
per-call overhead of {% include %} (context copy, template lookup).

Args:
  item: NavNodeProxy to render
  depth: Current nesting depth for styling (default: 0)
=============================================================================
#}
{% def nav_node(item, depth=0) %}
{%- set item_title = item.title -%}
{%- set item_icon = item.icon -%}

{% if item.has_children %}
{# ===== ROOT NODE (depth 0) - Static header, no toggle ===== #}
{% if depth == 0 %}
<div class="docs-nav-group docs-nav-group--root{% if item.is_in_trail %} is-in-trail{% end %}" data-depth="{{ depth }}">
  <div class="docs-nav-group-header">
    {% if show_nav_icons %}
    <span class="docs-nav-icon" {% if not item_icon %}data-default="true"{% end %}>
      {{ icon(item_icon or 'folder', size=16) }}
    </span>
    {% end %}

    {% if item.href %}
    <a href="{{ item.href }}"
       class="docs-nav-group-title{% if item.is_current %} active{% end %}"
       {% if item.is_current %}aria-current="page"{% end %}>
      {{ item_title }}
    </a>
    {% else %}
    <span class="docs-nav-group-title">{{ item_title }}</span>
    {% end %}
  </div>

  <div class="docs-nav-group-items">
    {% for child in item.children %}
      {{ nav_node(child, depth + 1) }}
    {% end %}
  </div>
</div>

{% else %}
{# ===== EXPANDABLE NODE (has children, depth > 0) - Native <details>/<summary> ===== #}
<details class="docs-nav-group{% if item.is_in_trail %} is-in-trail{% end %}"
         data-depth="{{ depth }}"
         {% if item.is_in_trail %}open{% end %}>
  <summary class="docs-nav-group-summary">
    <span class="docs-nav-caret">
      {{ icon('caret-right', size=14) }}
    </span>

    {% if show_nav_icons %}
    <span class="docs-nav-icon" {% if not item_icon %}data-default="true"{% end %}>
      {{ icon(item_icon or 'folder', size=16) }}
    </span>
    {% end %}

    {% if item.href %}
    <a href="{{ item.href }}"
       class="docs-nav-group-link{% if item.is_current %} active{% end %}"
       {% if item.is_current %}aria-current="page"{% end %}>
      {{ item_title }}
    </a>
    {% else %}
    <span class="docs-nav-group-link">{{ item_title }}</span>
    {% end %}
  </summary>

  <div class="docs-nav-group-items">
    {% for child in item.children %}
      {{ nav_node(child, depth + 1) }}
    {% end %}
  </div>
</details>
{% end %}

{% else %}
{# ===== LEAF NODE (no children) ===== #}
<div class="docs-nav-group docs-nav-group--leaf" data-depth="{{ depth }}">
  {% if item.href %}
  <a href="{{ item.href }}"
     class="docs-nav-link{% if item.is_section %} docs-nav-link--section{% end %}{% if item.is_current %} active{% end %}"
     {% if item.is_current %}aria-current="page"{% end %}>
    {% if show_nav_icons and item.is_section %}
    <span class="docs-nav-icon docs-nav-icon--section" {% if not item_icon %}data-default="true"{% end %}>
      {{ icon(item_icon or 'folder', size=14) }}
    </span>
    {% end %}
    <span class="docs-nav-link-text">{{ item_title }}</span>
  </a>
  {% else %}
  <span class="docs-nav-link{% if item.is_section %} docs-nav-link--section{% end %}">
    {% if show_nav_icons and item.is_section %}
    <span class="docs-nav-icon docs-nav-icon--section" {% if not item_icon %}data-default="true"{% end %}>
      {{ icon(item_icon or 'folder', size=14) }}
    </span>
    {% end %}
    <span class="docs-nav-link-text">{{ item_title }}</span>
  </span>
  {% end %}
</div>
{% end %}
{% enddef %}

{# =============================================================================
   MAIN NAVIGATION COMPONENT
   ============================================================================= #}

{# Check if page is autodoc - autodoc pages should use scoped navigation #}
{% set is_autodoc = is_autodoc_page(page) if is_autodoc_page is defined else false %}

{# Always scope docs navigation to the page's section root.
The docs-nav template is only used by doc-type pages, so scoped navigation
is the expected behavior - docs sidebar should show docs content only,
not sibling top-level sections like releases or tracks.

nav_root: true metadata can still be used to create navigation boundaries
within a section (e.g., /api/python/ stops at itself, not /api/).
#}
{% set root_section = page._section.root if page._section else none %}

<nav class="docs-nav" aria-label="Documentation pages" data-bengal="docs-nav">
  {# Version Selector - only show if page is versioned (not autodoc) #}
  {% unless is_autodoc %}
  {% include 'partials/version-selector.html' %}
  {% end %}

  {# Navigation Tree - uses cached NavTree infrastructure #}
  <div class="docs-nav-tree">
    {% if root_section %}
    {# Scoped navigation (autodoc, nav_root sections): include root section as header #}
    {% set nav_context = get_nav_context(page, root_section=root_section) %}
    {% set root_item = nav_context['root'] %}

    {# Render root section as static header with its children #}
    <div class="docs-nav-group docs-nav-group--root{% if root_item.is_in_trail %} is-in-trail{% end %}"
      data-depth="0">
      <div class="docs-nav-group-header">
        {% if show_nav_icons %}
        <span class="docs-nav-icon" {% if not root_item.icon %}data-default="true" {% end %}>
          {{ icon(root_item.icon or 'folder', size=16) }}
        </span>
        {% end %}

        {% if root_item.href %}
        <a href="{{ root_item.href }}" class="docs-nav-group-title{% if root_item.is_current %} active{% end %}" {% if
          root_item.is_current %}aria-current="page" {% end %}>
          {{ root_item.title }}
        </a>
        {% else %}
        <span class="docs-nav-group-title">{{ root_item.title }}</span>
        {% end %}
      </div>

      <div class="docs-nav-group-items is-expanded expanded">
        {% for item in root_item.children %}
          {{ nav_node(item, 1) }}
        {% end %}
      </div>
    </div>
    {% else %}
    {# Regular navigation: render all top-level items #}
    {% set nav_items = get_nav_tree(page) %}

    {% for item in nav_items %}
      {{ nav_node(item, 0) }}
    {% end %}
    {% end %}
  </div>
</nav>
