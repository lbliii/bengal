{#
================================================================================
Documentation Navigation Component (Kida-Native)
================================================================================

Hierarchical sidebar navigation for documentation sites.
Uses pre-computed NavTree for optimal performance.

PERFORMANCE OPTIMIZATION:
Nav HTML is rendered ONCE per section and cached. Active states (current page,
active trail) are set client-side via JS based on current URL. This reduces
O(N²) template rendering to O(N) for sites with N pages.

KIDA FEATURES USED:
- {% def %} for recursive macro (3x faster than {% include %})
- {% let %} for template-scoped variables
- {% cache %} for per-section nav HTML caching
- Optional chaining (?.) for null-safe access
- Null coalescing (??) for smart defaults
- {% match %} for node type dispatch
- {% spaceless %} for clean HTML output

FEATURES:
- Hierarchical tree structure via NavTree API
- Active page highlighting (client-side via JS)
- Active trail marking (client-side via JS)
- Version-aware filtering (automatic via NavTreeCache)
- Keyboard accessible
- Section icons from frontmatter

USAGE:
{% include 'partials/docs-nav.html' %}
================================================================================
#}

{# Control icon visibility - defaults to true if not passed in context #}
{% let show_nav_icons = show_nav_icons ?? true %}

{# =============================================================================
NAV NODE MACRO - Recursive navigation node renderer

Replaces the previous docs-nav-node.html include pattern.
Macros are compiled once and called as functions, eliminating the
per-call overhead of {% include %} (context copy, template lookup).

PERF: Active states (is_current, is_in_trail) are NOT rendered here.
Instead, we add data-nav-path attributes and let JS set active states.
This allows the nav HTML to be cached per-section instead of per-page.
============================================================================= #}

{% def nav_node(item, depth=0) %}
{# Extract values once with null-safe access #}
{% let item_title = item?.title ?? 'Untitled' %}
{% let item_icon = item?.icon ?? '' %}
{% let item_href = item?.href ?? '' %}
{% let item_path = item?._path ?? item_href %}
{% let item_children = item?.children ?? [] %}
{% let is_section = item?.is_section ?? false %}
{% let has_children = item_children | length > 0 %}

{% match has_children, depth %}
{# ===== ROOT NODE (depth 0) - Static header, no toggle ===== #}
{% case true, 0 %}
<div class="docs-nav-group docs-nav-group--root" data-depth="{{ depth }}" data-nav-path="{{ item_path }}">
  <div class="docs-nav-group-header">
    {% if show_nav_icons %}
    {% spaceless %}
    <span class="docs-nav-icon" {{ ' data-default="true"' | safe if not item_icon else '' }}>
      {{ icon(item_icon ?? 'folder', size=16) }}
    </span>
    {% end %}
    {% end %}

    {% if item_href %}
    <a href="{{ item_href }}" class="docs-nav-group-title" data-nav-path="{{ item_path }}">
      {{ item_title }}
    </a>
    {% else %}
    <span class="docs-nav-group-title">{{ item_title }}</span>
    {% end %}
  </div>

  <div class="docs-nav-group-items is-expanded expanded">
    {% for child in item_children %}
    {{ nav_node(child, depth + 1) }}
    {% end %}
  </div>
</div>

{# ===== EXPANDABLE NODE (depth > 0) - CSS-only accessible toggle ===== #}
    {# Uses <details>/<summary> for native toggle + CSS :has() to control sibling visibility.
       The <a> link is OUTSIDE <summary> (as a sibling), avoiding nested interactive elements.
       CSS Grid arranges: [toggle] [icon] [link] on first row, [items] spanning full width below.
       NOTE: <details> starts closed; JS opens parents of active link on page load. #}
    {% case true, _ %}
    <div class="docs-nav-group" data-depth="{{ depth }}" data-nav-path="{{ item_path }}">
      <details class="docs-nav-details">
        <summary class="docs-nav-toggle" aria-label="Toggle {{ item_title }} section">
          <span class="docs-nav-caret">
            {{ icon('caret-right', size=14) }}
          </span>
        </summary>
      </details>

      {% if show_nav_icons %}
      {% spaceless %}
      <span class="docs-nav-icon" {{ ' data-default="true"' | safe if not item_icon else '' }}>
        {{ icon(item_icon ?? 'folder', size=16) }}
      </span>
      {% end %}
      {% end %}

      {% if item_href %}
      <a href="{{ item_href }}" class="docs-nav-group-link" data-nav-path="{{ item_path }}">
        {{ item_title }}
      </a>
      {% else %}
      <span class="docs-nav-group-link">{{ item_title }}</span>
      {% end %}

      <div class="docs-nav-group-items">
        {% for child in item_children %}
        {{ nav_node(child, depth + 1) }}
        {% end %}
      </div>
    </div>

    {# ===== LEAF NODE (no children) ===== #}
    {% case false, _ %}
    <div class="docs-nav-group docs-nav-group--leaf" data-depth="{{ depth }}">
      {% if item_href %}
      <a href="{{ item_href }}"
        class="docs-nav-link{{ ' docs-nav-link--section' if is_section else '' }}"
        data-nav-path="{{ item_path }}">
        {% if show_nav_icons and is_section %}
        {% spaceless %}
        <span class="docs-nav-icon docs-nav-icon--section" {{ ' data-default="true"' | safe if not item_icon else '' }}>
          {{ icon(item_icon ?? 'folder', size=14) }}
        </span>
        {% end %}
        {% end %}
        <span class="docs-nav-link-text">{{ item_title }}</span>
      </a>
      {% else %}
      <span class="docs-nav-link{{ ' docs-nav-link--section' if is_section else '' }}">
        {% if show_nav_icons and is_section %}
        {% spaceless %}
        <span class="docs-nav-icon docs-nav-icon--section" {{ ' data-default="true"' | safe if not item_icon else '' }}>
          {{ icon(item_icon ?? 'folder', size=14) }}
        </span>
        {% end %}
        {% end %}
        <span class="docs-nav-link-text">{{ item_title }}</span>
      </span>
      {% end %}
    </div>
    {% end %}
    {% end %}

    {# =============================================================================
    MAIN NAVIGATION COMPONENT

    PERF: Nav HTML is cached per-section. Active states are set client-side.
    This reduces O(N²) rendering to O(N) for N pages in a section.

    Cache key: "docs-nav-{section_path}-{nav_version}"
    - section_path: Root section path for scoped nav (e.g., "docs", "api")
    - nav_version: Invalidates when nav structure changes (content/config edits)
    ============================================================================= #}

    {# Check if page is autodoc - autodoc pages should use scoped navigation #}
    {% let is_autodoc = is_autodoc_page(page) if is_autodoc_page is defined else false %}

    {#
    Always scope docs navigation to the page's section root.
    The docs-nav template is only used by doc-type pages, so scoped navigation
    is the expected behavior - docs sidebar should show docs content only,
    not sibling top-level sections like releases or tracks.

    nav_root: true metadata can still be used to create navigation boundaries
    within a section (e.g., /api/python/ stops at itself, not /api/).
    #}
    {% let page_section = page?._section %}
    {% let root_section = page_section?.root ?? none %}
    {% let current_path = page?._path ?? '' %}

    {# Cache key components #}
    {% let section_key = root_section?._path ?? 'site-root' %}
    {% let nav_version = site.nav_version ?? '' %}

    <nav class="docs-nav" aria-label="Documentation pages" data-bengal="docs-nav" data-current-path="{{ current_path }}">
      {# Version Selector - only show if page is versioned (not autodoc) #}
      {% unless is_autodoc %}
      {% include 'partials/version-selector.html' %}
      {% end %}

      {# Navigation Tree - CACHED per section for O(1) reuse across pages #}
      <div class="docs-nav-tree">
        {% cache 'docs-nav-' ~ section_key ~ '-' ~ nav_version %}
        {% if root_section %}
        {# Scoped navigation: include root section as header #}
        {% let nav_context = get_nav_context(page, root_section=root_section) %}
        {% with nav_context?.root as root_item %}
        {{ nav_node(root_item, 0) }}
        {% end %}
        {% else %}
        {# Regular navigation: render all top-level items #}
        {% let nav_items = get_nav_tree(page) ?? [] %}
        {% for item in nav_items %}
        {{ nav_node(item, 0) }}
        {% end %}
        {% end %}
        {% endcache %}
      </div>
    </nav>
