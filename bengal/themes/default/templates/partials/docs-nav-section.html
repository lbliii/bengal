{#
Documentation Navigation Section Component (Recursive)

Renders an individual section with pages and subsections in the docs nav tree.

Variables:
- section: Section object to render (required)
- section.title: Section title
- section.url: Section URL
- section.icon: Section icon from frontmatter (optional)
- section.index_page: Section index page (optional)
- section.sorted_pages: Pages in section (pre-sorted by weight)
- section.sorted_subsections: Subsections (pre-sorted by weight)
- section.has_nav_children: Whether section has navigable children
- depth: Current nesting depth for styling (required)
- page: Current page object (for active highlighting)
- show_nav_icons: Whether to show section icons (default: true)

Features:
- Collapsible section with toggle button (only when has children)
- Simple link rendering for leaf sections (no children)
- Clickable section header (links to index page)
- Active page highlighting
- Recursive rendering of subsections
- Smart title display (extracts short names from dotted titles)
- Section icons from frontmatter (directories only, not pages)

Note:
This component calls itself recursively for subsections.
Included by 'partials/docs-nav.html'.

Usage:
{% set depth = 0 %}
{% include 'partials/docs-nav-section.html' %}
#}

{# Normalize current page URL once for all comparisons #}
{% set current_url = page.relative_url.rstrip('/') if (page is defined and page and page.relative_url) else '' %}
{% set section_title = section.nav_title or section.title if section.title and section.title.strip() else (section.slug.replace('-', ' ').replace('_', ' ').title() if section.slug else 'Section') %}
{% set section_url_normalized = section.index_page.relative_url.rstrip('/') if (section.index_page and section.index_page.relative_url) else '' %}
{% set is_active = (page is defined and page and current_url == section_url_normalized) %}
{% set section_icon = section.icon if section.icon else none %}
{# Control icon visibility - defaults to true, can be overridden by template #}
{% set show_nav_icons = show_nav_icons if show_nav_icons is defined else true %}

{% if section.has_nav_children %}
{# ===== EXPANDABLE SECTION (has children) ===== #}
<div class="docs-nav-group" data-depth="{{ depth }}">
  {# Section Toggle Button - with link functionality #}
  <div class="docs-nav-group-toggle-wrapper">
    <button class="docs-nav-group-toggle" aria-expanded="false" aria-controls="nav-section-{{ section.url | slugify }}">
      {{ icon('caret-right', size=14) }}
    </button>

    {# Section Icon (from frontmatter) #}
    {% if show_nav_icons %}
    <span class="docs-nav-icon" {% if not section_icon %}data-default="true"{% endif %}>
      {{ icon(section_icon or 'folder', size=16) }}
    </span>
    {% endif %}

    {% if section.index_page %}
    <a href="{{ section.index_page.url }}"
      class="docs-nav-group-link {% if is_active %}active{% endif %}"
      {% if is_active %}aria-current="page"{% endif %}>
      {{ section_title }}
    </a>
    {% else %}
    <span class="docs-nav-group-link">{{ section_title }}</span>
    {% endif %}
  </div>

  {# Section Items (collapsible children) #}
  <div class="docs-nav-group-items" id="nav-section-{{ section.url | slugify }}">
    {# Get current version ID for filtering #}
    {% set current_version_id = current_version.id if (current_version is defined and current_version) else (page.version if (page is defined and page and page.version) else none) %}

    {# Cache sorted lists for O(1) access - computed once per section #}
    {# Filter pages and subsections by current version if versioning is enabled #}
    {% if current_version_id and site.versioning_enabled %}
      {% set section_sorted_pages = section.sorted_pages | selectattr('version', 'equalto', current_version_id) | list %}
      {# Filter subsections to only those that have pages from current version #}
      {% set filtered_subsections = [] %}
      {% for subsection in section.sorted_subsections %}
        {# Include subsection if its index page matches current version, or if it has any pages from current version #}
        {% set has_versioned_content = false %}
        {% if subsection.index_page and subsection.index_page.version == current_version_id %}
          {% set has_versioned_content = true %}
        {% else %}
          {% for p in subsection.sorted_pages %}
            {% if p.version == current_version_id %}
              {% set has_versioned_content = true %}
              {% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% if has_versioned_content %}
          {% set _ = filtered_subsections.append(subsection) %}
        {% endif %}
      {% endfor %}
      {% set section_sorted_subsections = filtered_subsections %}
    {% else %}
      {% set section_sorted_pages = section.sorted_pages %}
      {% set section_sorted_subsections = section.sorted_subsections %}
    {% endif %}
    {% set section_index_url = section.index_page.relative_url if section.index_page else none %}

    {# Regular pages in this section (excluding index page) - sorted by weight #}
    {% for p in section_sorted_pages %}
    {# Skip autodoc pages (they belong in /api/ or /cli/ sections, not docs nav) #}
    {% set page_type = p.metadata.get('type', '') %}
    {% set is_autodoc = page_type.startswith('autodoc-') or page_type.startswith('python-') or page_type.startswith('cli-') or page_type.startswith('openapi-') or p.metadata.get('generator') == 'bengal-autodoc' %}
    {% if p.relative_url != section_index_url and p.title and not is_autodoc %}
    {# Use nav_title if available, otherwise extract short name for nested items #}
    {% set base_title = p.nav_title or p.title %}
    {% set display_title = base_title.split('.')[-1] if ('.' in base_title) else base_title %}
    {% set p_url_normalized = p.relative_url.rstrip('/') if p.relative_url else '' %}
    {% set p_is_active = (page is defined and page and current_url == p_url_normalized) %}
    <a href="{{ p.url }}"
      class="docs-nav-link {% if p_is_active %}active{% endif %}"
      {% if p_is_active %}aria-current="page"{% endif %}>
      {{ display_title }}
    </a>
    {% endif %}
    {% endfor %}

    {# Subsections (recursive) - sorted by weight #}
    {% for subsection in section_sorted_subsections %}
    {% set section = subsection %}
    {% set depth = depth + 1 %}
    {% include 'partials/docs-nav-section.html' %}
    {% endfor %}
  </div>
</div>

{% else %}
{# ===== LEAF SECTION (no children) - render as simple link ===== #}
<div class="docs-nav-group docs-nav-group--leaf" data-depth="{{ depth }}">
  {% if section.index_page %}
  <a href="{{ section.index_page.url }}"
    class="docs-nav-link docs-nav-link--section {% if is_active %}active{% endif %}"
    {% if is_active %}aria-current="page"{% endif %}>
    {# Leaf Section Icon (from frontmatter) #}
    {% if show_nav_icons %}
    <span class="docs-nav-icon docs-nav-icon--section" {% if not section_icon %}data-default="true"{% endif %}>
      {{ icon(section_icon or 'folder', size=14) }}
    </span>
    {% endif %}
    <span class="docs-nav-link-text">{{ section_title }}</span>
  </a>
  {% else %}
  <span class="docs-nav-link docs-nav-link--section">
    {# Leaf Section Icon (from frontmatter) #}
    {% if show_nav_icons %}
    <span class="docs-nav-icon docs-nav-icon--section" {% if not section_icon %}data-default="true"{% endif %}>
      {{ icon(section_icon or 'folder', size=14) }}
    </span>
    {% endif %}
    <span class="docs-nav-link-text">{{ section_title }}</span>
  </span>
  {% endif %}
</div>
{% endif %}
