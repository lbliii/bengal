{#
  Enhanced Table of Contents Sidebar
  
  Displays:
  - Scroll progress indicator
  - Table of contents with active tracking
  - Page metadata (last updated, edit link, etc.)
  - Optional: Contributors, tags, etc.
  
  Features:
  - Scroll progress bar
  - Active item highlighting
  - Smooth scroll to sections
  - Edit on GitHub link (if configured)
#}

<div class="toc-sidebar">
  {# TOC Header #}
  <div class="toc-header">
    <h3 class="toc-title">On This Page</h3>
  </div>
  
  {# Scroll Progress Indicator #}
  <div class="toc-progress" aria-hidden="true">
    <div class="toc-progress-bar"></div>
  </div>
  
  {# Table of Contents #}
  <nav class="toc-nav" aria-label="Table of contents">
    {% if toc_items %}
    <ul class="toc-items">
      {% for item in toc_items %}
      <li class="toc-item toc-level-{{ item.level }}">
        <a href="#{{ item.id }}" class="toc-link" data-toc-item="#{{ item.id }}">
          {{ item.title }}
        </a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    {# Fallback to HTML TOC #}
    <div class="toc-content">
      {{ toc | safe }}
    </div>
    {% endif %}
  </nav>
  
  {# Page Metadata Section #}
  <div class="toc-metadata">
    {# Last Updated #}
    {% if page.date %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <div>
        <div class="toc-meta-label">Last updated</div>
        <time datetime="{{ page.date | date_iso }}" class="toc-meta-value">
          {{ page.date | time_ago }}
        </time>
      </div>
    </div>
    {% endif %}
    
    {# Edit on GitHub (if configured) #}
    {% if page.metadata.edit_url or site.config.github_edit_base %}
    <a 
      href="{% if page.metadata.edit_url %}{{ page.metadata.edit_url }}{% else %}{{ site.config.github_edit_base }}{{ page.source_path }}{% endif %}" 
      class="toc-edit-link"
      target="_blank"
      rel="noopener noreferrer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      <span>Edit this page</span>
    </a>
    {% endif %}
    
    {# Contributors (if configured) #}
    {% if page.metadata.contributors %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      <div>
        <div class="toc-meta-label">Contributors</div>
        <div class="toc-meta-value">{{ page.metadata.contributors | join(', ') }}</div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
/* TOC Sidebar Container */
.toc-sidebar {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* TOC Header */
.toc-header {
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--color-border-light);
}

.toc-title {
  margin: 0;
  font-size: var(--text-sm);
  font-weight: var(--font-weight-semibold);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
}

/* Scroll Progress Indicator */
.toc-progress {
  position: relative;
  width: 2px;
  height: 100%;
  background: var(--color-border-light);
  border-radius: 1px;
  overflow: hidden;
}

.toc-progress-bar {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 0%;
  background: var(--color-primary);
  transition: height 0.1s linear;
}

/* TOC Navigation */
.toc-nav {
  flex: 1;
  min-height: 0;
}

.toc-items {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.125rem;
}

.toc-item {
  margin: 0;
}

.toc-link {
  display: block;
  padding: 0.375rem 0.75rem;
  font-size: var(--text-sm);
  line-height: 1.5;
  color: var(--color-text-secondary);
  text-decoration: none;
  border-left: 2px solid transparent;
  margin-left: -2px;
  border-radius: var(--border-radius-small);
  transition: all var(--transition-fast);
}

.toc-link:hover {
  color: var(--color-text-primary);
  background: var(--color-bg-hover);
}

.toc-link.active {
  color: var(--color-primary);
  font-weight: var(--font-weight-medium);
  border-left-color: var(--color-primary);
  background: var(--color-primary-light);
}

[data-theme="dark"] .toc-link.active {
  background: rgba(33, 150, 243, 0.15);
}

/* Heading Levels */
.toc-level-2 .toc-link {
  padding-left: 0.75rem;
}

.toc-level-3 .toc-link {
  padding-left: 1.5rem;
  font-size: var(--text-xs);
}

.toc-level-4 .toc-link {
  padding-left: 2.25rem;
  font-size: var(--text-xs);
}

/* TOC Content (Fallback HTML) */
.toc-content {
  font-size: var(--text-sm);
}

.toc-content ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.toc-content li {
  margin: 0;
}

.toc-content ul ul {
  padding-left: 0.75rem;
  margin-top: 0.25rem;
}

.toc-content a {
  display: block;
  padding: 0.375rem 0.75rem;
  color: var(--color-text-secondary);
  text-decoration: none;
  border-left: 2px solid transparent;
  margin-left: -2px;
  transition: all var(--transition-fast);
  border-radius: var(--border-radius-small);
}

.toc-content a:hover {
  color: var(--color-text-primary);
  background: var(--color-bg-hover);
}

.toc-content a.active {
  color: var(--color-primary);
  font-weight: var(--font-weight-medium);
  border-left-color: var(--color-primary);
  background: var(--color-primary-light);
}

/* Page Metadata */
.toc-metadata {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding-top: 1rem;
  border-top: 1px solid var(--color-border-light);
  font-size: var(--text-xs);
}

.toc-meta-item {
  display: flex;
  gap: 0.5rem;
  color: var(--color-text-secondary);
}

.toc-meta-item svg {
  flex-shrink: 0;
  margin-top: 0.125rem;
}

.toc-meta-label {
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-tertiary);
  margin-bottom: 0.125rem;
}

.toc-meta-value {
  color: var(--color-text-secondary);
}

/* Edit Link */
.toc-edit-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  font-size: var(--text-xs);
  font-weight: var(--font-weight-medium);
  color: var(--color-text-secondary);
  text-decoration: none;
  background: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius-small);
  transition: all var(--transition-fast);
}

.toc-edit-link:hover {
  color: var(--color-primary);
  border-color: var(--color-primary);
  background: var(--color-bg-hover);
}

.toc-edit-link svg {
  flex-shrink: 0;
}
</style>

<script>
(function() {
  'use strict';
  
  // Only run if we have TOC items
  const tocItems = document.querySelectorAll('[data-toc-item]');
  const progressBar = document.querySelector('.toc-progress-bar');
  
  if (!tocItems.length) return;
  
  // Get all heading targets
  const headings = Array.from(tocItems).map(item => {
    const id = item.getAttribute('data-toc-item').slice(1);
    return document.getElementById(id);
  }).filter(Boolean);
  
  if (!headings.length) return;
  
  // Update active item and progress on scroll
  function updateActive() {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = Math.min((scrollTop / docHeight) * 100, 100);
    
    // Update progress bar
    if (progressBar) {
      progressBar.style.height = `${progress}%`;
    }
    
    // Find active heading (closest one above viewport)
    let activeIndex = 0;
    for (let i = headings.length - 1; i >= 0; i--) {
      const heading = headings[i];
      if (heading && heading.offsetTop <= scrollTop + 100) {
        activeIndex = i;
        break;
      }
    }
    
    // Update active class on TOC items
    tocItems.forEach((item, index) => {
      if (index === activeIndex) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
  }
  
  // Smooth scroll to heading
  tocItems.forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const id = item.getAttribute('data-toc-item').slice(1);
      const target = document.getElementById(id);
      
      if (target) {
        const offsetTop = target.offsetTop - 100; // Account for header
        window.scrollTo({
          top: offsetTop,
          behavior: 'smooth'
        });
        
        // Update URL
        history.pushState(null, '', '#' + id);
      }
    });
  });
  
  // Throttled scroll handler for performance
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActive();
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });
  
  // Initial update
  updateActive();
})();
</script>

