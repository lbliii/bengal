{#
  Table of Contents Sidebar Component

  Interactive table of contents with progress tracking, collapsible sections, and page metadata.

  Variables:
    - toc_items: List of TOC items with id, title, level (required)
    - toc: HTML TOC fallback (optional)
    - page: Current page object (for metadata)
    - page.date: Last updated date
    - page.metadata.edit_url: Custom edit URL
    - page.metadata.contributors: List of contributor names
    - page.source_path: Source file path (for GitHub edit)
    - site.config.github_edit_base: Base URL for GitHub edit links

  Template Functions Used:
    - get_toc_grouped(toc_items): Groups TOC items into collapsible sections

  Features:
    - Scroll progress indicator
    - Collapsible H2 sections with item counts
    - Active item highlighting with auto-expand
    - Settings menu (expand all, collapse all)
    - Page metadata display (last updated, contributors)
    - Edit on GitHub link
    - Keyboard navigation support

  Usage:
    {% include 'partials/toc-sidebar.html' %}

  CSS: bengal/themes/default/assets/css/components/toc.css
  JS: bengal/themes/default/assets/js/toc.js
#}

<div class="toc-sidebar">
  {# TOC Header - Minimal #}
  <div class="toc-header">
    <h3 class="toc-title">On This Page</h3>
    <button
      class="toc-settings-btn"
      data-toc-action="toggle-settings"
      title="TOC settings"
      aria-label="TOC settings"
      aria-expanded="false">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="12" cy="5" r="1"></circle>
        <circle cx="12" cy="19" r="1"></circle>
      </svg>
    </button>
    {# Settings dropdown (hidden by default) #}
    <div class="toc-settings-menu" hidden>
      <button data-toc-action="expand-all">Expand all</button>
      <button data-toc-action="collapse-all">Collapse all</button>
    </div>
  </div>

  {# Scroll Progress Indicator - Subtle #}
  <div class="toc-progress" aria-hidden="true">
    <div class="toc-progress-bar"></div>
  </div>

  {# Table of Contents #}
  <nav class="toc-nav" aria-label="Table of contents" data-toc-mode="normal">
    {% if toc_items %}
    <div class="toc-scroll-container">
      <ul class="toc-items" role="tree">
        {#
          Use get_toc_grouped() to handle all grouping logic in Python.
          This replaces 80+ lines of complex template logic with a clean iteration.
          See: bengal/rendering/template_functions/navigation.py
        #}
        {% for group in get_toc_grouped(toc_items) %}
          {% if group.is_group %}
            {# Group with children (collapsible section) #}
            <li class="toc-item toc-group" role="treeitem" data-level="1" data-collapsed="true">
              <div class="toc-group-header">
                <a href="#{{ group.header.id }}" class="toc-link toc-link-h2" data-toc-item="#{{ group.header.id }}">
                  {{ group.header.title }}
                </a>
                <button
                  class="toc-group-toggle toc-count-toggle"
                  aria-expanded="false"
                  aria-label="Toggle {{ group.children|length }} subsections"
                  title="Click to expand {{ group.children|length }} subsections">
                  <span class="toc-count">{{ group.children|length }}</span>
                </button>
              </div>
              <ul class="toc-subitems" role="group">
                {% for child in group.children %}
                  <li class="toc-item toc-level-{{ child.level }}" role="treeitem" data-level="{{ child.level }}">
                    <a href="#{{ child.id }}" class="toc-link" data-toc-item="#{{ child.id }}">
                      {{ child.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% else %}
            {# Standalone item (no children) #}
            <li class="toc-item toc-level-{{ group.header.level }}" role="treeitem" data-level="{{ group.header.level }}">
              <a href="#{{ group.header.id }}" class="toc-link" data-toc-item="#{{ group.header.id }}">
                {{ group.header.title }}
              </a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% else %}
    {# Fallback to HTML TOC #}
    <div class="toc-content">
      {{ toc | safe }}
    </div>
    {% endif %}
  </nav>

  {# Page Metadata Section #}
  <div class="toc-metadata">
    {# Last Updated #}
    {% if page.date %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <div>
        <div class="toc-meta-label">Last updated</div>
        <time datetime="{{ page.date | date_iso }}" class="toc-meta-value">
          {{ page.date | time_ago }}
        </time>
      </div>
    </div>
    {% endif %}

    {# Edit on GitHub (if configured) #}
    {% if page.metadata.edit_url or site.config.github_edit_base %}
    <a
      href="{% if page.metadata.edit_url %}{{ page.metadata.edit_url }}{% else %}{{ site.config.github_edit_base }}{{ page.source_path }}{% endif %}"
      class="toc-edit-link"
      target="_blank"
      rel="noopener noreferrer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      <span>Edit this page</span>
    </a>
    {% endif %}

    {# Contributors (if configured) #}
    {% if page.metadata.contributors %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      <div>
        <div class="toc-meta-label">Contributors</div>
        <div class="toc-meta-value">{{ page.metadata.contributors | join(', ') }}</div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{#
  CSS: bengal/themes/default/assets/css/components/toc.css
  JS:  bengal/themes/default/assets/js/toc.js (loaded via main template)
#}
