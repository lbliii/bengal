{#
  Enhanced Table of Contents Sidebar with Intelligent Grouping
  
  Displays:
  - Scroll progress indicator
  - Hierarchical table of contents with smart grouping
  - Collapsible sections for better navigation
  - Page metadata (last updated, edit link, etc.)
  - Optional: Contributors, tags, etc.
  
  Features:
  - Scroll progress bar with position indicator
  - Active item highlighting with auto-expand
  - Collapsible H2 sections with nested items
  - Smart section management (auto-expand active, collapse inactive)
  - Smooth scroll to sections
  - Keyboard navigation support
  - Section item counts
  - Quick jump navigation (top/bottom)
  - Compact mode toggle for deeply nested content
  - Edit on GitHub link (if configured)
#}

<div class="toc-sidebar">
  {# TOC Header - Minimal #}
  <div class="toc-header">
    <h3 class="toc-title">On This Page</h3>
    <button 
      class="toc-settings-btn" 
      data-toc-action="toggle-settings"
      title="TOC settings"
      aria-label="TOC settings"
      aria-expanded="false">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="12" cy="5" r="1"></circle>
        <circle cx="12" cy="19" r="1"></circle>
      </svg>
    </button>
    {# Settings dropdown (hidden by default) #}
    <div class="toc-settings-menu" hidden>
      <button data-toc-action="expand-all">Expand all</button>
      <button data-toc-action="collapse-all">Collapse all</button>
    </div>
  </div>
  
  {# Scroll Progress Indicator - Subtle #}
  <div class="toc-progress" aria-hidden="true">
    <div class="toc-progress-bar"></div>
  </div>
  
  {# Table of Contents #}
  <nav class="toc-nav" aria-label="Table of contents" data-toc-mode="normal">
    {% if toc_items %}
    <div class="toc-scroll-container">
      <ul class="toc-items" role="tree">
        {# Group items by H2 sections (level 1 in the depth-based TOC structure) #}
        {% set current_h2 = namespace(item=none, children=[]) %}
        {% for item in toc_items %}
          {% if item.level == 1 %}
            {# Render previous H2 group if exists #}
            {% if current_h2.item %}
              <li class="toc-item toc-group" role="treeitem" data-level="1" data-collapsed="true">
                <div class="toc-group-header">
                  <button 
                    class="toc-group-toggle" 
                    aria-expanded="false"
                    aria-label="Toggle section: {{ current_h2.item.title }}">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="toc-chevron">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </button>
                  <a href="#{{ current_h2.item.id }}" class="toc-link toc-link-h2" data-toc-item="#{{ current_h2.item.id }}">
                    {{ current_h2.item.title }}
                  </a>
                  {% if current_h2.children|length > 0 %}
                  <span class="toc-count" aria-label="{{ current_h2.children|length }} subsections">{{ current_h2.children|length }}</span>
                  {% endif %}
                </div>
                {% if current_h2.children|length > 0 %}
                <ul class="toc-subitems" role="group">
                  {% for child in current_h2.children %}
                  <li class="toc-item toc-level-{{ child.level }}" role="treeitem" data-level="{{ child.level }}">
                    <a href="#{{ child.id }}" class="toc-link" data-toc-item="#{{ child.id }}">
                      {{ child.title }}
                    </a>
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </li>
            {% endif %}
            {# Start new H2 group #}
            {% set current_h2.item = item %}
            {% set current_h2.children = [] %}
          {% elif item.level > 1 %}
            {# Add to current H2 group #}
            {% set _ = current_h2.children.append(item) %}
          {% else %}
            {# Standalone H1 or other top-level item #}
            <li class="toc-item toc-level-{{ item.level }}" role="treeitem" data-level="{{ item.level }}">
              <a href="#{{ item.id }}" class="toc-link" data-toc-item="#{{ item.id }}">
                {{ item.title }}
              </a>
            </li>
          {% endif %}
        {% endfor %}
        
        {# Render final H2 group if exists #}
        {% if current_h2.item %}
          <li class="toc-item toc-group" role="treeitem" data-level="1" data-collapsed="true">
            <div class="toc-group-header">
              <button 
                class="toc-group-toggle" 
                aria-expanded="false"
                aria-label="Toggle section: {{ current_h2.item.title }}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="toc-chevron">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              <a href="#{{ current_h2.item.id }}" class="toc-link toc-link-h2" data-toc-item="#{{ current_h2.item.id }}">
                {{ current_h2.item.title }}
              </a>
              {% if current_h2.children|length > 0 %}
              <span class="toc-count" aria-label="{{ current_h2.children|length }} subsections">{{ current_h2.children|length }}</span>
              {% endif %}
            </div>
            {% if current_h2.children|length > 0 %}
            <ul class="toc-subitems" role="group">
              {% for child in current_h2.children %}
              <li class="toc-item toc-level-{{ child.level }}" role="treeitem" data-level="{{ child.level }}">
                <a href="#{{ child.id }}" class="toc-link" data-toc-item="#{{ child.id }}">
                  {{ child.title }}
                </a>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </li>
        {% endif %}
      </ul>
    </div>
    {% else %}
    {# Fallback to HTML TOC #}
    <div class="toc-content">
      {{ toc | safe }}
    </div>
    {% endif %}
  </nav>
  
  {# Page Metadata Section #}
  <div class="toc-metadata">
    {# Last Updated #}
    {% if page.date %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <div>
        <div class="toc-meta-label">Last updated</div>
        <time datetime="{{ page.date | date_iso }}" class="toc-meta-value">
          {{ page.date | time_ago }}
        </time>
      </div>
    </div>
    {% endif %}
    
    {# Edit on GitHub (if configured) #}
    {% if page.metadata.edit_url or site.config.github_edit_base %}
    <a 
      href="{% if page.metadata.edit_url %}{{ page.metadata.edit_url }}{% else %}{{ site.config.github_edit_base }}{{ page.source_path }}{% endif %}" 
      class="toc-edit-link"
      target="_blank"
      rel="noopener noreferrer">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
      <span>Edit this page</span>
    </a>
    {% endif %}
    
    {# Contributors (if configured) #}
    {% if page.metadata.contributors %}
    <div class="toc-meta-item">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
      <div>
        <div class="toc-meta-label">Contributors</div>
        <div class="toc-meta-value">{{ page.metadata.contributors | join(', ') }}</div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{#
  CSS: bengal/themes/default/assets/css/components/toc.css
  JS:  bengal/themes/default/assets/js/toc.js (loaded via main template)
#}

