{#
Version Selector Component

Displays a dropdown to switch between documentation versions.
Only renders when versioning is enabled.

Available context:
- versioning_enabled: bool - Whether versioning is enabled
- versions: list[dict] - All versions with id, label, latest, url_prefix
- current_version: dict|None - Current page's version info
- is_latest_version: bool - Whether current page is latest version

Usage in templates:
{% include "partials/version-selector.html" %}

Customization:
Override this partial in your theme to customize the version selector.
You can also style it using CSS class: .version-selector

Engine-Agnostic:
Uses site.get_version_target_url() method which works with any template
engine (Jinja2, Mako, or BYORenderer). No global function dependency.
#}

{# Only show version selector if:
1. Versioning is enabled
2. There are multiple versions
3. The current page is actually versioned (has a version attribute)
4. The page is not an autodoc page (autodoc pages are not versioned)
#}
{% set is_autodoc = is_autodoc_page(page) if is_autodoc_page is defined else false %}
{% set page_is_versioned = page.version is defined and page.version is not none %}
{% if versioning_enabled and versions | length > 1 and page_is_versioned and not is_autodoc %}
<div class="version-selector">
  <label for="version-select" class="version-selector__label">
    <span class="visually-hidden">Documentation Version</span>
    {# Icon for version indicator #}
    <svg class="version-selector__icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
      <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
        stroke-linejoin="round" />
    </svg>
  </label>

  {#
  Smart Version Selector with Pre-computed Fallback URLs

  Each option has a data-target attribute containing the best URL
  to navigate to in that version. This is computed at build time,
  so switching versions is instant with no 404 errors.

  Fallback cascade (computed at build time):
  1. Exact equivalent page exists → use it
  2. Section index exists → use section index
  3. Version root → use version root

  This approach is better than any major static SSG (Docusaurus,
  MkDocs, etc.) which all show 404 errors when switching versions.
  #}
  <select id="version-select" class="version-selector__select" onchange="handleVersionChange(this.selectedOptions[0])"
    aria-label="Select documentation version">
    {% for v in versions %}
    <option value="{{ v.url_prefix or '/' }}" data-target="{{ site.get_version_target_url(page, v) }}" {% if
      current_version and current_version.id==v.id %}selected{% endif %} {% if v.deprecated %}class="version-deprecated"
      {% endif %}>
      {{ v.label }}{% if v.latest %} (Latest){% endif %}{% if v.deprecated %} ⚠️{% endif %}
    </option>
    {% endfor %}
  </select>

  {# Version badge showing current version #}
  {% if current_version %}
  <span class="version-selector__badge{% if not is_latest_version %} version-selector__badge--old{% endif %}">
    {{ current_version.label }}
  </span>
  {% endif %}
</div>

{# Version switch handler - uses pre-computed target URL for instant navigation #}
<script>
  function handleVersionChange(option) {
    // Target URL is pre-computed at build time - instant navigation, no 404s
    window.location.href = option.dataset.target;
  }
</script>

{# Styles for version selector - can be overridden in theme CSS #}
<style>
  .version-selector {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .version-selector__label {
    display: flex;
    align-items: center;
    color: var(--text-muted, #6b7280);
  }

  .version-selector__icon {
    width: 1rem;
    height: 1rem;
  }

  .version-selector__select {
    appearance: none;
    background: var(--surface-secondary, #f3f4f6);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 0.375rem;
    padding: 0.375rem 2rem 0.375rem 0.75rem;
    font-size: inherit;
    font-family: inherit;
    color: inherit;
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M3 5l3 3 3-3'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
  }

  .version-selector__select:hover {
    border-color: var(--primary-color, #6366f1);
  }

  .version-selector__select:focus {
    outline: 2px solid var(--primary-color, #6366f1);
    outline-offset: 2px;
  }

  .version-selector__badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 9999px;
    background: var(--success-bg, #d1fae5);
    color: var(--success-text, #065f46);
  }

  .version-selector__badge--old {
    background: var(--warning-bg, #fef3c7);
    color: var(--warning-text, #92400e);
  }

  .version-deprecated {
    color: var(--text-muted, #6b7280);
    font-style: italic;
  }

  /* Hide select arrow in Firefox */
  .version-selector__select:-moz-focusring {
    color: transparent;
    text-shadow: 0 0 0 var(--text-color, #111827);
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .version-selector__select {
      background-color: var(--surface-secondary, #374151);
      border-color: var(--border-color, #4b5563);
      color: var(--text-color, #f9fafb);
    }

    .version-selector__badge {
      background: var(--success-bg, #064e3b);
      color: var(--success-text, #a7f3d0);
    }

    .version-selector__badge--old {
      background: var(--warning-bg, #78350f);
      color: var(--warning-text, #fde68a);
    }
  }

  /* Visually hidden for accessibility */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
{% endif %}
