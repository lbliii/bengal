{#
================================================================================
Page Hero Component (Unified)
================================================================================

All hero variants as macros for optimal rendering performance.
Eliminates 5+ template includes per page by inlining all variants.

PERFORMANCE:
  This template uses macros instead of {% include %} for ~10% faster rendering.
  Same pattern as docs-nav.html macro refactor.
  See: plan/drafted/rfc-page-hero-template-flattening.md

VARIANTS:
  - editorial: Clean magazine layout (default for single pages)
  - magazine: Editorial with container/background styling
  - overview: Section index with page count
  - classic: Traditional action-bar + header (legacy)
  - api/element: Autodoc elements (modules, classes, commands)
  - section: Autodoc section indexes

USAGE:
  Standard (dispatcher auto-selects variant):
    {% include 'partials/page-hero.html' %}

  Direct macro call (explicit control):
    {% from 'partials/page-hero.html' import hero_editorial, hero_element %}
    {{ hero_editorial(page, params, theme) }}

BACKWARDS COMPATIBILITY:
  All existing {% include 'partials/page-hero.html' %} calls work unchanged.
  The dispatcher at the bottom routes to the appropriate macro.
================================================================================
#}

{% from 'partials/navigation-components.html' import breadcrumbs %}

{# =============================================================================
   HELPER MACROS (internal)
   ============================================================================= #}

{# Get page URL with fallback chain #}
{% def _get_page_url(page) -%}
{{ page._path or page.href or '/' }}
{% end %}

{# =============================================================================
   SHARE DROPDOWN MACRO (internal)

   Renders the LLM share button with popover menu.
   PATTERN: POPOVER - browser handles show/hide, light dismiss, escape key
   ============================================================================= #}
{% def _share_dropdown(page) %}
{% set page_url = canonical_url(_get_page_url(page)) %}
{% set llm_txt_url = ensure_trailing_slash(page_url) ~ 'index.txt' %}
{% set share_prompt = "Please help me understand this documentation: " + llm_txt_url %}

<div class="page-hero__actions">
  <div class="page-hero__share">
    <button class="page-hero__share-trigger" popovertarget="page-hero-share-menu"
      aria-label="{{ t('share.ai_assistants', default='Share with AI assistants') }}"
      title="{{ t('share.ai_assistants', default='Share with AI assistants') }}">
      <span>á—¢</span>
      {{ icon('caret-down', size=14, css_class='page-hero__share-chevron') }}
    </button>

    <div id="page-hero-share-menu" popover class="page-hero__share-dropdown--popover">
      <div class="page-hero__share-content">
        {# Quick Actions #}
        <button class="page-hero__share-item" data-action="copy-url" data-url="{{ page_url }}" type="button">
          {{ icon('link', size=16) }}
          <span>{{ t('share.copy_url', default='Copy URL') }}</span>
        </button>

        <a href="{{ llm_txt_url }}" target="_blank" rel="noopener noreferrer" class="page-hero__share-item">
          {{ icon('external', size=16) }}
          <span>{{ t('share.open_llm_text', default='Open LLM text') }}</span>
        </a>

        <button class="page-hero__share-item" data-action="copy-llm-txt" data-url="{{ llm_txt_url }}" type="button">
          {{ icon('copy', size=16) }}
          <span>{{ t('share.copy_llm_text', default='Copy LLM text') }}</span>
        </button>

        <hr class="page-hero__share-separator">

        {# AI Assistant Links #}
        <div class="page-hero__share-section-header">{{ t('share.with_ai', default='Share with AI') }}</div>

        <a href="https://claude.ai/new?q={{ share_prompt | urlencode }}" target="_blank" rel="noopener noreferrer"
          class="page-hero__share-item page-hero__share-ai" data-ai="claude">
          {{ icon('ai-claude', size=16) }}
          <span>{{ t('share.ask_claude', default='Ask Claude') }}</span>
        </a>

        <a href="https://chatgpt.com/?q={{ share_prompt | urlencode }}" target="_blank" rel="noopener noreferrer"
          class="page-hero__share-item page-hero__share-ai" data-ai="chatgpt">
          {{ icon('ai-chatgpt', size=16) }}
          <span>{{ t('share.ask_chatgpt', default='Ask ChatGPT') }}</span>
        </a>

        <a href="https://gemini.google.com/app?q={{ share_prompt | urlencode }}" target="_blank" rel="noopener noreferrer"
          class="page-hero__share-item page-hero__share-ai" data-ai="gemini">
          {{ icon('ai-gemini', size=16) }}
          <span>{{ t('share.ask_gemini', default='Ask Gemini') }}</span>
        </a>

        <a href="https://copilot.microsoft.com/?q={{ share_prompt | urlencode }}" target="_blank" rel="noopener noreferrer"
          class="page-hero__share-item page-hero__share-ai" data-ai="copilot">
          {{ icon('ai-copilot', size=16) }}
          <span>{{ t('share.ask_copilot', default='Ask Copilot') }}</span>
        </a>
      </div>
    </div>
  </div>
</div>
{% end %}

{# =============================================================================
   BREADCRUMB EYEBROW MACRO (internal)

   Renders breadcrumbs as eyebrow, excluding current page (it's the H1)
   ============================================================================= #}
{% def _breadcrumb_eyebrow(page) %}
{% set breadcrumb_items = get_breadcrumbs(page) %}
{% if breadcrumb_items and breadcrumb_items | length > 1 %}
<nav class="page-hero__eyebrow" aria-label="Breadcrumb">
  <ol class="page-hero__breadcrumbs">
    {# Skip the last item (current page) - it's the H1 #}
    {% for item in breadcrumb_items[:-1] %}
    <li>
      <a href="{{ item.href | absolute_url }}" class="page-hero__breadcrumb-link">{{ item.title }}</a>
    </li>
    {% end %}
  </ol>
</nav>
{% end %}
{% enddef %}

{# =============================================================================
   ELEMENT BADGES MACRO (internal)

   Renders badges for DocElements (modules, classes, functions, commands)
   ============================================================================= #}
{% def _element_badges(element) %}
{% if element %}
<div class="page-hero__badges">
{% if element.element_type == 'module' %}
<span class="autodoc-badge" data-badge="module">Module</span>
{% if element.metadata.is_dataclass %}
<span class="autodoc-badge" data-badge="dataclass">dataclass</span>
{% end %}
{% elif element.element_type == 'class' %}
{% if element.metadata.is_mixin %}
<span class="autodoc-badge" data-badge="mixin">Mixin</span>
{% end %}
{% if element.metadata.is_dataclass %}
<span class="autodoc-badge" data-badge="dataclass">dataclass</span>
{% end %}
{% if element.metadata.is_abstract %}
<span class="autodoc-badge" data-badge="abstract">abstract</span>
{% end %}
{% elif element.element_type == 'function' %}
{% if element.metadata.is_async %}
<span class="autodoc-badge" data-badge="async">async</span>
{% end %}
{% elif element.element_type == 'method' %}
{% if element.metadata.is_async %}
<span class="autodoc-badge" data-badge="async">async</span>
{% end %}
{% if element.metadata.is_classmethod %}
<span class="autodoc-badge" data-badge="classmethod">classmethod</span>
{% end %}
{% if element.metadata.is_staticmethod %}
<span class="autodoc-badge" data-badge="staticmethod">staticmethod</span>
{% end %}
{% if element.metadata.is_property %}
<span class="autodoc-badge" data-badge="property">property</span>
{% end %}
{% elif element.element_type == 'command' %}
<span class="autodoc-badge" data-badge="command">Command</span>
{% elif element.element_type == 'command-group' %}
<span class="autodoc-badge" data-badge="command-group">Command Group</span>
{% end %}
</div>
{% end %}
{% enddef %}

{# =============================================================================
   ELEMENT STATS MACRO (internal)

   Renders stats (counts of children by type) for a DocElement.
   Uses the get_element_stats filter.
   ============================================================================= #}
{% def _element_stats(element) %}
{% set stats = element | get_element_stats %}
{% if stats %}
<div class="page-hero__stats">
  {% for stat in stats %}
  <span class="page-hero__stat">
    <span class="page-hero__stat-value">{{ stat.value }}</span>
    <span class="page-hero__stat-label">{{ stat.label }}</span>
  </span>
  {% end %}
</div>
{% end %}
{% enddef %}

{# =============================================================================
   VARIANT MACROS (public API)
   ============================================================================= #}

{# -----------------------------------------------------------------------------
   EDITORIAL VARIANT

   Clean magazine-style layout without container styling.
   Default for single documentation pages.
   ----------------------------------------------------------------------------- #}
{% def hero_editorial(page, params, theme) %}
{% if page %}
<div class="page-hero page-hero--editorial">
  {# Top row: Breadcrumbs (left) + Actions (right) #}
  <div class="page-hero__top">
    {{ _breadcrumb_eyebrow(page) }}
    {{ _share_dropdown(page) }}
  </div>

  {# Title #}
  <h1 class="page-hero__title">{{ page.title }}</h1>

  {# Description #}
  {% if params.description %}
  <p class="page-hero__description">{{ params.description }}</p>
  {% end %}

  {# Inline Metadata #}
  {% set has_metadata = page.content or page.date or params.lastmod %}
  {% if has_metadata %}
  <div class="page-hero__meta">
    {% if page.content and theme and 'content.reading_time' in theme.features %}
    <span class="page-hero__meta-item">
      {{ icon("clock", size=16) }}
      <span>{{ t('meta.reading_time', {'time': page.content | reading_time}, default='{time} min read') }}</span>
    </span>
    {% end %}

    {% if page.content %}
    <span class="page-hero__meta-item">
      {{ icon("file-text", size=16) }}
      <span>{{ t('meta.word_count', {'count': page.content | wordcount}, default='{count} words') }}</span>
    </span>
    {% end %}

    {% if params.lastmod or page.date %}
    <span class="page-hero__meta-item">
      {{ icon("arrow-clockwise", size=16) }}
      <span>{{ (params.lastmod or page.date) | time_ago }}</span>
    </span>
    {% end %}
  </div>
  {% end %}
</div>
{% end %}
{% enddef %}

{# -----------------------------------------------------------------------------
   MAGAZINE VARIANT

   Editorial-style with container/background styling.
   ----------------------------------------------------------------------------- #}
{% def hero_magazine(page, params, theme) %}
{% if page %}
<div class="page-hero page-hero--magazine">
  {# Top row: Breadcrumbs (left) + Actions (right) #}
  <div class="page-hero__top">
    {{ _breadcrumb_eyebrow(page) }}
    {{ _share_dropdown(page) }}
  </div>

  {# Title #}
  <h1 class="page-hero__title">{{ page.title }}</h1>

  {# Description #}
  {% if params.description %}
  <p class="page-hero__description">{{ params.description }}</p>
  {% end %}

  {# Inline Metadata #}
  {% set has_metadata = page.content or page.date or params.lastmod %}
  {% if has_metadata %}
  <div class="page-hero__meta">
    {% if page.content and theme and 'content.reading_time' in theme.features %}
    <span class="page-hero__meta-item">
      {{ icon("clock", size=16) }}
      <span>{{ page.content | reading_time }} min read</span>
    </span>
    {% end %}

    {% if page.content %}
    <span class="page-hero__meta-item">
      {{ icon("file-text", size=16) }}
      <span>{{ page.content | wordcount }} words</span>
    </span>
    {% end %}

    {% if params.lastmod or page.date %}
    <span class="page-hero__meta-item">
      {{ icon("arrow-clockwise", size=16) }}
      <span>{{ (params.lastmod or page.date) | time_ago }}</span>
    </span>
    {% end %}
  </div>
  {% end %}
</div>
{% end %}
{% enddef %}

{# -----------------------------------------------------------------------------
   OVERVIEW VARIANT

   For section index pages - wayfinding focused with page count.
   ----------------------------------------------------------------------------- #}
{% def hero_overview(page, params, posts, subsections) %}
{% if page %}
<div class="page-hero page-hero--overview">
  {# Top row: Breadcrumbs (left) + Actions (right) #}
  <div class="page-hero__top">
    {{ _breadcrumb_eyebrow(page) }}
    {{ _share_dropdown(page) }}
  </div>

  {# Title #}
  <h1 class="page-hero__title">{{ page.title }}</h1>

  {# Description #}
  {% if params.description %}
  <p class="page-hero__description">{{ params.description }}</p>
  {% end %}

  {# Section Stats - page count instead of read time #}
  {% set page_count = posts | length if posts else 0 %}
  {% set subsection_count = subsections | length if subsections else 0 %}
  {% set total_count = page_count + subsection_count %}
  {% if total_count > 0 %}
  <div class="page-hero__meta page-hero__meta--section">
    <span class="page-hero__meta-item page-hero__meta-item--section">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      <span>{{ total_count }} {{ 'page' if total_count == 1 else 'pages' }} in this section</span>
    </span>
  </div>
  {% end %}
</div>
{% end %}
{% enddef %}

{# -----------------------------------------------------------------------------
   CLASSIC VARIANT

   Traditional layout with separate action bar and page header.
   Legacy layout for backwards compatibility.
   ----------------------------------------------------------------------------- #}
{% def hero_classic(page, params) %}
{# Action Bar: Breadcrumbs + Share #}
{% include 'partials/action-bar.html' %}

{# Page Header #}
<header class="page-header page-header--classic">
    <h1>{{ page.title }}</h1>

    {% if params.description %}
    <p class="lead">{{ params.description }}</p>
    {% end %}
</header>
{% enddef %}

{# -----------------------------------------------------------------------------
   ELEMENT VARIANT (API)

   For DocElement pages: modules, classes, functions, commands.
   Includes badges, code-style title, source link, and stats.
   ----------------------------------------------------------------------------- #}
{% def hero_element(element, page, config) %}
<div class="page-hero page-hero--api">
  {# Top row: Breadcrumbs (left) + Actions (right) #}
  <div class="page-hero__top">
    {{ _breadcrumb_eyebrow(page) }}
    {{ _share_dropdown(page) }}
  </div>

  {# Badges #}
  {{ _element_badges(element) }}

  {# Title - qualified name for elements #}
  <h1 class="page-hero__title page-hero__title--code">
    <code>{{ element.qualified_name }}</code>
  </h1>

  {# Description from element #}
  {% if element.description %}
  <div class="page-hero__description page-hero__description--prose">
    {{ element.description | markdownify | safe }}
  </div>
  {% end %}

  {# Footer: Source link + stats #}
  <div class="page-hero__footer">
    {# Source link (for elements with source files) #}
    {% if element.display_source_file or element.source_file %}
    {% if config %}
    <a href="{{ config.github_repo }}/blob/{{ config.github_branch | default('main') }}/{{ element.display_source_file or element.source_file }}{% if element.line_number %}#L{{ element.line_number }}{% end %}"
      class="page-hero__source-link" target="_blank" rel="noopener">
      {{ icon('file-code', size=14) }}
      <span>View source</span>
    </a>
    {% end %}
    {% end %}

    {# Stats #}
    {{ _element_stats(element) }}
  </div>
</div>
{% enddef %}

{# -----------------------------------------------------------------------------
   SECTION VARIANT (API)

   For section-index pages: API packages, CLI groups.
   Shows subsection and page counts.
   ----------------------------------------------------------------------------- #}
{% def hero_section(section, page, hero_context) %}
{# Determine section type from explicit context, page type, or URL (fallback) #}
{% set is_cli = false %}
{% if hero_context and hero_context.is_cli %}
  {% set is_cli = hero_context.is_cli %}
{% elif page.type == 'autodoc-cli' %}
  {% set is_cli = true %}
{% elif page.href and '/cli' in page.href %}
  {% set is_cli = true %}
{% end %}

<div class="page-hero page-hero--api">
  {# Top row: Breadcrumbs (left) + Actions (right) #}
  <div class="page-hero__top">
    {{ _breadcrumb_eyebrow(page) }}
    {{ _share_dropdown(page) }}
  </div>

  {# Title - section title (with None check) #}
  {% if section and section.title %}
  <h1 class="page-hero__title">{{ section.title }}</h1>
  {% elif page and page.title %}
  <h1 class="page-hero__title">{{ page.title }}</h1>
  {% end %}

  {# Description from section metadata #}
  {% if section %}
  {% set desc = section.metadata.description %}
  {% if desc %}
  <div class="page-hero__description page-hero__description--prose">
    {{ desc | markdownify | safe }}
  </div>
  {% end %}
  {% end %}

  {# Footer: Stats from section children #}
  {% if section %}
  <div class="page-hero__footer">
    {% set section_subsections = section.sorted_subsections | default([]) | list %}
    {% set section_pages = section.sorted_pages | default([]) | rejectattr('source_path', 'match', '.*_index.*') | list %}

    {% if section_subsections | length > 0 or section_pages | length > 0 %}
    <div class="page-hero__stats">
      {% if section_subsections | length > 0 %}
      <span class="page-hero__stat">
        <span class="page-hero__stat-value">{{ section_subsections | length }}</span>
        {% if is_cli %}
        <span class="page-hero__stat-label">{{ 'Group' if section_subsections | length == 1 else 'Groups' }}</span>
        {% else %}
        <span class="page-hero__stat-label">{{ 'Package' if section_subsections | length == 1 else 'Packages' }}</span>
        {% end %}
      </span>
      {% end %}
      {% if section_pages | length > 0 %}
      <span class="page-hero__stat">
        <span class="page-hero__stat-value">{{ section_pages | length }}</span>
        {% if is_cli %}
        <span class="page-hero__stat-label">{{ 'Command' if section_pages | length == 1 else 'Commands' }}</span>
        {% else %}
        <span class="page-hero__stat-label">{{ 'Module' if section_pages | length == 1 else 'Modules' }}</span>
        {% end %}
      </span>
      {% end %}
    </div>
    {% end %}
  </div>
  {% end %}
</div>
{% enddef %}

{# =============================================================================
   DISPATCHER (backwards-compatible include interface)

   Routes to appropriate macro based on hero_style configuration.
   This runs when template is included via {% include 'partials/page-hero.html' %}
   ============================================================================= #}

{# Determine hero style: page variant > frontmatter > template default > theme config #}
{% set _page_variant = page.variant if page else none %}
{% set _page_hero_style = params.hero_style if params else none %}
{% set _template_default = _list_hero_default if _list_hero_default is defined else none %}
{% set _theme_hero_style = theme.config.hero_style | default('editorial') if theme else 'editorial' %}

{% set hero_style = _page_variant if _page_variant else (_page_hero_style if _page_hero_style else (_template_default if _template_default else _theme_hero_style)) %}

{# Route to appropriate macro #}
{% if hero_style == 'magazine' %}
{{ hero_magazine(page, params, theme) }}
{% elif hero_style == 'classic' %}
{{ hero_classic(page, params) }}
{% elif hero_style == 'overview' %}
{{ hero_overview(page, params, posts, subsections) }}
{% elif hero_style == 'api' %}
  {# API style routes to element or section based on available context #}
  {% if element %}
  {{ hero_element(element, page, config) }}
  {% elif section %}
  {{ hero_section(section, page, hero_context) }}
  {% else %}
  {# Fallback: no element/section context, use editorial #}
  {{ hero_editorial(page, params, theme) }}
  {% end %}
{% else %}
{# Default to editorial #}
{{ hero_editorial(page, params, theme) }}
{% end %}
