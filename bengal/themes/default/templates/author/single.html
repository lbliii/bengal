{% extends "base.html" %}

{#
================================================================================
Author Single Page Template (Kida-Native)
================================================================================

Displays an individual author's profile with bio, stats, and all their posts.

KIDA FEATURES USED:
- {% let %} for template-scoped variables
- Optional chaining (?.) for null-safe access
- Null coalescing (??) for smart defaults
- Pipeline operator (|>) for filter chains
- {% def %} for reusable card component

URL Pattern: /authors/lbliii/

Context variables:
- page: Current author page
- params.author_name: The author key to look up
- site.indexes.author: Author index
- site.data.authors: Author registry (if data/authors.yaml exists)
================================================================================
#}

{% from 'partials/navigation-components.html' import breadcrumbs %}
{% from 'partials/components/tags.html' import tag_list %}

{# =============================================================================
POST CARD COMPONENT
============================================================================= #}
{% def post_card(post) %}
{% let post_title = post?.title ?? 'Untitled' %}
{% let post_href = post?.href ?? '#' %}
{% let post_date = post?.date %}
{% let post_desc = post?.params?.description ?? '' %}
{% let post_section = post?._section %}

{% let post_tags = post?.tags ?? [] %}

{% let read_time = post?.reading_time ?? 0 %}

<article class="author-post-card">
  <div class="post-card-content">
    <h3 class="post-title">
      <a href="{{ post_href }}">{{ post_title }}</a>
    </h3>

    {% if post_desc %}
    <p class="post-excerpt">{{ post_desc }}</p>
    {% end %}

    <div class="post-meta">
      {% if post_date %}
      <time datetime="{{ post_date | date_iso }}">
        {{ post_date | dateformat('%B %d, %Y') }}
      </time>
      {% end %}

      {% if post_section %}
      <span class="post-section">{{ post_section.name | title }}</span>
      {% end %}

      {% if read_time > 0 %}
      <span class="reading-time">{{ read_time }} min read</span>
      {% end %}
    </div>

    {% if post_tags | length > 0 %}
    <div class="post-tags">
      {{ tag_list(post_tags[:4]) }}
    </div>
    {% end %}
  </div>
</article>
{% end %}

{# =============================================================================
MAIN TEMPLATE
============================================================================= #}

{% block content %}
{# Template-scoped variables #}
{% let author_key = params?.author_name ?? page?.title ?? '' %}
{% let authors_data = site?.data?.authors ?? {} %}
{% let author_data = authors_data[author_key] if author_key in authors_data else {} %}
{% let author_index = site?.indexes?.author ?? {} %}
{% let section_filter = params?.section_filter ?? '' %}

{# Merge author data from registry and page params #}
{% let author_name = author_data?.name ?? page?.title ?? 'Unknown Author' %}
{% let author_bio = author_data?.bio ?? params?.bio ?? '' %}
{% let author_avatar = author_data?.avatar ?? params?.avatar ?? '' %}
{% let author_company = author_data?.company ?? '' %}
{% let author_location = author_data?.location ?? '' %}

{# Build social links #}
{% let author_social = author_data?.social ?? params?.social ?? {} %}
{% let author_github = author_data?.github ?? author_social?.github ?? '' %}

{# Merge social links from data file links array #}
{% if author_data?.links %}
{% for link in author_data.links %}
{% let link_url = link?.href ?? link?.url ?? '' %}
{% if 'github' in link_url and not author_github %}
{% let author_github = link_url | replace('https://github.com/', '') %}
{% end %}
{% end %}
{% end %}

{# Get author posts with O(1) lookup #}
{% let author_posts_refs = author_index[author_key] ?? [] %}
{% let author_posts = author_posts_refs | resolve_pages %}

{# Filter by section if specified #}
{% if section_filter %}
{% let author_posts = author_posts |> selectattr('_section.name', 'eq', section_filter) |> list %}
{% end %}

{# Calculate stats #}
{% let post_count = author_posts | length %}
{% let all_content = author_posts |> map(attribute='content') |> join('') %}
{% let total_words = all_content | wordcount if all_content else 0 %}
{% let all_tags = author_posts |> map(attribute='tags') |> flatten |> unique |> list %}
{% let years = author_posts |> map(attribute='date.year') |> select('defined') |> unique |> sort %}

{{ breadcrumbs(page) }}

<div class="author-page">
  <header class="author-header">
    {% if author_avatar %}
    <img src="{{ author_avatar }}" alt="{{ author_name }}" class="author-avatar-large">
    {% else %}
    <div class="author-avatar-placeholder">
      {{ author_name[0] | upper }}
    </div>
    {% end %}

    <div class="author-header-content">
      <h1 class="author-name">{{ author_name }}</h1>

      {% if author_company or author_location %}
      <p class="author-meta">
        {% if author_company %}{{ author_company }}{% end %}
        {% if author_company and author_location %} ¬∑ {% end %}
        {% if author_location %}{{ author_location }}{% end %}
      </p>
      {% end %}

      {% if author_bio %}
      <p class="author-bio">{{ author_bio }}</p>
      {% end %}

      {# Social links #}
      {% if author_social | length > 0 or author_github %}
      <div class="author-social">
        {% if author_social?.twitter %}
        {% let twitter_handle = author_social.twitter | replace('@', '') %}
        <a href="https://twitter.com/{{ twitter_handle }}" class="social-link" aria-label="Twitter">
          üê¶ Twitter
        </a>
        {% end %}

        {% if author_github %}
        <a href="https://github.com/{{ author_github }}" class="social-link" aria-label="GitHub">
          üíª GitHub
        </a>
        {% end %}

        {% if author_social?.linkedin %}
        <a href="https://linkedin.com/in/{{ author_social.linkedin }}" class="social-link" aria-label="LinkedIn">
          üíº LinkedIn
        </a>
        {% end %}

        {% if author_social?.website %}
        <a href="{{ author_social.website }}" class="social-link" aria-label="Website">
          üåê Website
        </a>
        {% end %}

        {% if author_social?.email %}
        <a href="mailto:{{ author_social.email }}" class="social-link" aria-label="Email">
          ‚úâÔ∏è Email
        </a>
        {% end %}
      </div>
      {% end %}
    </div>
  </header>

  {% if post_count > 0 %}
  {# Statistics Section #}
  <section class="author-stats">
    <h2 class="sr-only">Author Statistics</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value">{{ post_count }}</span>
        <span class="stat-label">Post{{ 's' if post_count != 1 else '' }}</span>
      </div>

      <div class="stat-card">
        <span class="stat-value">{{ total_words | format_number }}</span>
        <span class="stat-label">Words</span>
      </div>

      <div class="stat-card">
        <span class="stat-value">{{ all_tags | length }}</span>
        <span class="stat-label">Topic{{ 's' if all_tags | length != 1 else '' }}</span>
      </div>

      {% if years | length > 0 %}
      <div class="stat-card">
        <span class="stat-value">{{ years | first }}</span>
        <span class="stat-label">Member Since</span>
      </div>
      {% end %}
    </div>
  </section>

  {# Main content from markdown #}
  {% if content %}
  <div class="author-content prose">
    {{ content | safe }}
  </div>
  {% end %}

  {# Posts Section #}
  <section class="author-posts">
    <h2>Posts by {{ author_name }}</h2>

    {# Group toggle #}
    <div class="posts-view-toggle">
      <button class="view-btn active" data-view="all">All Posts</button>
      <button class="view-btn" data-view="by-year">By Year</button>
      {% if all_tags | length > 0 %}
      <button class="view-btn" data-view="by-tag">By Topic</button>
      {% end %}
    </div>

    {# All Posts View (default) #}
    <div class="posts-view" data-view-content="all">
      <div class="post-list">
        {% for post in author_posts | sort(attribute='date', reverse=true) %}
        {{ post_card(post) }}
        {% end %}
      </div>
    </div>

    {# By Year View #}
    <div class="posts-view" data-view-content="by-year" style="display: none;">
      {% let posts_by_year = author_posts | group_by('date.year') %}
      {% for year, year_posts in posts_by_year | items | sort(reverse=true) %}
      <div class="year-group">
        <h3>{{ year if year else 'Undated' }} ({{ year_posts | length }})</h3>
        <ul class="post-list-compact">
          {% for post in year_posts | sort(attribute='date', reverse=true) %}
          <li>
            <a href="{{ post?.href ?? '#' }}">{{ post?.title ?? 'Untitled' }}</a>
            {% if post?.date %}
            <time>{{ post.date | dateformat('%b %d') }}</time>
            {% end %}
          </li>
          {% end %}
        </ul>
      </div>
      {% end %}
    </div>

    {# By Topic View #}
    {% if all_tags | length > 0 %}
    <div class="posts-view" data-view-content="by-tag" style="display: none;">
      {% for tag in all_tags | sort %}
      {% let tag_posts = [] %}
      {% for post in author_posts %}
      {% let post_tags = post?.tags ?? [] %}
      {% if tag in post_tags %}
      {% do tag_posts.append(post) %}
      {% end %}
      {% end %}
      <div class="tag-group">
        <h3>{{ tag }} ({{ tag_posts | length }})</h3>
        <ul class="post-list-compact">
          {% for post in tag_posts | sort(attribute='date', reverse=true) %}
          <li>
            <a href="{{ post?.href ?? '#' }}">{{ post?.title ?? 'Untitled' }}</a>
            {% if post?.date %}
            <time>{{ post.date | dateformat('%b %d, %Y') }}</time>
            {% end %}
          </li>
          {% end %}
        </ul>
      </div>
      {% end %}
    </div>
    {% end %}
  </section>

  {% else %}
  {# Empty State #}
  <div class="author-empty">
    <p>No posts found by {{ author_name }}.</p>
  </div>
  {% end %}
</div>

<script>
  // Simple view toggle
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('[data-view-content]').forEach(v => {
        v.style.display = v.dataset.viewContent === view ? 'block' : 'none';
      });
    });
  });
</script>
{% end %}
