{% extends "base.html" %}

{#
API Reference Module Template

Renders a Python module's API documentation using the unified autodoc skeleton.
Extends base.html to inherit theme navigation, sidebars, and styling.
Uses autodoc.css for all styling.

This template receives:
- element: DocElement for the module
- config: Autodoc configuration
- site: Site instance
#}

{% from 'partials/navigation-components.html' import breadcrumbs, page_navigation, toc with context %}

{% block content %}
{# Pre-compute element children - use getattr for safe access #}
{% set element_children = getattr(element, 'children', []) %}
{% set classes = element_children | selectattr('element_type', 'eq', 'class') | list %}
{% set functions = element_children | selectattr('element_type', 'eq', 'function') | list %}

{# Three-column documentation layout #}
<div class="docs-layout">
  {# Left Sidebar: Navigation #}
  <aside class="docs-sidebar" id="docs-sidebar" role="navigation" aria-label="API navigation">
    {% include 'partials/docs-nav.html' %}
  </aside>

  {# Main Content #}
  <div class="docs-main">
    {# Page Hero: Breadcrumbs + Badges + Title + Description + Stats #}
    {% include 'partials/page-hero/element.html' %}

    {# Article Content - New autodoc skeleton #}
    <article data-autodoc data-type="python" data-element="module" class="autodoc docs-content">

      {# Classes Section - Expandable rows #}
      {% if classes %}
      <section class="autodoc-section" data-section="classes">
        <h2 class="autodoc-section-title">Classes</h2>
        {% for cls in classes %}
        {% set cls_methods = (cls.children or []) | selectattr('element_type', 'eq', 'method') | list %}
        {% set cls_attrs = cls.metadata.attributes | default([]) %}
        <details class="autodoc-member" data-member="class" {% if loop.first %}open{% endif %}>
          <summary class="autodoc-member-header">
            <code class="autodoc-member-name">{{ cls.name }}</code>
            {% if cls.metadata.signature %}
            <span class="autodoc-member-sig">{{ cls.metadata.signature }}</span>
            {% endif %}
            <span class="autodoc-member-badges">
              {% if cls.metadata.is_dataclass %}
              <span class="autodoc-badge" data-badge="dataclass">dataclass</span>
              {% endif %}
              {% if cls.metadata.is_abstract %}
              <span class="autodoc-badge" data-badge="abstract">abstract</span>
              {% endif %}
              {% if cls_methods %}<span class="autodoc-badge">{{ cls_methods | length }} method{{ 's' if cls_methods | length != 1 }}</span>{% endif %}
              {% if cls_attrs %}<span class="autodoc-badge">{{ cls_attrs | length }} attr{{ 's' if cls_attrs | length != 1 }}</span>{% endif %}
            </span>
          </summary>
          <div class="autodoc-member-body">
            {% if cls.description %}
            <div class="autodoc-member-desc">
              <p>{{ cls.description }}</p>
            </div>
            {% endif %}

            {# Class attributes #}
            {% if cls_attrs %}
            <div class="autodoc-section" data-section="attributes">
              <h4 class="autodoc-label">Attributes</h4>
              <table class="autodoc-table" data-table="attributes">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  {% for attr in cls_attrs %}
                  <tr>
                    <td class="autodoc-cell-name"><code>{{ attr.name | default(attr.get('name', '')) }}</code></td>
                    <td class="autodoc-cell-type"><code>{{ attr.type | default(attr.get('type', '')) }}</code></td>
                    <td class="autodoc-cell-desc">{{ attr.description | default(attr.get('description', '')) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}

            {# Class methods as nested expandable items #}
            {% if cls_methods %}
            <div class="autodoc-section" data-section="methods">
              <h4 class="autodoc-label">Methods</h4>
              {% set members = cls_methods %}
              {% set title = '' %}
              {% set member_type = 'method' %}
              {% set first_open = false %}
              {% include 'autodoc/partials/members.html' %}
            </div>
            {% endif %}
          </div>
        </details>
        {% endfor %}
      </section>
      {% endif %}

      {# Functions Section - Expandable rows #}
      {% if functions %}
      <section class="autodoc-section" data-section="functions">
        <h2 class="autodoc-section-title">Functions</h2>
        {% for func in functions %}
        {% set func_params = func.metadata.parameters | default([]) %}
        {% set func_return = func.metadata.return_type | default(func.metadata.returns | default('')) %}
        <details class="autodoc-member" data-member="function" {% if loop.first %}open{% endif %}>
          <summary class="autodoc-member-header">
            <code class="autodoc-member-name">{{ func.name }}</code>
            {% if func.metadata.signature %}
            <span class="autodoc-member-sig">{{ func.metadata.signature }}</span>
            {% elif func_return %}
            <span class="autodoc-member-sig">() â†’ {{ func_return }}</span>
            {% endif %}
            <span class="autodoc-member-badges">
              {% if func.metadata.is_async %}
              <span class="autodoc-badge" data-badge="async">async</span>
              {% endif %}
              {% if func_params %}<span class="autodoc-badge">{{ func_params | length }} param{{ 's' if func_params | length != 1 }}</span>{% endif %}
            </span>
          </summary>
          <div class="autodoc-member-body">
            {% if func.description %}
            <div class="autodoc-member-desc">
              <p>{{ func.description }}</p>
            </div>
            {% endif %}

            {# Function parameters #}
            {% if func_params %}
            <dl class="autodoc-params">
              {% for param in func_params %}
              {% set param_name = param.name if param.name is defined else param.get('name', '') %}
              {% set param_type = param.type if param.type is defined else param.get('type', '') %}
              {% set param_desc = param.description if param.description is defined else param.get('description', '') %}
              {% set param_default = param.default if param.default is defined else param.get('default', none) %}
              <div class="autodoc-param" {% if param.required | default(false) %}data-required="true"{% endif %}>
                <dt class="autodoc-param-name">
                  <code>{{ param_name }}</code>
                  {% if param_type %}
                  <span class="autodoc-param-type">{{ param_type }}</span>
                  {% endif %}
                </dt>
                <dd class="autodoc-param-desc">
                  {{ param_desc }}
                  {% if param_default is not none %}
                  <span class="autodoc-param-default">Default: <code>{{ param_default }}</code></span>
                  {% endif %}
                </dd>
              </div>
              {% endfor %}
            </dl>
            {% endif %}

            {# Return type #}
            {% if func_return %}
            <div class="autodoc-returns">
              <code class="autodoc-returns-type">{{ func_return }}</code>
              {% if func.metadata.return_description %}
              <span class="autodoc-returns-desc">{{ func.metadata.return_description }}</span>
              {% endif %}
            </div>
            {% endif %}

            {# Raises #}
            {% if func.metadata.raises %}
            <dl class="autodoc-raises">
              {% for exc in func.metadata.raises %}
              <div class="autodoc-raise">
                <dt><code>{{ exc.type | default(exc.get('type', '')) }}</code></dt>
                <dd>{{ exc.description | default(exc.get('description', '')) }}</dd>
              </div>
              {% endfor %}
            </dl>
            {% endif %}
          </div>
        </details>
        {% endfor %}
      </section>
      {% endif %}

      {# Tags #}
      {% if page.tags %}
      <footer class="docs-footer">
        <span class="docs-footer-label">Tagged</span>
        {% from 'partials/content-components.html' import tag_list with context %}
        {{ tag_list(page.tags) }}
      </footer>
      {% endif %}
    </article>

    {# Page navigation (prev/next) at bottom #}
    {{ page_navigation(page) }}
  </div>

  {# Right Sidebar: Contextual Graph + TOC + Metadata #}
  {% include 'partials/docs-toc-sidebar.html' %}
</div>

{# Mobile sidebar toggle button #}
<button class="docs-sidebar-toggle" aria-label="Toggle navigation sidebar" aria-expanded="false"
  aria-controls="docs-sidebar">
  {{ icon('list', size=20) }}
</button>

{# Sidebar overlay for mobile #}
<div class="docs-sidebar-overlay" aria-hidden="true"></div>
{% endblock %}
