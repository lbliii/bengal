<!DOCTYPE html>
<html lang="{{ current_lang() }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    {# Title #}
    <title>{% block title %}{{ (page.title if page is defined and page and page.title is defined else site.config.title)
        }}{% if page is defined and page and page.title is defined %} - {{ site.config.title }}{% endif %}{% endblock %}
    </title>

    {# Meta description - automatically pre-computed by renderer (page.meta_description cached_property) #}
    {% set meta_desc = meta_desc | default(site.config.get('description'), '') %}

    {# Meta Description - Auto-generate if not provided #}
    <meta name="description" content="{{ meta_desc }}">

    {# Meta Keywords - use page.keywords or fallback to tags #}
    {% if page is defined and page and page.keywords is defined and page.keywords %}
    <meta name="keywords" content="{{ page.keywords | join(', ') }}">
    {% elif page is defined and page and page.tags is defined and page.tags %}
    <meta name="keywords" content="{{ page.tags | meta_keywords(10) }}">
    {% endif %}

    {# Open Graph / Facebook #}
    <meta property="og:type" content="{% if page is defined and page %}article{% else %}website{% endif %}">
    <meta property="og:title"
        content="{{ (page.title if page is defined and page and page.title is defined else site.config.title) }}">
    {% if meta_desc %}
    <meta property="og:description" content="{{ meta_desc }}">
    {% endif %}
    {% if site.config.baseurl %}
    {# Use relative_url for canonical URLs (canonical_url adds baseurl) #}
    <meta property="og:url"
        content="{{ canonical_url((page.relative_url if page is defined and page and page.relative_url is defined else '/')) }}">
    {% endif %}
    {# Open Graph Image #}
    {% if page is defined and page and page.metadata is defined and page.metadata.get('image') %}
    <meta property="og:image" content="{{ og_image(page.metadata.get('image')) }}">
    {% elif site.config.get('og_image') %}
    <meta property="og:image" content="{{ og_image(site.config.get('og_image')) }}">
    {% endif %}

    {# Twitter Card #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title"
        content="{{ (page.title if page is defined and page and page.title is defined else site.config.title) }}">
    {% if meta_desc %}
    <meta name="twitter:description" content="{{ meta_desc }}">
    {% endif %}
    {% if page is defined and page and page.metadata is defined and page.metadata.get('image') %}
    <meta name="twitter:image" content="{{ og_image(page.metadata.get('image')) }}">
    {% elif site.config.get('og_image') %}
    <meta name="twitter:image" content="{{ og_image(site.config.get('og_image')) }}">
    {% endif %}

    {# Bengal config meta for JS to read without template tags inside scripts #}
    <meta name="bengal:search_preload" content="{{ site.config.get('search_preload', 'smart') }}">
    <meta name="bengal:baseurl" content="{{ site.config.baseurl or '' }}">
    <meta name="bengal:index_url" content="{{ '/index.json' | absolute_url }}">

    {# Canonical URL #}
    {% if site.config.baseurl %}
    {# Use relative_url for canonical URLs (canonical_url adds baseurl) #}
    <link rel="canonical"
        href="{{ canonical_url((page.relative_url if page is defined and page and page.relative_url is defined else '/')) }}">
    {% endif %}

    {# RSS Feed (locale-aware when i18n prefix strategy is enabled) #}
    {% set _lang = current_lang() %}
    {% set _i18n = site.config.get('i18n', {}) %}
    {% set _rss_href = '/rss.xml' %}
    {% if _i18n and _i18n.get('strategy') == 'prefix' %}
    {% set _default_lang = _i18n.get('default_language', 'en') %}
    {% set _default_in_subdir = _i18n.get('default_in_subdir', False) %}
    {% if _lang and (_default_in_subdir or _lang != _default_lang) %}
    {% set _rss_href = '/' ~ _lang ~ '/rss.xml' %}
    {% endif %}
    {% endif %}
    <link rel="alternate" type="application/rss+xml" title="{{ site.config.title }} RSS Feed" href="{{ _rss_href }}">

    {# hreflang alternates for translated pages #}
    {% for alt in alternate_links(page) %}
    <link rel="alternate" hreflang="{{ alt.hreflang }}" href="{{ alt.href }}">
    {% endfor %}

    {# Favicon #}
    {% set favicon_path = site.config.get('site', {}).get('favicon') %}
    {% if favicon_path %}
    <link rel="icon" type="image/png" href="{{ favicon_path }}">
    {% else %}
    <link rel="icon" type="image/x-icon" href="{{ asset_url('favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset_url('favicon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset_url('favicon-32x32.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ asset_url('apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ asset_url('site.webmanifest') }}">
    {% endif %}

    {# Fonts - Load before stylesheets for proper font rendering #}
    {% if site.config.get('fonts') %}
    <link rel="stylesheet" href="{{ asset_url('fonts.css') }}">
    {% endif %}

    {# Stylesheets #}
    <link rel="stylesheet" href="{{ asset_url('css/style.css') }}">

    {# Theme configuration defaults from bengal.toml #}
    <script>
        window.BENGAL_THEME_DEFAULTS = {
            appearance: '{{ site.theme_config.default_appearance }}',
            palette: '{{ site.theme_config.default_palette }}'
        };
    </script>

    {# Theme & Palette initialization (prevent flash) #}
    <script src="{{ asset_url('js/theme-init.js') }}"></script>

    {% block extra_head %}{% endblock %}
    {# Generator and build meta #}
    {% include 'partials/meta-generator.html' %}

    {# Optional JSON bootstrap for client-side scripts #}
    {% if config.get('expose_metadata_json') %}
    <script id="bengal-bootstrap" type="application/json">{{ bengal | jsonify }}</script>
    <script>
        (function () {
            var el = document.getElementById('bengal-bootstrap');
            if (el) { window.__BENGAL__ = JSON.parse(el.textContent || '{}'); }
        })();
    </script>
    {% endif %}
</head>

<body
    class="page-kind-{{ page.kind if (page is defined and page and page.kind is defined) else 'page' }} {% if (page is defined and page and page.draft is defined and page.draft) %}draft-page{% endif %} {% if (page is defined and page and page.tags is defined and (page | has_tag('featured'))) %}featured-content{% endif %}">
    {# Skip to main content for accessibility #}
    <a href="#main-content" class="skip-link">Skip to main content</a>

    {# Header #}
    <header role="banner">
        <nav role="navigation" aria-label="Main navigation">
            <div class="container">
                {# Logo / Site Title #}
                <a href="{{ '/' | absolute_url }}" class="logo">
                    {% set _logo_image = site.config.get('logo_image') or site.config.get('site', {}).get('logo_image')
                    %}
                    {% set _logo_text = site.config.get('logo_text') or site.config.get('site', {}).get('logo_text') %}
                    {% if _logo_image %}
                    <img src="{{ _logo_image | absolute_url }}" alt="{{ site.config.title }}" class="brand-image" />
                    {% elif _logo_text %}
                    <span class="brand-text">{{ _logo_text }}</span>
                    {% else %}
                    <span class="brand-text">{{ site.config.title }}</span>
                    {% endif %}
                </a>

                {# Desktop Navigation #}
                <div class="nav-main hidden-mobile">
                    {# Try manual menu config first, fallback to auto-discovery #}
                    {% set main_menu = get_menu_lang('main', current_lang()) %}
                    {# Only use auto_nav if main_menu is empty (not just falsy) #}
                    {% set auto_nav = [] %}
                    {% if main_menu | length == 0 %}
                    {% set auto_nav = get_auto_nav() %}
                    {% endif %}

                    {% if main_menu or auto_nav %}
                    <ul>
                        {# Manual menu items (if configured) #}
                        {% if main_menu %}
                        {% for item in main_menu %}
                        <li
                            class="{{ 'active' if item.active else '' }} {{ 'active-trail' if item.active_trail else '' }}">
                            <a href="{{ item.url | absolute_url }}">{{ item.name }}</a>
                            {% if item.children %}
                            <ul class="submenu">
                                {% for child in item.children %}
                                <li class="{{ 'active' if child.active else '' }}">
                                    <a href="{{ child.url | absolute_url }}">{{ child.name }}</a>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                        {% endif %}

                        {# Auto-discovered nav items (if no manual config) #}
                        {% if auto_nav %}
                        {# Always show Home first in auto mode #}
                        <li class="{{ 'active' if (page is defined and page and page.relative_url == '/') else '' }}">
                            <a href="{{ '/' | absolute_url }}">Home</a>
                        </li>
                        {% for item in auto_nav %}
                        <li
                            class="{{ 'active' if (page is defined and page and page.relative_url and page.relative_url.startswith(item.relative_url) and item.relative_url != '/') else '' }}">
                            <a href="{{ item.url | absolute_url }}">{{ item.name }}</a>
                        </li>
                        {% endfor %}
                        {% endif %}

                        {# Search link #}
                        <li>
                            <a href="{{ '/search/' | absolute_url }}" title="Search (‚åòK)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <span>Search</span>
                            </a>
                        </li>
                        {# GitHub link - only show if not bundled in Dev dropdown #}
                        {% set github_bundled = false %}
                        {% if site._dev_menu_metadata is defined %}
                        {% set github_bundled = site._dev_menu_metadata.get("github_bundled", false) %}
                        {% endif %}
                        {% if site.config.params and site.config.params.repo_url and not github_bundled %}
                        <li>
                            <a href="{{ site.config.params.repo_url }}" target="_blank" rel="noopener"
                                title="GitHub Repository" data-external="true" aria-label="GitHub (opens in new tab)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                </svg>
                                <span>GitHub</span>
                            </a>
                        </li>
                        {% endif %}
                        {% block nav_items %}{% endblock %}
                    </ul>
                    {% endif %}

                </div>

                {# Theme Controls - Desktop Only #}
                <div class="theme-controls-desktop hidden-mobile">
                    {% include 'partials/theme-controls.html' %}
                </div>

                {# Mobile Menu Toggle #}
                <button class="mobile-nav-toggle visible-mobile" aria-label="Open menu" aria-expanded="false">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    {# Mobile Navigation #}
    <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
        <div class="mobile-nav-header">
            <span class="logo">
                {% set _logo_image = site.config.get('logo_image') or site.config.get('site', {}).get('logo_image') %}
                {% set _logo_text = site.config.get('logo_text') or site.config.get('site', {}).get('logo_text') %}
                {% if _logo_image %}
                <img src="{{ _logo_image | absolute_url }}" alt="{{ site.config.title }}" class="brand-image" />
                {% elif _logo_text %}
                <span class="brand-text">{{ _logo_text }}</span>
                {% else %}
                <span class="brand-text">{{ site.config.title }}</span>
                {% endif %}
            </span>
            <button class="mobile-nav-close" aria-label="Close menu">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        {# Try manual menu config first, fallback to auto-discovery #}
        {% set main_menu = get_menu_lang('main', current_lang()) %}
        {# Only use auto_nav if main_menu is empty (not just falsy) #}
        {% set auto_nav = [] %}
        {% if main_menu | length == 0 %}
        {% set auto_nav = get_auto_nav() %}
        {% endif %}

        {% if main_menu or auto_nav %}
        <ul>
            {# Manual menu items (if configured) #}
            {% if main_menu %}
            {% for item in main_menu %}
            <li class="{{ 'has-submenu' if item.children else '' }} {{ 'active' if item.active else '' }}">
                <a href="{{ item.url | absolute_url }}">{{ item.name }}</a>
                {% if item.children %}
                <ul class="submenu">
                    {% for child in item.children %}
                    <li class="{{ 'active' if child.active else '' }}">
                        <a href="{{ child.url | absolute_url }}">{{ child.name }}</a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
            {% endif %}

            {# Auto-discovered nav items (if no manual config) #}
            {% if auto_nav %}
            {# Always show Home first in auto mode #}
            <li class="{{ 'active' if (page is defined and page and page.relative_url == '/') else '' }}">
                <a href="{{ '/' | absolute_url }}">Home</a>
            </li>
            {% for item in auto_nav %}
            <li
                class="{{ 'active' if (page is defined and page and page.relative_url and page.relative_url.startswith(item.relative_url) and item.relative_url != '/') else '' }}">
                <a href="{{ item.url | absolute_url }}">{{ item.name }}</a>
            </li>
            {% endfor %}
            {% endif %}

            {# GitHub link - only show if not bundled in Dev dropdown #}
            {% set github_bundled = false %}
            {% if site._dev_menu_metadata is defined %}
            {% set github_bundled = site._dev_menu_metadata.get("github_bundled", false) %}
            {% endif %}
            {% if site.config.params and site.config.params.repo_url and not github_bundled %}
            <li>
                <a href="{{ site.config.params.repo_url }}" target="_blank" rel="noopener">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
                        style="margin-right: 8px; vertical-align: text-bottom;">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                    GitHub
                </a>
            </li>
            {% endif %}

            {% block mobile_nav_items %}{% endblock %}
        </ul>
        {% endif %}

        {# Theme Controls - Mobile Only #}
        <div class="mobile-nav-footer">
            {% include 'partials/theme-controls.html' %}
        </div>
    </nav>

    {# Main Content #}
    <main id="main-content" role="main">
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

    {# Footer #}
    <footer role="contentinfo">
        <div class="container">
            {# Popular Tags Widget removed to avoid duplicate tags on section index pages #}

            <div class="footer-bottom">
                <div class="footer-left">
                    <p class="footer-copyright">
                        &copy; {{ site.build_time | dateformat('%Y') }} {{ site.config.title }}
                    </p>
                    {% set footer_menu = get_menu_lang('footer', current_lang()) %}
                    {% if footer_menu %}
                    <ul class="footer-links">
                        {% for item in footer_menu %}
                        <li><a href="{{ item.url | absolute_url }}">{{ item.name }}</a></li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                <div class="footer-right">
                    <a href="https://github.com/lbliii/bengal" rel="noopener" class="bengal-badge"
                        aria-label="Built with Bengal" data-tooltip="Built with Bengal" title="Built with Bengal">
                        <span class="cat cat-contemplative">
                            <span class="cat-tail">·ìö</span><span class="cat-body">·òè</span><span
                                class="cat-head">·ó¢</span>
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    {# JavaScript - Utils must load first #}
    <script src="{{ asset_url('js/utils.js') }}"></script>
    <script src="{{ asset_url('js/theme-toggle.js') }}"></script>
    <script src="{{ asset_url('js/mobile-nav.js') }}"></script>
    <script src="{{ asset_url('js/tabs.js') }}"></script>
    <script src="{{ asset_url('js/toc.js') }}"></script>
    <script src="{{ asset_url('js/action-bar.js') }}"></script>
    <script src="{{ asset_url('js/main.js') }}"></script>
    <script src="{{ asset_url('js/interactive.js') }}"></script>
    <script src="{{ asset_url('js/copy-link.js') }}"></script>
    <script src="{{ asset_url('js/lightbox.js') }}"></script>

    {# Tabulator for data tables #}
    <script src="{{ asset_url('js/tabulator.min.js') }}"></script>
    <script src="{{ asset_url('js/data-table.js') }}"></script>

    {# Lunr.js for search (local copy avoids CDN integrity issues) #}
    <script src="{{ asset_url('js/lunr.min.js') }}"></script>
    <script src="{{ asset_url('js/search.js') }}"></script>
    <script src="{{ asset_url('js/search-page.js') }}"></script>

    {# Mermaid.js for diagram rendering #}
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    {# Mermaid toolbar for interactive diagram controls #}
    <script src="{{ asset_url('js/mermaid-toolbar.js') }}"></script>
    {# Mermaid theme configuration - maps Bengal CSS variables to Mermaid themeVariables #}
    <script src="{{ asset_url('js/mermaid-theme.js') }}"></script>

    {# Session path tracker - tracks user's navigation path for graph visualization #}
    <script src="{{ asset_url('js/session-path-tracker.js') }}"></script>

    {# Graph visualizations - conditional loading (only when containers exist) #}
    <script>
        (function () {
            'use strict';
            // Wait for DOM to be ready before checking for containers
            function checkAndLoadGraphScripts() {
                const graphContainers = document.querySelector('.graph-minimap, .graph-contextual');
                if (!graphContainers) return;

                // Check if D3.js is already loaded
                if (typeof d3 !== 'undefined') {
                    // D3 already loaded, just load components
                    loadGraphComponents();
                    return;
                }

                // Load D3.js first
                const d3Script = document.createElement('script');
                d3Script.src = 'https://d3js.org/d3.v7.min.js';
                d3Script.async = true;
                d3Script.onload = function () {
                    // Load graph components after D3 is ready
                    loadGraphComponents();
                };
                document.head.appendChild(d3Script);
            }

            function loadGraphComponents() {
                const components = [
                    '{{ asset_url("js/graph-minimap.js") }}',
                    '{{ asset_url("js/graph-contextual.js") }}'
                ];
                components.forEach(function (src) {
                    // Check if script already loaded
                    if (document.querySelector('script[src="' + src + '"]')) return;

                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    document.head.appendChild(script);
                });
            }

            // Check when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkAndLoadGraphScripts);
            } else {
                // DOM already ready
                checkAndLoadGraphScripts();
            }
        })();
    </script>

    {# Smart search index preloading #}
    <script>
        (function () {
            const preloadMode = (document.querySelector('meta[name="bengal:search_preload"]').content) || 'smart';
            let preloadTriggered = false;

            function preloadSearch() {
                if (preloadTriggered || !window.BengalSearch) return;
                preloadTriggered = true;

                console.log('üîç Preloading search index...');
                window.BengalSearch.load();
            }

            // Immediate: Load right away (best for small sites <100 pages)
            if (preloadMode === 'immediate') {
                document.addEventListener('DOMContentLoaded', preloadSearch);
            }
            // Smart: Load on user intent signals (default, best for most sites)
            else if (preloadMode === 'smart') {
                document.addEventListener('DOMContentLoaded', function () {
                    // Preload on search link hover (user likely to search)
                    const searchLinks = document.querySelectorAll('a[href$="/search/"], a[href*="search"]');
                    searchLinks.forEach(link => {
                        link.addEventListener('mouseenter', preloadSearch, { once: true });
                        link.addEventListener('focus', preloadSearch, { once: true });
                    });

                    // Preload if user presses Cmd/Ctrl (likely ‚åòK)
                    document.addEventListener('keydown', function (e) {
                        if (e.metaKey || e.ctrlKey) {
                            preloadSearch();
                        }
                    }, { once: true });
                });
            }
            // Lazy: Only load when search is actually opened (best for large sites >500 pages)
            // No preloading - index loads on first search
        })();
    </script>

    {% block extra_js %}{% endblock %}

    {# Back to Top Button - Static HTML for reliable SVG rendering #}
    <button class="back-to-top" aria-label="Scroll to top" title="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
    </button>

    {# Image Lightbox - Static HTML for reliable SVG rendering #}
    <div class="lightbox" role="dialog" aria-label="Image lightbox" aria-hidden="true">
        <img class="lightbox__image" alt="">
        <button class="lightbox__close" aria-label="Close lightbox">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="lightbox__caption"></div>
    </div>

    {# Dev-only live reload is now injected by the server automatically via LiveReloadMixin #}
</body>

</html>
