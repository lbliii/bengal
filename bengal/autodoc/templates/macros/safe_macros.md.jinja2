{#-
Safe Template Macros - Hugo-style error boundaries and safe rendering

These macros provide error isolation and graceful fallbacks for template rendering.
All templates should use these macros to prevent silent failures.
-#}

{#-
Hugo-style error boundary macro

CRITICAL: Whitespace control for clean markdown output
- Strips ALL leading/trailing whitespace from content
- Preserves internal blank lines (needed for markdown structure)
- Adds newline after content so root layout spacing works correctly
- Root layout controls spacing between major sections (blank lines between safe_section calls)
- Partials control spacing between their own internal elements (headings, rubrics, code blocks)
-#}
{% macro safe_section(section_name, show_errors=true) %}
{%- if caller -%}
{%- set content = caller() -%}
{%- if content and content.strip() -%}
{%- set prepared = content.lstrip() -%}
{{- prepared.rstrip() ~ '\n\n' }}
{%- endif -%}
{%- endif -%}
{% endmacro %}

{#- Safe rendering with item-level fallbacks -#}
{% macro safe_render(item_type, item, show_errors=true) %}
{%- if caller and item -%}
{%- set current_item = item -%}
{{- caller() -}}
{%- endif -%}
{% endmacro %}

{#- Safe variable access with defaults -#}
{% macro safe_var(obj, attr, default="-") %}
{%- if obj and attr in obj -%}
{{ obj[attr] }}
{%- else -%}
{{ default }}
{%- endif -%}
{% endmacro %}

{#- Safe attribute access for objects -#}
{% macro safe_attr(obj, attr, default="-") %}
{%- if obj and obj[attr] is defined -%}
{{ obj[attr] }}
{%- else -%}
{{ default }}
{%- endif -%}
{% endmacro %}

{#- Safe list access with bounds checking -#}
{% macro safe_list_item(list_obj, index, default="") %}
{%- if list_obj and list_obj|length > index -%}
{{ list_obj[index] }}
{%- else -%}
{{ default }}
{%- endif -%}
{% endmacro %}

{#- Conditional rendering with safe checks -#}
{% macro if_exists(obj, attr) %}
{% if caller and obj and hasattr(obj, attr) and obj[attr] %}
{{ caller() }}
{% endif %}
{% endmacro %}

{#- Safe iteration with empty state handling -#}
{% macro safe_for(items, empty_message="*No items found.*") %}
{% if items and items|length > 0 %}
{% if caller %}
{% for current_item in items %}
{{ caller(current_item) }}
{% endfor %}
{% endif %}
{% else %}
{{ empty_message }}
{% endif %}
{% endmacro %}

{#- Debug information macro (only shows in debug mode) -#}
{% macro debug_info(label, data) %}
{#- Debug output disabled in macros to avoid context issues -#}
{#- Use direct config access in templates instead -#}
{% endmacro %}

{#-
Spacing Shell Macros - Consistent spacing wrapper pattern

RECOMMENDED: Use shells for major structural elements only (sections, subsections, rubrics).
For simple content (descriptions, inline text), use manual spacing with consistent patterns.

Shells provide:
- Guaranteed spacing (blank lines before/after)
- Self-documenting component types
- Centralized spacing logic

Use shells for:
- section_shell: Major sections (## Classes, ## Functions)
- subsection_shell: Subsections (### `name`)  
- rubric_shell: Rubrics (:::{rubric})

Manual spacing for:
- Descriptions/text content (add blank line after if followed by component)
- Code blocks (add blank line before/after)
- Tables (already handled by parameter_table macro)

Example:
  {% call section_shell() %}
  ## Classes
  {% endcall %}
  
  {% call subsection_shell() %}
  ### `Community`
  {% endcall %}
  
  {{ element.description }}
  
  ```{info}
  This is a dataclass.
  ```
-#}

{#- Major section shell (## Classes, ## Functions) -#}
{% macro section_shell() %}
{%- if caller -%}
{%- set content = caller() -%}
{%- if content and content.strip() -%}
{%- set trimmed = content.strip() -%}
{{- '\n\n' ~ trimmed ~ '\n\n' }}
{%- endif -%}
{%- endif -%}
{% endmacro %}

{#- Subsection shell (### `name`) -#}
{% macro subsection_shell() %}
{%- if caller -%}
{%- set content = caller() -%}
{%- if content and content.strip() -%}
{%- set trimmed = content.strip() -%}
{{- '\n\n' ~ trimmed ~ '\n\n' }}
{%- endif -%}
{%- endif -%}
{% endmacro %}

{#- Rubric shell (:::{rubric}) -#}
{% macro rubric_shell() %}
{%- if caller -%}
{%- set content = caller() -%}
{%- if content and content.strip() -%}
{%- set trimmed = content.strip() -%}
{{- '\n\n' ~ trimmed ~ '\n\n' }}
{%- endif -%}
{%- endif -%}
{% endmacro %}
